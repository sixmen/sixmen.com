<!DOCTYPE html>
<html lang='ko'>

<head>
  <meta charset='utf-8'>

  
  <title>sixmen.com: Tech</title>
  
  
  <meta name='author' content='Sangmin Yoon'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>

  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'>
  <link href='/css/style.css?body=1' rel='stylesheet' type='text/css' media='all'>
  <link href='/css/syntax.css?body=1' rel='stylesheet' type='text/css' media='all'>

  <!--[if lt IE 9]>
  <script src='https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js'></script>
  <script src='https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js'></script>
  <![endif]-->
</head>

<body>
<div class='hp-navbar'>
  <div class='container-fluid'>
    <div class='row'>
      <div class='col-xs-12'>
        
        <nav class='hp-nav'>
          <a class='hp-nav-item'
            href='/ko/'>Home</a>
          <a class='hp-nav-item'
            href='/ko/mylife/'>MyLife</a>
          <a class='hp-nav-item'
            href='/ko/travel/'>Travel</a>
          <a class='hp-nav-item active'
            href='/ko/tech/'>Tech</a>
          <a class='hp-nav-item'
            href='/ko/tags/'>Tags</a>
          <a class='hp-nav-item pull-right' href='/en/'>English</a>
        </nav>
      </div>
    </div>
  </div>
</div>



<div class='container'>

  <div class='row' style='margin-top: 20px;'>

    <div class='col-sm-10 col-sm-offset-1'>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2020-02-15-1-configuration-in-typescript/'>TypeScript에서의 환경 설정 관리</a></h2>
          <p class='posts-date'>15 Feb 2020</p>
        </div>
        <div class='panel-body'>
          <p>응용프로그램을 작성하다 보면 여러 가지 환경 설정(configuration)이 필요합니다.
이번 글에서는 TypeScript에서 환경 설정을 관리하는 저희의 방법을 설명합니다.</p>
<p>프로젝트 초기에는 환경 설정을 코드 중간에 넣어서 개발하는 경우가 많을 것으로 생각합니다.
그러다가 규모가 커지면 여러 가지 이유로 코드에서 분리해서 관리할 필요성이 늘어납니다.
첫 번째는 보안 측면의 이슈입니다. 암호나 접근키(access key) 등을 코드에 넣는 것은 보통 좋은 방향이 아닙니다.
이런 값은 보통 환경 변수(environment variable)에 담아서 사용하는 경우가 많습니다.
프로세스 구동 시에 환경 변수를 설정해두는 것은 꽤 귀찮은 작업이기 때문에 <a href="https://github.com/motdotla/dotenv">dotenv</a> 같은 모듈을 사용하기도 합니다.
두 번째는 상황에 따라 다른 값을 적용해야 하는 경우입니다. 개발 중, 운영 환경, 자동화 테스트 등의 상황마다 다른 값이 필요한 경우가 많습니다.
이런 경우를 지원하는 것으로 <a href="https://github.com/lorenwest/node-config">config</a>라는 모듈이 있습니다.</p>
<p>크로키의 경우 첫 번째 이슈는 그렇게 크지 않았습니다.
운영 환경에 적절한 환경 변수를 설정하는 것도 꽤 번거롭기 때문에 AWS Instance Role이나 Parameter Store 같은 방법을 써서 회피하고 있습니다.
하지만 환경에 따라 설정이 달라지는 경우는 많았기 때문에 config 모듈은 사용하고 있었습니다.
config 모듈은 필요한 기능을 제공했지만, 오타 등의 이유로 개발 중에는 잘 동작하는데 운영 환경에서는 잘못된 설정이 적용되거나 하는 실수가 종종 발생했습니다.
그래서 저희가 사용하는 TypeScript 언어의 장점을 살려 설정도 타입 검사가 이루어졌으면 하는 바람이 생겼습니다.
<a href="https://github.com/tusharmath/node-config-ts">node-config-ts</a>라는 모듈이 있었지만, 원하는 형태와는 조금 거리가 있었습니다.</p>
<p>여러 가지를 고민하던 중에 외부 모듈 없이도 타입 안정성 있는 설정을 구현할 수 있다는 생각이 들었습니다.
저희는 처음부터 설정 파일을 JSON이 아닌 JavaScript로 관리하고 있었습니다. 이를 그대로 TypeScript로 전환하면 그 자체가 타입 정의가 될 것 같았습니다.
이렇게 만들어진 저희 설정 파일 형식은 다음과 같습니다.</p>
<p>우선 설정의 기본 구조는 config/default.ts에 정의합니다. 이후 다른 코드에서는 이 파일의 내용을 기반으로 타입 검사가 이루어집니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">Config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">test_mode</span>: <span class="kt">false</span><span class="p">,</span>
  <span class="nx">database</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;mydb.mydomain.com&#39;</span><span class="p">,</span>
    <span class="nx">port</span>: <span class="kt">3306</span><span class="p">,</span>
    <span class="nx">user</span><span class="o">:</span> <span class="s1">&#39;myuser&#39;</span><span class="p">,</span>
    <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;mypassword&#39;</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Config</span><span class="p">;</span></code></pre></div>
<p>다른 환경에 대한 설정은 다른 부분에 대해서만 정의하면 됩니다. 다음은 테스트 환경을 위한 config/test.ts 파일입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">Config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">test_mode</span>: <span class="kt">true</span><span class="p">,</span>
  <span class="nx">database</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="nx">port</span><span class="o">:</span> <span class="s1">&#39;5678&#39;</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Config</span><span class="p">;</span></code></pre></div>
<p>이제 이를 묶어서 다른 코드에 제공할 config/index.ts 파일을 정의합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="nx">_</span> <span class="kr">from</span> <span class="s1">&#39;lodash&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">BaseConfig</span> <span class="kr">from</span> <span class="s1">&#39;./default&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">Config</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">cloneDeep</span><span class="p">(</span><span class="nx">BaseConfig</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">EnvConfig</span> <span class="o">=</span> <span class="kr">require</span><span class="p">(</span><span class="sb">`./</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="k">default</span><span class="p">;</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">Config</span><span class="p">,</span> <span class="nx">EnvConfig</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Cannot find configs for env=</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="p">{</span> <span class="nx">Config</span> <span class="p">};</span></code></pre></div>
<p>이 설정 파일은 다음과 같이 사용하면 됩니다. 이 코드는 NODE_ENV에 따라 다른 결과를 출력합니다. 물론 타입 검사도 완벽히 동작합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Config</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;./config&#39;</span><span class="p">;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">Config</span><span class="p">.</span><span class="nx">database</span><span class="p">);</span></code></pre></div>
<p>다만 이대로는 부족한 점이 있습니다. test.ts 파일에서 오타(예 test_mode -&gt; testmode)나 타입 오류가 있어도 알려주지 않습니다.
이는 다음 방법으로 해결할 수 있습니다. default.ts에 다음 내용을 추가합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// from https://github.com/krzkaczor/ts-essentials
</span><span class="c1"></span><span class="kr">type</span> <span class="nx">DeepPartial</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">[</span><span class="nx">P</span> <span class="k">in</span> <span class="k">keyof</span> <span class="nx">T</span><span class="p">]</span><span class="o">?:</span> <span class="nx">T</span><span class="p">[</span><span class="nx">P</span><span class="p">]</span> <span class="kr">extends</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="nt">infer</span> <span class="na">U</span><span class="p">&gt;</span>
  <span class="o">?</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="nt">DeepPartial</span><span class="err">&lt;</span><span class="na">U</span><span class="p">&gt;</span><span class="o">&gt;</span>
  <span class="c1">// tslint:disable-next-line:no-shadowed-variable
</span><span class="c1"></span>  <span class="o">:</span> <span class="nx">T</span><span class="p">[</span><span class="nx">P</span><span class="p">]</span> <span class="kr">extends</span> <span class="nx">ReadonlyArray</span><span class="p">&lt;</span><span class="nt">infer</span> <span class="na">U</span><span class="p">&gt;</span>
  <span class="o">?</span> <span class="nx">ReadonlyArray</span><span class="p">&lt;</span><span class="nt">DeepPartial</span><span class="err">&lt;</span><span class="na">U</span><span class="p">&gt;</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="nx">DeepPartial</span><span class="p">&lt;</span><span class="nt">T</span><span class="err">[</span><span class="na">P</span><span class="err">]</span><span class="p">&gt;</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="kr">type</span> <span class="nx">BaseConfigType</span> <span class="o">=</span> <span class="nx">DeepPartial</span><span class="p">&lt;</span><span class="nt">typeof</span> <span class="na">Config</span><span class="p">&gt;;</span></code></pre></div>
<p>이제 test.ts를 다음과 같이 수정합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">BaseConfigType</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;./default&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">Config</span>: <span class="kt">BaseConfigType</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Config</span><span class="p">;</span></code></pre></div>
<p>처음 정의 시 port의 타입이 달랐는데(string vs number) 이제는 다음과 같은 컴파일 오류가 발생합니다.</p>
<pre><code>config/test.ts(5,3): error TS2322: Type '{ host: string; port: string; }' is not assignable to type 'DeepPartial&lt;{ host: string; port: number; user: string; password: string; }&gt;'.
  Types of property 'port' are incompatible.
    Type 'string' is not assignable to type 'number | undefined'.
</code></pre><p>저희는 이런 식으로 설정을 정의해서 잘 사용하고 있습니다. 다만 아쉬운 점이 아예 없지는 않습니다.
lodash의 merge를 사용하기 때문에 default 설정에서 정의한 값을 undefined로 덮어씌우지는 못합니다.
또 default 설정의 타입이 기준이 되기 때문에 환경마다 설정의 형태가 매우 다르다면 default에서 타입을 명시적으로 써줘야 할 수도 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// default
</span><span class="c1"></span><span class="kr">import</span> <span class="nx">Redis</span> <span class="kr">from</span> <span class="s1">&#39;ioredis&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">Config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">database</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;mypassword&#39;</span> <span class="kr">as</span> <span class="kt">string</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">cache</span><span class="o">:</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span> <span class="kr">as</span> <span class="nx">Redis</span><span class="p">.</span><span class="nx">RedisOptions</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// test
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">Config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">database</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">password</span>: <span class="kt">null</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">};</span></code></pre></div>
<p>제 생각에 JavaScript 생태계에서 TypeScript는 뺄 수 없는 부분이 된 것 같습니다.
이 글이 TypeScript를 사용하시는 데 도움이 되었으면 합니다.</p>

        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2020-02-11-1-croquis-stack-aws-batch/'>크로키의 스택 - AWS Batch</a></h2>
          <p class='posts-date'>11 Feb 2020</p>
        </div>
        <div class='panel-body'>
          <p>서비스를 운영하다 보면 주기적으로 실행이 필요한 작업이 생깁니다.
이런 작업을 실행하는 방법은 여러 가지가 있을 수 있습니다.
다음은 크로키에서 현재 선택해서 전환 중인 AWS Batch에 관해 설명합니다.</p>
<p>지그재그 서비스 초기에는 서버가 EC2 인스턴스 위에서 동작하고 있었습니다.
이때는 반복 작업은 작업 전용 EC2 인스턴스에서 실행하도록 구성했습니다.
그리고 그 일정은 리눅스 cron을 통해 관리했습니다.</p>
<p>이후 AWS Lambda로 서비스 서버를 옮기기로 하면서 새로운 방법이 필요해졌습니다.
그래서 CloudWatch Events에 람다에 연결해서 반복 작업을 실행했습니다.
다만 EC2와 달리 실행 시간에 제한이 있고, 동시 실행을 방지할 방법이 없었습니다.</p>
<p>현재는 서비스 서버를 ECS Fargate로 이전한 상황입니다.
여기에 맞는 반복 작업 실행 방법을 찾아야 하는데 처음에는 Scheduled Tasks를 고려했지만,
여러 이유로 진도가 나가지 않고 있었습니다.</p>
<p>더는 기존 시스템을 계속 둘 수는 없기에 빠르게 전환할 방법으로 AWS Batch를 선택하게 됐습니다.
나중에는 <a href="https://airflow.apache.org/">Apache Airflow</a>나 <a href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/">Kubernetes CronJob</a> 같은 더 기능이 풍부한 해결책이 필요해질 수도 있지만, 현재 상황에서는 충분히 만족스러운 해결책이었습니다.</p>
<p>다음은 저희 상황에서 AWS Batch를 적용했을 때의 장단점입니다.</p>
<ol>
<li>이미 실행할 프로그램이 Docker 이미지로 만들어져서 ECR에 올라가 있습니다. 명령(CMD)만 바꿔주면 서비스 프로세스 대신 작업이 수행됩니다.</li>
<li>실행 결과를 보기가 편했습니다. 기존 방식은 로그를 한꺼번에 보기가 어려웠는데 AWS Batch를 적용하면 작업만 모아서 볼 수 있어서 좋았습니다.</li>
<li>작업 실패 시 알림을 받기도 편했습니다.</li>
<li>ECS처럼 CPU 단위를 1/4 vCPU 단위로 지정할 수 있으면 좋은데 1 vCPU 단위라서 리소스가 실제 필요보다 많이 쓰는 단점이 있습니다.</li>
</ol>
<h1 id="aws-batch-환경-구축">AWS Batch 환경 구축</h1>
<p>저희는 현재 CloudFormation으로 인프라를 구성하고 있습니다. (CDK도 고려 중입니다.)</p>
<p>다음은 AWS Batch 인프라와 그 설명입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">Resources</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># 우선 AWS Batch가 동작할 환경(EC2)을 정의합니다.</span><span class="w">
</span><span class="w">  </span><span class="c"># 주어진 VPC의 Subnet 위에 상황에 맞는 적절한 인스턴스가 생성됩니다.</span><span class="w">
</span><span class="w">  </span><span class="c"># 관리형을 선택해 자동으로 인스턴스가 늘어나고 줄어듭니다.</span><span class="w">
</span><span class="w">  </span><span class="c"># 작업이 중단되는 것을 원하지 않아 스팟 인스턴스는 적용하지 않았습니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">BatchComputeEnvironment</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::Batch::ComputeEnvironment</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">ComputeResources</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">InstanceRole</span><span class="p">:</span><span class="w"> </span><span class="l">ecsInstanceRole</span><span class="w">
</span><span class="w">        </span><span class="nt">InstanceTypes</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="l">optimal</span><span class="w">
</span><span class="w">        </span><span class="nt">MaxvCpus</span><span class="p">:</span><span class="w"> </span><span class="m">16</span><span class="w">
</span><span class="w">        </span><span class="nt">MinvCpus</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">        </span><span class="nt">SecurityGroupIds</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- !<span class="l">ImportValue VpcSecurityGroupId</span><span class="w">
</span><span class="w">        </span><span class="nt">Subnets</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- !<span class="l">ImportValue SubnetId1</span><span class="w">
</span><span class="w">          </span>- !<span class="l">ImportValue SubnetId2</span><span class="w">
</span><span class="w">        </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">EC2</span><span class="w">
</span><span class="w">      </span><span class="nt">ServiceRole</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub arn:aws:iam::${AWS::AccountId}:role/AWSBatchServiceRole</span><span class="w">
</span><span class="w">      </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">MANAGED</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># 다음은 작업 대기열을 설정합니다.</span><span class="w">
</span><span class="w">  </span><span class="c"># 세부적으로 나눌 필요성을 못 느껴 대부분의 작업은 default 대기열에서 실행됩니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">BatchQueueDefault</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::Batch::JobQueue</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">ComputeEnvironmentOrder</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">ComputeEnvironment</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref BatchComputeEnvironment</span><span class="w">
</span><span class="w">          </span><span class="nt">Order</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">JobQueueName</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">      </span><span class="nt">Priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">      </span><span class="nt">State</span><span class="p">:</span><span class="w"> </span><span class="l">ENABLED</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># 10분 이하 간격으로 실행되는 작업이 있는데</span><span class="w">
</span><span class="w">  </span><span class="c"># default 대기열에 넣으면 화면에 작업 목록이 너무 길어져서 분리했습니다.</span><span class="w">
</span><span class="w">  </span><span class="c"># 우선순위도 조금 낮게 설정했습니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">BatchQueueContinuously</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::Batch::JobQueue</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">ComputeEnvironmentOrder</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">ComputeEnvironment</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref BatchComputeEnvironment</span><span class="w">
</span><span class="w">          </span><span class="nt">Order</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">JobQueueName</span><span class="p">:</span><span class="w"> </span><span class="l">continuously</span><span class="w">
</span><span class="w">      </span><span class="nt">Priority</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">      </span><span class="nt">State</span><span class="p">:</span><span class="w"> </span><span class="l">ENABLED</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># 작업을 실행할 수 있는 역할을 미리 생성해서 각 작업 정의 시 사용할 수 있도록 했습니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">EventsBatchSubmitJobRole</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::IAM::Role</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="ld">2012-10-17</span><span class="w">
</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">Service</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">events.amazonaws.com</span><span class="w">
</span><span class="w">            </span><span class="nt">Action</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="l">sts:AssumeRole</span><span class="w">
</span><span class="w">      </span><span class="nt">Policies</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="ld">2012-10-17</span><span class="w">
</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">batch:SubmitJob</span><span class="w">
</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="s1">&#39;*&#39;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># 작업 실패 시 실행할 람다 함수의 역할입니다.</span><span class="w">
</span><span class="w">  </span><span class="c"># 슬랙으로 메시지를 전송하는 SendToSlack이라는 함수를 호출할 수 있도록 권한을 부여했습니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">JobFailedAlertLambdaRole</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::IAM::Role</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="ld">2012-10-17</span><span class="w">
</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">Service</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">lambda.amazonaws.com</span><span class="w">
</span><span class="w">            </span><span class="nt">Action</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="l">sts:AssumeRole</span><span class="w">
</span><span class="w">      </span><span class="nt">Policies</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="ld">2012-10-17</span><span class="w">
</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">logs:CreateLogGroup</span><span class="w">
</span><span class="w">                  </span>- <span class="l">logs:CreateLogStream</span><span class="w">
</span><span class="w">                  </span>- <span class="l">logs:PutLogEvents</span><span class="w">
</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- !<span class="l">Sub arn:aws:logs:ap-northeast-2:${AWS::AccountId}:*</span><span class="w">
</span><span class="w">        </span>- <span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="l">send-to-slack</span><span class="w">
</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="ld">2012-10-17</span><span class="w">
</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">lambda:InvokeFunction</span><span class="w">
</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- !<span class="l">Sub arn:aws:lambda:ap-northeast-2:${AWS::AccountId}:function:SendToSlack</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># 작업 실패 시 실행되는 람다 함수입니다.</span><span class="w">
</span><span class="w">  </span><span class="c"># 실패 메시지를 분석해 적절한 에러 메시지를 슬랙으로 보내줍니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">JobFailedAlertLambda</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::Lambda::Function</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">Code</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ZipFile</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">          const AWS = require(&#39;aws-sdk&#39;);
</span><span class="sd">          const slackChannel = &#39;#cron-error&#39;;
</span><span class="sd">
</span><span class="sd">          const lambda = new AWS.Lambda({ region: &#39;ap-northeast-2&#39; });
</span><span class="sd">
</span><span class="sd">          async function processEvent(event) {
</span><span class="sd">            console.log(JSON.stringify(event));
</span><span class="sd">            const slackMessage = {
</span><span class="sd">              channel: slackChannel,
</span><span class="sd">              username: &#39;AWS Batch Job Failed Alert&#39;,
</span><span class="sd">              icon_emoji: &#39;:cloud:&#39;,
</span><span class="sd">            };
</span><span class="sd">
</span><span class="sd">            let color = &#39;danger&#39;;
</span><span class="sd">            slackMessage.attachments = [{
</span><span class="sd">              color: color,
</span><span class="sd">              text: `${event.detail.jobName} failed by ${event.detail.statusReason}`,
</span><span class="sd">            }];
</span><span class="sd">            await lambda.invoke({
</span><span class="sd">              FunctionName: &#39;SendToSlack&#39;,
</span><span class="sd">              Payload: JSON.stringify(slackMessage),
</span><span class="sd">            }).promise();
</span><span class="sd">          }
</span><span class="sd">
</span><span class="sd">          exports.handler = async (event, context, callback) =&gt; {
</span><span class="sd">            try {
</span><span class="sd">              const response = await processEvent(event);
</span><span class="sd">              callback(null, response);
</span><span class="sd">            } catch (error) {
</span><span class="sd">              callback(error);
</span><span class="sd">            }
</span><span class="sd">          };</span><span class="w">          
</span><span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l">index.handler</span><span class="w">
</span><span class="w">      </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span>!<span class="l">GetAtt JobFailedAlertLambdaRole.Arn</span><span class="w">
</span><span class="w">      </span><span class="nt">Runtime</span><span class="p">:</span><span class="w"> </span><span class="l">nodejs10.x</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># AWS Batch에서 작업 실패를 감지하면 람다 함수를 호출하도록 구성합니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">JobFailedEvent</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::Events::Rule</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">EventPattern</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">detail-type</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="l">Batch Job State Change</span><span class="w">
</span><span class="w">        </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="l">aws.batch</span><span class="w">
</span><span class="w">        </span><span class="nt">detail</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">status</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">FAILED</span><span class="w">
</span><span class="w">      </span><span class="nt">Targets</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">Arn</span><span class="p">:</span><span class="w"> </span>!<span class="l">GetAtt JobFailedAlertLambda.Arn</span><span class="w">
</span><span class="w">          </span><span class="nt">Id</span><span class="p">:</span><span class="w"> </span><span class="l">lambda</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># 작업 실패 이벤트가 람다 함수를 실행할 수 있도록 권한을 부여합니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">JobFailedEventPermission</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::Lambda::Permission</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="l">lambda:InvokeFunction</span><span class="w">
</span><span class="w">      </span><span class="nt">FunctionName</span><span class="p">:</span><span class="w"> </span>!<span class="l">GetAtt JobFailedAlertLambda.Arn</span><span class="w">
</span><span class="w">      </span><span class="nt">Principal</span><span class="p">:</span><span class="w"> </span><span class="l">events.amazonaws.com</span><span class="w">
</span><span class="w">      </span><span class="nt">SourceArn</span><span class="p">:</span><span class="w"> </span>!<span class="l">GetAtt JobFailedEvent.Arn</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 위에서 정의한 AWS Batch 리소스를 다른 CloudFormation에서 사용할 수 있도록 내보냅니다.</span><span class="w">
</span><span class="w"></span><span class="nt">Outputs</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">BatchQueueArnDefault</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref BatchQueueDefault</span><span class="w">
</span><span class="w">    </span><span class="nt">Export</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l">BatchQueueArnDefault</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">BatchQueueArnContinuously</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref BatchQueueContinuously</span><span class="w">
</span><span class="w">    </span><span class="nt">Export</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l">BatchQueueArnContinuously</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">EventsBatchSubmitJobRoleArn</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span>!<span class="l">GetAtt EventsBatchSubmitJobRole.Arn</span><span class="w">
</span><span class="w">    </span><span class="nt">Export</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l">EventsBatchSubmitJobRoleArn</span></code></pre></div>
<h1 id="aws-batch-작업-정의">AWS Batch 작업 정의</h1>
<p>다음은 위 환경 위에서 실제 동작할 작업에 대한 정의입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">Resources</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># 서비스 코드가 올라간 저장소입니다.</span><span class="w">
</span><span class="w">  </span><span class="c"># 서비스 구동용 ECS 작업(task) 정의에서도 같이 사용합니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">Repository</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::ECR::Repository</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">RepositoryName</span><span class="p">:</span><span class="w"> </span><span class="l">my-service</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># 작업을 위한 역할을 정의합니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">Role</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::IAM::Role</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="ld">2012-10-17</span><span class="w">
</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">Service</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">ecs-tasks.amazonaws.com</span><span class="w">
</span><span class="w">            </span><span class="nt">Action</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="l">sts:AssumeRole</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># 첫 번째 작업을 정의합니다.</span><span class="w">
</span><span class="w">  </span><span class="c"># 20분 정도 실행되는 작업으로 넉넉하게 30분의 시간제한을 뒀습니다.</span><span class="w">
</span><span class="w">  </span><span class="c"># 재시도는 하지 않습니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">DoSomethingJobDefinition</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::Batch::JobDefinition</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">ContainerProperties</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">Command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;app/jobs/do-something&#39;</span><span class="p">]</span><span class="w">
</span><span class="w">        </span><span class="nt">Image</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${AWS::AccountId}.dkr.ecr.ap-northeast-2.amazonaws.com/my-service:latest</span><span class="w">
</span><span class="w">        </span><span class="nt">JobRoleArn</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref Role</span><span class="w">
</span><span class="w">        </span><span class="nt">Memory</span><span class="p">:</span><span class="w"> </span><span class="m">1024</span><span class="w">
</span><span class="w">        </span><span class="nt">Vcpus</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">RetryStrategy</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">Attempts</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">Timeout</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">AttemptDurationSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1800</span><span class="w">
</span><span class="w">      </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">container</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># 매일 아침 9시 0분(UTC 기준 새벽 0시 0분) 작업 실행하도록 CloudWatch Events를 생성합니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">DoSomethingEvent</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::Events::Rule</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">ScheduleExpression</span><span class="p">:</span><span class="w"> </span><span class="l">cron(0 0 * * ? *)</span><span class="w">
</span><span class="w">      </span><span class="nt">Targets</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">Arn</span><span class="p">:</span><span class="w"> </span>!<span class="l">ImportValue BatchQueueArnDefault</span><span class="w">
</span><span class="w">          </span><span class="nt">Id</span><span class="p">:</span><span class="w"> </span><span class="l">task</span><span class="w">
</span><span class="w">          </span><span class="nt">BatchParameters</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">JobDefinition</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref DoSomethingJobDefinition</span><span class="w">
</span><span class="w">            </span><span class="nt">JobName</span><span class="p">:</span><span class="w"> </span><span class="l">my-service-do-something</span><span class="w">
</span><span class="w">          </span><span class="nt">RoleArn</span><span class="p">:</span><span class="w"> </span>!<span class="l">ImportValue EventsBatchSubmitJobRoleArn</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># 자주 실행하는 작업을 정의합니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">DoOftenJobDefinition</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::Batch::JobDefinition</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">ContainerProperties</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">Command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;app/jobs/do-often&#39;</span><span class="p">]</span><span class="w">
</span><span class="w">        </span><span class="nt">Image</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${AWS::AccountId}.dkr.ecr.ap-northeast-2.amazonaws.com/my-service:latest</span><span class="w">
</span><span class="w">        </span><span class="nt">JobRoleArn</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref Role</span><span class="w">
</span><span class="w">        </span><span class="nt">Memory</span><span class="p">:</span><span class="w"> </span><span class="m">1024</span><span class="w">
</span><span class="w">        </span><span class="nt">Vcpus</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">RetryStrategy</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">Attempts</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">Timeout</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">AttemptDurationSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">      </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">container</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># 10분마다 작업을 실행하도록 구성합니다.</span><span class="w">
</span><span class="w">  </span><span class="nt">DoOftenEvent</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::Events::Rule</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">ScheduleExpression</span><span class="p">:</span><span class="w"> </span><span class="l">cron(7/10 * * * ? *)</span><span class="w">
</span><span class="w">      </span><span class="nt">Targets</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">Arn</span><span class="p">:</span><span class="w"> </span>!<span class="l">ImportValue BatchQueueArnContinuously</span><span class="w">
</span><span class="w">          </span><span class="nt">Id</span><span class="p">:</span><span class="w"> </span><span class="l">task</span><span class="w">
</span><span class="w">          </span><span class="nt">BatchParameters</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">JobDefinition</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref DoOftenJobDefinition</span><span class="w">
</span><span class="w">            </span><span class="nt">JobName</span><span class="p">:</span><span class="w"> </span><span class="l">my-service-do-often</span><span class="w">
</span><span class="w">          </span><span class="nt">RoleArn</span><span class="p">:</span><span class="w"> </span>!<span class="l">ImportValue EventsBatchSubmitJobRoleArn</span></code></pre></div>
<h1 id="기타">기타</h1>
<p>짧게 실행되는 작업에 대해서 중복 실행을 막고 싶은 요구사항이 있습니다. 이는 다음과 같이 현재 구동 중인 작업을 검사하는 방식으로 해결했습니다.
(batch:ListJobs 권한이 필요합니다.)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="nx">AWS</span> <span class="kr">from</span> <span class="s1">&#39;aws-sdk&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">JobStatus</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;aws-sdk/clients/batch&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">job_name</span> <span class="o">=</span> <span class="s1">&#39;do-something&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">batch</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">Batch</span><span class="p">({</span> <span class="nx">region</span><span class="o">:</span> <span class="s1">&#39;ap-northeast-2&#39;</span> <span class="p">});</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">checkAlreadyRunStatus</span><span class="p">(</span><span class="nx">status</span>: <span class="kt">JobStatus</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">batch</span><span class="p">.</span><span class="nx">listJobs</span><span class="p">({</span>
    <span class="nx">jobQueue</span>: <span class="kt">process.env.AWS_BATCH_JQ_NAME</span><span class="p">,</span>
    <span class="nx">jobStatus</span>: <span class="kt">status</span><span class="p">,</span>
  <span class="p">}).</span><span class="nx">promise</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">jobSummaryList</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">((</span><span class="nx">item</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">jobName</span> <span class="o">===</span> <span class="nx">job_name</span> <span class="o">&amp;&amp;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">jobId</span> <span class="o">!==</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_BATCH_JOB_ID</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">found</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="sb">`already run </span><span class="si">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">jobSummaryList</span><span class="p">[</span><span class="nx">found</span><span class="p">].</span><span class="nx">jobId</span><span class="si">}</span><span class="sb"> / </span><span class="si">${</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">checkAlreadyRun() {</span>
  <span class="k">await</span> <span class="nx">checkAlreadyRunStatus</span><span class="p">(</span><span class="s1">&#39;SUBMITTED&#39;</span><span class="p">);</span>
  <span class="k">await</span> <span class="nx">checkAlreadyRunStatus</span><span class="p">(</span><span class="s1">&#39;PENDING&#39;</span><span class="p">);</span>
  <span class="k">await</span> <span class="nx">checkAlreadyRunStatus</span><span class="p">(</span><span class="s1">&#39;RUNNABLE&#39;</span><span class="p">);</span>
  <span class="k">await</span> <span class="nx">checkAlreadyRunStatus</span><span class="p">(</span><span class="s1">&#39;STARTING&#39;</span><span class="p">);</span>
  <span class="k">await</span> <span class="nx">checkAlreadyRunStatus</span><span class="p">(</span><span class="s1">&#39;RUNNING&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">run() {</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">checkAlreadyRun</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// 0으로 종료해야 실패로 처리되지 않습니다.
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="c1">// 실제 수행할 코드
</span><span class="c1"></span><span class="p">}</span>

<span class="nx">run</span><span class="p">();</span></code></pre></div>
<p>작업에 따라서는 여러 단계로 나뉘어 순차적으로 실행돼야 할 수 있습니다.
작업 정의로는 그런 세세한 제어는 어렵지만, 이전 작업 마지막에서 submitJob을 수동으로 호출해주면 될 것으로 생각하고 있습니다.</p>
<p>AWS Batch는 노드를 여러 개 띄워서 동시에 실행하는 기능도 제공하지만, 저희는 아직 사용하지 않고 있습니다.</p>
<h1 id="결론">결론</h1>
<p>AWS Batch는 기능이 많은 편은 아니지만, 간단하게 쓰기에는 충분했습니다.
물론 나중에 서비스 규모가 더 커지면 다른 도구를 도입할 가능성은 계속 열려있습니다.</p>

        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2019-05-22-1-croquis-stack-graphql/'>크로키의 스택 - GraphQL</a></h2>
          <p class='posts-date'>22 May 2019</p>
        </div>
        <div class='panel-body'>
          <p>현재 크로키는 API를 <a href="https://graphql.org/">GraphQL</a>로 만들고 있습니다.
아직 많은 부분에 대해서 연구 중이어서 현재 상황만 간단하게 정리해 보겠습니다.</p>
<p>Thrift를 1년 정도 쓴 시점부터 여러 가지 불편함을 느끼고 대안을 찾다가 GraphQL을 선택했습니다.
GraphQL 생태계가 Node.js를 중심으로 발전하고 있어서 크게 망설이지 않고 정할 수 있었던 것 같습니다.</p>
<p>외부에 영향을 주지 않는 기능 중 N+1 문제를 가지고 있는 기능을 하나 선택해 변환을 해봤습니다.
조금 생각은 해야 하지만 충분히 기존 API에 성능이 떨어지지 않고 사용은 더 편하게 할 수 있는 것을 확인하고 조금씩 확대해나갔습니다.</p>
<p>1년 이상 진행하면서 정리된 API 스펙은 <a href="https://github.com/croquiscom/style-guide/blob/master/API/GraphQL.md">스타일 가이드 저장소</a>에서 공개하고 있습니다.</p>
<h2 id="스키마-정의">스키마 정의</h2>
<p>처음에는 GraphQLObjectType을 써서 정의했습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">GraphQLInt</span><span class="p">,</span> <span class="nx">GraphQLNonNull</span><span class="p">,</span> <span class="nx">GraphQLObjectType</span><span class="p">,</span> <span class="nx">GraphQLString</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;graphql&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="kr">type</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GraphQLObjectType</span><span class="p">({</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Shop&#39;</span><span class="p">,</span>
  <span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">id</span><span class="o">:</span> <span class="p">{</span>
      <span class="kr">type</span><span class="o">:</span> <span class="k">new</span> <span class="nx">GraphQLNonNull</span><span class="p">(</span><span class="nx">GraphQLInt</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="nx">name</span><span class="o">:</span> <span class="p">{</span>
      <span class="kr">type</span><span class="o">:</span> <span class="k">new</span> <span class="nx">GraphQLNonNull</span><span class="p">(</span><span class="nx">GraphQLString</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="nx">url</span><span class="o">:</span> <span class="p">{</span>
      <span class="kr">type</span><span class="o">:</span> <span class="k">new</span> <span class="nx">GraphQLNonNull</span><span class="p">(</span><span class="nx">GraphQLString</span><span class="p">),</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">});</span></code></pre></div>
<p>그러다가 타입이 많아지면 보기가 힘들어서 스키마 문자열을 통해 정의하는 것으로 변경해 봤습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">makeExecutableSchema</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;graphql-tools&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">type Shop {
</span><span class="sb">  id: ID!
</span><span class="sb">  name: String!
</span><span class="sb">  url: String!
</span><span class="sb">}
</span><span class="sb">`</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">Query</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">shop</span>: <span class="kt">ShopService.shop</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">makeExecutableSchema</span><span class="p">({</span>
  <span class="nx">typeDefs</span><span class="o">:</span> <span class="p">[</span><span class="nx">typeDefs</span><span class="p">],</span>
  <span class="nx">resolvers</span><span class="o">:</span> <span class="p">[</span><span class="nx">resolvers</span><span class="p">],</span>
<span class="p">});</span></code></pre></div>
<p>현재는 resolver 구현에도 타입 체킹이 되고, DB 모델과 통일시키기 위해 <a href="https://typegraphql.ml/">type-graphql</a>을 적용했습니다.
다만 현재 <a href="https://github.com/19majkel94/type-graphql/issues/254">퍼포먼스 이슈</a> 때문에
<a href="https://github.com/croquiscom/type-graphql/tree/croquis-190305">수정한 버전</a>을 사용하고 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Field</span><span class="p">,</span> <span class="nx">ID</span><span class="p">,</span> <span class="nx">ObjectType</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;type-graphql&#39;</span><span class="p">;</span>

<span class="kd">@ObjectType</span><span class="p">()</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">Shop</span> <span class="p">{</span>
  <span class="kd">@Field</span><span class="p">((</span><span class="kr">type</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">ID</span><span class="p">,</span> <span class="p">{</span> <span class="nx">nullable</span>: <span class="kt">false</span> <span class="p">})</span>
  <span class="nx">id</span>: <span class="kt">string</span><span class="p">;</span>

  <span class="kd">@Field</span><span class="p">((</span><span class="kr">type</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">String</span><span class="p">,</span> <span class="p">{</span> <span class="nx">nullable</span>: <span class="kt">false</span> <span class="p">})</span>
  <span class="nx">name</span>: <span class="kt">string</span><span class="p">;</span>

  <span class="kd">@Field</span><span class="p">((</span><span class="kr">type</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">String</span><span class="p">,</span> <span class="p">{</span> <span class="nx">nullable</span>: <span class="kt">false</span> <span class="p">})</span>
  <span class="nx">url</span>: <span class="kt">string</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<h2 id="클라이언트-호출-코드">클라이언트 호출 코드</h2>
<p>클라어인트에서는 <a href="https://www.apollographql.com/">apollo 툴</a>을 사용해 코드를 생성해 호출하고 있습니다.</p>
<p><strong><em>안드로이드</em></strong>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">LoginInput</span> <span class="n">input</span> <span class="o">=</span> <span class="n">LoginInput</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">email</span><span class="o">(</span><span class="n">email</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="n">password</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="n">apolloClient</span><span class="o">.</span><span class="na">mutate</span><span class="o">(</span>
    <span class="n">LoginMutation</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">input</span><span class="o">(</span><span class="n">input</span><span class="o">).</span><span class="na">build</span><span class="o">()</span>
<span class="o">).</span><span class="na">enqueue</span><span class="o">(</span><span class="k">new</span> <span class="n">ApolloCall</span><span class="o">.</span><span class="na">Callback</span><span class="o">&lt;</span><span class="n">LoginMutation</span><span class="o">.</span><span class="na">Data</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">});</span></code></pre></div></p>
<p><strong><em>iOS</em></strong>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">let</span> <span class="nv">input</span> <span class="p">=</span> <span class="n">LoginInput</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span>
<span class="n">apolloClient</span><span class="p">.</span><span class="n">perform</span><span class="p">(</span><span class="n">mutation</span><span class="p">:</span> <span class="n">LoginMutation</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="n">input</span><span class="p">))</span> <span class="p">{</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="p">...</span>
<span class="p">}</span></code></pre></div></p>
<p><strong><em>웹</em></strong>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// api.ts (apollo-tooling 위에 자체 스크립트로 생성한 파일)
</span><span class="c1"></span><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">types</span> <span class="nx">from</span> <span class="s1">&#39;./types&#39;</span><span class="p">;</span>

<span class="kr">export</span> <span class="kr">async</span> <span class="kd">function</span> <span class="nx">login</span><span class="p">(</span><span class="nx">variable</span><span class="o">:</span> <span class="nx">types</span><span class="p">.</span><span class="nx">LoginVariables</span><span class="p">,</span> <span class="nx">options</span><span class="o">?:</span> <span class="nx">GqlRequestOptions</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="s1">&#39;mutation Login($input: LoginInput!) { login(input: $input) }&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="kr">await</span> <span class="nx">request</span><span class="o">&lt;</span><span class="nx">types</span><span class="p">.</span><span class="nx">Login</span><span class="p">,</span> <span class="nx">types</span><span class="p">.</span><span class="nx">LoginVariables</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">variable</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// LoginView.ts
</span><span class="c1"></span><span class="kr">async</span> <span class="nx">login</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">login</span><span class="p">({</span>
    <span class="nx">input</span><span class="o">:</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">},</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></div></p>
<h2 id="마무리하며">마무리하며</h2>
<p>전환을 시작한 이후로 많은 GraphQL API를 만들었지만, 기존 API는 손대지 못하고 거의 그대로 사용하고 있습니다.
그걸 보면서 진작에 GraphQL로 전환했으면 두 번 작업하는 일이 줄어들었을 터라는 생각이 듭니다.
하지만 초반에 적용했으면 아직 안정화되지 않은 생태계로 인해 고생했을 것 같습니다.</p>
<p>웹 기술을 TypeScript로, GraphQL로, React로 전환할 때마다, 이 방향이 맞는지, 이 시기가 적당한지 고민이 됩니다.
서비스를 이어가는 와중에 기술 부채를 털어낼 적절한 시기를 놓치지 않도록 계속 노력하고 있습니다.</p>
<p>차후에도 GraphQL을 사용하면서 의미가 있는 부분이 있으면 공개하도록 하겠습니다.</p>

        </div>
      </div>
      
    </div>

    
<div class='col-xs-12 text-center'>
  
  <ul class='pagination'>
    
    <li><a href='/ko/tech/'>&laquo; 처음</a></li>
    <li><a href='/ko/tech/'>&lt; 이전</a></li>
    

    

    
    
    
    
    <li><a href='/ko/tech/'>1</a></li>
    
    
    
    
    
    <li class='active'><span>2</span></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/3/'>3</a></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/4/'>4</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    <li class='disabled'><span>&hellip;</span></li>
    

    
    <li><a href='/ko/tech/page/3/'>다음 &gt;</a></li>
    <li><a href='/ko/tech/page/12/'>끝 &raquo;</a></li>
    
  </ul>
  
</div>

  </div>

</div>

<div class='container-fluid'>
  <hr>
  <footer>
    <p>
      &copy; 2014-2021 Sangmin Yoon
      <span class='pull-right text-muted'>
        powered by
        <a href='https://gohugo.io/' target='_blank'>Hugo</a>
        ,
        <a href='http://getbootstrap.com/' target='_blank'>Bootstrap</a>
        ,
        <a href='http://www.dnsever.com' target='dnsever'><img src='http://banner.dnsever.com/dnsever-banner_62x15.gif'
            border='0' alt='DNS server, DNS service '></a>
      </span>
    </p>
  </footer>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-48366784-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script src='https://code.jquery.com/jquery-1.12.4.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>

</body>

</html>
