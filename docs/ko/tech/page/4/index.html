<!DOCTYPE html>
<html lang='ko'>

<head>
  <meta charset='utf-8'>

  
  <title>sixmen.com: Tech</title>
  
  
  <meta name='author' content='Sangmin Yoon'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>

  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'>
  <link href='/css/style.css?body=1' rel='stylesheet' type='text/css' media='all'>
  <link href='/css/syntax.css?body=1' rel='stylesheet' type='text/css' media='all'>

  <!--[if lt IE 9]>
  <script src='https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js'></script>
  <script src='https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js'></script>
  <![endif]-->
</head>

<body>
<div class='hp-navbar'>
  <div class='container-fluid'>
    <div class='row'>
      <div class='col-xs-12'>
        
        <nav class='hp-nav'>
          <a class='hp-nav-item'
            href='/ko/'>Home</a>
          <a class='hp-nav-item'
            href='/ko/mylife/'>MyLife</a>
          <a class='hp-nav-item'
            href='/ko/travel/'>Travel</a>
          <a class='hp-nav-item active'
            href='/ko/tech/'>Tech</a>
          <a class='hp-nav-item'
            href='/ko/tags/'>Tags</a>
          <a class='hp-nav-item pull-right' href='/en/'>English</a>
        </nav>
      </div>
    </div>
  </div>
</div>



<div class='container'>

  <div class='row' style='margin-top: 20px;'>

    <div class='col-sm-10 col-sm-offset-1'>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-01-13-2-jotai-recipe/'>Jotai 레시피</a></h2>
          <p class='posts-date'>13 Jan 2022</p>
        </div>
        <div class='panel-body'>
          <p>이번 글에서는 카카오스타일에서 Jotai를 어떤 식으로 사용하고 있는지 여러가지 패턴에 대해 설명하려고 합니다.</p>
<h2 id="상태-정의하고-사용하기">상태 정의하고 사용하기</h2>
<p><a href="https://jotai.org/">Jotai</a>의 기본 사용법은 간단합니다. <a href="https://ko.reactjs.org/docs/hooks-reference.html#usestate">useState</a>로 정의하던 상태가 있으면,
<a href="https://jotai.org/docs/api/core#atom">atom</a> 메소드로 정의하고 <a href="https://jotai.org/docs/api/core#use-atom">useAtom</a>을 써서 사용하면 됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">atom</span><span class="p">,</span> <span class="nx">useAtom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">FC</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;react&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">count_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">App</span>: <span class="kt">FC</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">count</span><span class="p">,</span> <span class="nx">setCount</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useAtom</span><span class="p">(</span><span class="nx">count_atom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;{</span><span class="nx">count</span><span class="p">}&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nx">setCount</span><span class="p">(</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}&gt;</span><span class="nx">Inc</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>위 예제에서는 useState와 다른게 없지만, 하위 컴포넌트에서 해당 상태에 접근해야 할 경우 차이가 발생합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">atom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">useAtomValue</span><span class="p">,</span> <span class="nx">useUpdateAtom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai/utils&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">FC</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;react&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">count_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">Counter</span>: <span class="kt">FC</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">useAtomValue</span><span class="p">(</span><span class="nx">count_atom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;{</span><span class="nx">count</span><span class="p">}&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">IncButton</span>: <span class="kt">FC</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">setCount</span> <span class="o">=</span> <span class="nx">useUpdateAtom</span><span class="p">(</span><span class="nx">count_atom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nx">setCount</span><span class="p">((</span><span class="nx">count</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}&gt;</span><span class="nx">Inc</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">App</span>: <span class="kt">FC</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">Counter</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">IncButton</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p><a href="https://jotai.org/docs/utils/use-atom-value">useAtomValue</a>와 <a href="https://jotai.org/docs/utils/use-update-atom">useUpdateAtom</a>은
읽기나 쓰기 중 하나만 필요할 때 사용가능한 유틸리티 함수입니다.
쓰기 함수는 useState의 setState 처럼 이전 상태를 받아 이용할 수 있습니다.</p>
<h2 id="파생-atom">파생 atom</h2>
<p>원시 atom의 값에서 파생된 atom을 정의할 수도 있습니다. MobX나 Vue의 computed 속성과 비슷합니다.
useMemo와 같이 의존한 atom의 값이 바뀐 경우에만 재계산을 합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">email_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">password_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">button_enabled_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">((</span><span class="kr">get</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kr">get</span><span class="p">(</span><span class="nx">email_atom</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="kr">get</span><span class="p">(</span><span class="nx">password_atom</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><blockquote>
<p><a href="https://github.com/pmndrs/jotai/issues/619">같은 Provider가 제공한 atom의 값만 얻을 수 있습니다.</a></p>
</blockquote>
<h2 id="액션-atom">액션 atom</h2>
<p>쓰기 전용 atom을 통해 비즈니스 로직을 정의할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// 전화번호 인증 과정 중 전화번호 입력 필드 값이 바뀔 때 호출한다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">updateMobileTelAtom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="kr">get</span><span class="p">,</span> <span class="kr">set</span><span class="p">,</span> <span class="nx">value</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 인증 과정이 완료된 경우 전화번호를 변경할 수 없다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="kr">get</span><span class="p">(</span><span class="nx">authenticated_atom</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 전화번호 표시에서 -등 기타 문자는 제거한다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">set</span><span class="p">(</span><span class="nx">mobile_tel_atom</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[^0-9]/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 인증 번호 입력 시간을 초기화한다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">set</span><span class="p">(</span><span class="nx">remain_time_atom</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>대부분의 로직은 서버 API 호출을 필요로 하는 경우가 많습니다. 이 경우 응답을 기다리는, 즉 비동기 동작이 필요합니다.
Redux에서는 <a href="https://redux.js.org/usage/writing-logic-thunks">thunk</a> 같은 미들웨어가 필요하지만, Jotai에서는 자연스럽게 정의할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// 전화번호 인증 토큰을 발송한다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">sendAuthenticationTokenAtom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="kr">get</span><span class="p">,</span> <span class="kr">set</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 중복 발송을 막는다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="kr">get</span><span class="p">(</span><span class="nx">submitting_atom</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">set</span><span class="p">(</span><span class="nx">submitting_atom</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/sendAuthenticationToken&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">mobile_tel</span>: <span class="kt">get</span><span class="p">(</span><span class="nx">mobile_tel_atom</span><span class="p">)</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="kr">set</span><span class="p">(</span><span class="nx">submitting_atom</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 이전 에러 메시지를 초기화한다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">set</span><span class="p">(</span><span class="nx">authentication_error_atom</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 토큰 입력을 초기화한다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">set</span><span class="p">(</span><span class="nx">token_atom</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 입력 시간을 2분으로 초기화한다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">set</span><span class="p">(</span><span class="nx">remain_time_atom</span><span class="p">,</span> <span class="mi">120</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">set</span><span class="p">(</span><span class="nx">submitting_atom</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><h2 id="디렉토리-구조">디렉토리 구조</h2>
<p>값과 액션이 사실 같은 atom이지만, 편의상 구분하고 있습니다.
이 둘을 묶은 용어를 고민하다가, Redux, MobX 등에서 쓰는 store라고 부르기로 했습니다. (ViewModel이라고 부를까도 고민했습니다.)</p>
<p>MobX에서 값과 액션을 한 클래스로 만들면 파일을 나누기가 어려운데 반해, Jotai는 atom의 모음이다 보니 나누기가 편리합니다.
값은 atoms 디렉토리, 액션은 actions 디렉토리에 둡니다. atoms는 연관성이 높은 것들을 한 파일로 묶고, 액션은 보통 길이가 길기 때문에 액션 별로 파일을 만들고 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// src/components/model/detail/store/index.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="o">*</span> <span class="kr">from</span> <span class="s1">&#39;./atoms&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="o">*</span> <span class="kr">from</span> <span class="s1">&#39;./actions&#39;</span><span class="p">;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// src/components/model/detail/store/atoms/index.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">atom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="o">*</span> <span class="kr">from</span> <span class="s1">&#39;./orderer&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">submitting_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// src/components/model/detail/store/atoms/orderer.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">atom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">orderer_email_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">orderer_mobile_tel_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">orderer_name_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// src/components/model/detail/store/actions/index.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="o">*</span> <span class="kr">from</span> <span class="s1">&#39;./purchase&#39;</span><span class="p">;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// src/components/model/detail/store/actions/purchase.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">atom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">orderer_email_atom</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;../atoms&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">purchaseAtom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="kr">get</span><span class="p">,</span> <span class="kr">set</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">orderer_email</span> <span class="o">=</span> <span class="kr">get</span><span class="p">(</span><span class="nx">orderer_email_atom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><h2 id="provider와-초기값">Provider와 초기값</h2>
<p>atom의 값은 글로벌에 존재하는 atom에 저장되는 것이 아니라 Context와 비슷하게 컴포넌트 트리 상에 저장됩니다.
<a href="https://jotai.org/docs/api/core#provider">Provider</a>를 사용하면 atom이 저장될 Context를 제공할 수 있습니다.
(즉 참조하는 Provider가 다르면 같은 atom을 use해도 값이 다릅니다) Provider를 지정하지 않으면 기본 저장소가 사용됩니다.</p>
<p><a href="https://www.notion.so/React-4d3def2180fe4989b39b643b22b7d899">컴포넌트 구성 아티클</a>에서 설명했듯이 페이지와 내부 구성 컴포넌트가 분리되어 있는데,
스토리북에서도 정상 동작하도록 내부 컴포넌트쪽에 Provider 선언을 두고 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// Jotai 적용 전
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">ProfileAddress</span>: <span class="kt">FC</span><span class="o">&lt;</span><span class="p">{</span><span class="nx">address1</span>: <span class="kt">string</span><span class="p">;</span> <span class="nx">address2</span>: <span class="kt">string</span><span class="p">}</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">address1</span><span class="p">,</span> <span class="nx">setAddress1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">address1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">address2</span><span class="p">,</span> <span class="nx">setAddress2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">address2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">ProfileAddress</span><span class="p">;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// Jotai 적용 후
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">address1_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">address2_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">ProfileAddress</span>: <span class="kt">FC</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">address1</span><span class="p">,</span> <span class="nx">setAddress1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useAtom</span><span class="p">(</span><span class="nx">address1_atom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">address2</span><span class="p">,</span> <span class="nx">setAddress2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useAtom</span><span class="p">(</span><span class="nx">address2_atom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">ProfileAddressWithProvider</span>: <span class="kt">FC</span><span class="o">&lt;</span><span class="p">{</span> <span class="nx">address1</span>: <span class="kt">string</span><span class="p">;</span> <span class="nx">address2</span>: <span class="kt">string</span> <span class="p">}</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">Provider</span>
</span></span><span class="line"><span class="cl">      <span class="na">initialValues</span><span class="o">=</span><span class="p">{[</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="nx">address1_atom</span><span class="p">,</span> <span class="nx">props</span><span class="p">.</span><span class="nx">address1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="nx">address2_atom</span><span class="p">,</span> <span class="nx">props</span><span class="p">.</span><span class="nx">address2</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span> <span class="kr">as</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="p">[</span><span class="nx">Atom</span><span class="p">&lt;</span><span class="nt">unknown</span><span class="p">&gt;,</span> <span class="kt">unknown</span><span class="p">]</span><span class="o">&gt;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">ProfileAddress</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">Provider</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">ProfileAddressWithProvider</span><span class="p">;</span>
</span></span></code></pre></div><p>위와 같이 외부에서 Props로 받아 온 값을 initialValues로 atom에 넣어주면 이후 Props 참조 없이, atom에서 값을 읽을 수 있습니다.</p>
<p>디렉토리 구조에서 설명했듯이 atom 정의는 하위 디렉토리에서 하고 있습니다.
이런 atom을 초기화하는 코드도 atom 정의와 같이 있는 것이 바람직하기 때문에, 초기화 내용을 분리해 store/atoms/index.ts 에 만들고 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// store/atoms/index.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">Atom</span><span class="p">,</span> <span class="nx">atom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">address1_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">address2_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">getInitialValues</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">address1</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">address2</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="p">[</span><span class="nx">Atom</span><span class="p">&lt;</span><span class="nt">unknown</span><span class="p">&gt;,</span> <span class="kt">unknown</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">address1_atom</span><span class="p">,</span> <span class="nx">address1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">address2_atom</span><span class="p">,</span> <span class="nx">address2</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="onmount과-localstorage">onMount과 localStorage</h2>
<p>atom에 고정된 값 대신 처음 사용되는 시점에 값을 정해지도록 할 수 있습니다.
예를 들어 atom 값을 localStorage에서 가져와 초기화 시키고 싶을 수 있습니다.
이 경우 <a href="https://jotai.org/docs/api/core#on-mount">onMount</a>를 사용하면 됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">toolip_seen_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">&lt;</span><span class="nt">boolean</span><span class="p">&gt;(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">toolip_seen_atom</span><span class="p">.</span><span class="nx">onMount</span> <span class="o">=</span> <span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">set</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;toolip_seen&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;true&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>그런데 위 코드로는 atom 값을 갱신했을 때 localStorage에 반영되지 않습니다.
쓰기시 커스텀 동작을 하면서, 저장도 하고 싶은 경우, 저장용 atom을 분리해야 합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">toolip_seen_base_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">&lt;</span><span class="nt">boolean</span><span class="p">&gt;(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">toolip_seen_base_atom</span><span class="p">.</span><span class="nx">onMount</span> <span class="o">=</span> <span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">set</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;toolip_seen&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;true&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">toolip_seen_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kr">get</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">get</span><span class="p">(</span><span class="nx">toolip_seen_base_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="kr">set</span><span class="p">,</span> <span class="nx">seen</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">set</span><span class="p">(</span><span class="nx">toolip_seen_base_atom</span><span class="p">,</span> <span class="nx">seen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;toolip_seen&#39;</span><span class="p">,</span> <span class="nx">seen</span> <span class="o">?</span> <span class="s1">&#39;true&#39;</span> <span class="o">:</span> <span class="s1">&#39;false&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></div><p>같은 역할을 하는 것으로 <a href="https://jotai.org/docs/utils/atom-with-storage">atomWithStorage</a> 유틸리티 함수가 있는데,
일부 환경에서 오동작을 하는 듯 해서 사용하지 못하고 있습니다. (Promise를 사용해 비동기적으로 동작하는 부분을 의심하고 있습니다.)</p>
<h2 id="atom-조합-및-분리">atom 조합 및 분리</h2>
<p>개별 atom도 사용하지만, 그 값을 합친 것도 필요한 경우가 있습니다. 파생 atom으로 이를 구현할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">atom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">orderer_email_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">orderer_mobile_tel_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">orderer_name_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">orderer_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">((</span><span class="kr">get</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">email</span>: <span class="kt">get</span><span class="p">(</span><span class="nx">orderer_email_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">mobile_tel</span>: <span class="kt">get</span><span class="p">(</span><span class="nx">orderer_mobile_tel_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span>: <span class="kt">get</span><span class="p">(</span><span class="nx">orderer_name_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">}));</span>
</span></span></code></pre></div><p>반대로 atom이 전체 값을 가지고 있는데, 그 중 일부만 필요한 경우도 있습니다.
<a href="https://jotai.org/docs/utils/select-atom">selectAtom</a>을 사용하면 됩니다. 원본 atom의 값을 바꿀 일이 없을 때 사용하면 편리합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">atom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">selectAtom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai/utils&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">order_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">&lt;</span><span class="nt">Order</span><span class="p">&gt;(...);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">ordered_product_atom</span> <span class="o">=</span> <span class="nx">selectAtom</span><span class="p">&lt;</span><span class="nt">OrderProduct</span><span class="p">&gt;(</span><span class="nx">order_atom</span><span class="p">,</span> <span class="p">(</span><span class="nx">order</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">order</span><span class="p">.</span><span class="nx">product</span><span class="p">);</span>
</span></span></code></pre></div><h2 id="immer">immer</h2>
<p>atom이 복잡한 객체일 때, 일부 속성만 편하게 갱신하기 위해서 <a href="https://immerjs.github.io/immer/">immer</a>를 사용할 수 있습니다.
도움을 주는 <a href="https://jotai.org/docs/integrations/immer">유틸리티 모듈</a>도 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// immer를 사용하지 않는 경우
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">selected_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="o">&lt;</span><span class="p">{</span> <span class="p">[</span><span class="nx">key</span>: <span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">({</span> <span class="nx">apple</span>: <span class="kt">true</span><span class="p">,</span> <span class="nx">banana</span>: <span class="kt">false</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">setSelectedAtom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="kr">get</span><span class="p">,</span> <span class="kr">set</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fruit</span>: <span class="kt">string</span><span class="p">;</span> <span class="nx">checked</span>: <span class="kt">boolean</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">selected</span> <span class="o">=</span> <span class="kr">get</span><span class="p">(</span><span class="nx">selected_atom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">set</span><span class="p">(</span><span class="nx">selected_atom</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">selected</span><span class="p">,</span> <span class="p">...{</span> <span class="p">[</span><span class="nx">value</span><span class="p">.</span><span class="nx">fruit</span><span class="p">]</span><span class="o">:</span> <span class="nx">value</span><span class="p">.</span><span class="nx">checked</span> <span class="p">}</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// immer를 사용하는 경우
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">produce</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;immer&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">selected_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="o">&lt;</span><span class="p">{</span> <span class="p">[</span><span class="nx">key</span>: <span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">({</span> <span class="nx">apple</span>: <span class="kt">true</span><span class="p">,</span> <span class="nx">banana</span>: <span class="kt">false</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">setSelectedAtom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="kr">get</span><span class="p">,</span> <span class="kr">set</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fruit</span>: <span class="kt">string</span><span class="p">;</span> <span class="nx">checked</span>: <span class="kt">boolean</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">set</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">selected_atom</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">produce</span><span class="p">(</span><span class="kr">get</span><span class="p">(</span><span class="nx">selected_atom</span><span class="p">),</span> <span class="p">(</span><span class="nx">draft</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">draft</span><span class="p">[</span><span class="nx">value</span><span class="p">.</span><span class="nx">fruit</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">checked</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}),</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// immer 연동 모듈을 사용하는 경우
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">atomWithImmer</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai/immer&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">selected_atom</span> <span class="o">=</span> <span class="nx">atomWithImmer</span><span class="o">&lt;</span><span class="p">{</span> <span class="p">[</span><span class="nx">key</span>: <span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">({</span> <span class="nx">apple</span>: <span class="kt">true</span><span class="p">,</span> <span class="nx">banana</span>: <span class="kt">false</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">setSelectedAtom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="kr">get</span><span class="p">,</span> <span class="kr">set</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fruit</span>: <span class="kt">string</span><span class="p">;</span> <span class="nx">checked</span>: <span class="kt">boolean</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">set</span><span class="p">(</span><span class="nx">selected_atom</span><span class="p">,</span> <span class="p">(</span><span class="nx">draft</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">draft</span><span class="p">[</span><span class="nx">value</span><span class="p">.</span><span class="nx">fruit</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">checked</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><h2 id="공용-컴포넌트">공용 컴포넌트</h2>
<p>여러 페이지에서 사용하는 공통 컴포넌트가 있을 수 있습니다.
그리고 그 컴포넌트가 제공하는 상태를 atom으로 정의해 부모가 읽을 수 있도록 만들 수 있습니다.
이때 부모가 읽을 수 있도록 공용 컴포넌트에 Provider를 별도로 두지 않았습니다.
다만 Provider가 별도로 존재하지 않으므로 인스턴스를 여러개 만들 수는 없습니다. (Input 컴포넌트 같은 것은 불가능)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// common/EditReceiverView/index.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">receiver_name_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">receiver_mobile_tel_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">receiver_postcode_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">receiver_address1_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">receiver_address2_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">receiver_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">((</span><span class="kr">get</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span>: <span class="kt">get</span><span class="p">(</span><span class="nx">receiver_name_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">mobile_tel</span>: <span class="kt">get</span><span class="p">(</span><span class="nx">receiver_mobile_tel_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">postcode</span>: <span class="kt">get</span><span class="p">(</span><span class="nx">receiver_postcode_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">address1</span>: <span class="kt">get</span><span class="p">(</span><span class="nx">receiver_address1_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">address2</span>: <span class="kt">get</span><span class="p">(</span><span class="nx">receiver_address2_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">}));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">getInitialValues</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">default_receiver</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mobile_tel</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">postcode</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">address1</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">address2</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="p">[</span><span class="nx">Atom</span><span class="p">&lt;</span><span class="nt">unknown</span><span class="p">&gt;,</span> <span class="kt">unknown</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">receiver_name_atom</span><span class="p">,</span> <span class="nx">default_receiver</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span> <span class="o">??</span> <span class="s1">&#39;&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">receiver_mobile_tel_atom</span><span class="p">,</span> <span class="nx">default_receiver</span><span class="o">?</span><span class="p">.</span><span class="nx">mobile_tel</span> <span class="o">??</span> <span class="s1">&#39;&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">receiver_postcode_atom</span><span class="p">,</span> <span class="nx">default_receiver</span><span class="o">?</span><span class="p">.</span><span class="nx">postcode</span> <span class="o">??</span> <span class="s1">&#39;&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">receiver_address1_atom</span><span class="p">,</span> <span class="nx">default_receiver</span><span class="o">?</span><span class="p">.</span><span class="nx">address1</span> <span class="o">??</span> <span class="s1">&#39;&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">receiver_address2_atom</span><span class="p">,</span> <span class="nx">default_receiver</span><span class="o">?</span><span class="p">.</span><span class="nx">address2</span> <span class="o">??</span> <span class="s1">&#39;&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">EditReceiverView</span>: <span class="kt">FC</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">receiver_name</span><span class="p">,</span> <span class="nx">setReceiverName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useAtom</span><span class="p">(</span><span class="nx">receiver_name_atom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">Input</span>
</span></span><span class="line"><span class="cl">        <span class="na">label</span><span class="o">=</span><span class="s">&#39;받는 분&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="na">type</span><span class="o">=</span><span class="s">&#39;text&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="na">placeholder</span><span class="o">=</span><span class="s">&#39;이름을 입력해주세요&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">receiver_name</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="na">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">setReceiverName</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">EditReceiverView</span><span class="p">;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// order-sheet/index.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">receiver_atom</span><span class="p">,</span> <span class="nx">getInitialValues</span> <span class="kr">as</span> <span class="nx">EditReceiverView_getInitialValues</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;common/EditReceiverView&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">order_sheet_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">&lt;</span><span class="nt">OrderSheet</span><span class="p">&gt;({});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">getInitialValues</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">order_sheet</span>: <span class="kt">OrderSheet</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">default_receiver</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mobile_tel</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">postcode</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">address1</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">address2</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="p">[</span><span class="nx">Atom</span><span class="p">&lt;</span><span class="nt">unknown</span><span class="p">&gt;,</span> <span class="kt">unknown</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">order_sheet_atom</span><span class="p">,</span> <span class="nx">order_sheet</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span><span class="nx">EditReceiverView_getInitialValues</span><span class="p">(</span><span class="nx">default_receiver</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">purchaseAtom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="kr">get</span><span class="p">,</span> <span class="kr">set</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">order_sheet</span> <span class="o">=</span> <span class="kr">get</span><span class="p">(</span><span class="nx">order_sheet_atom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">receiver</span> <span class="o">=</span> <span class="kr">get</span><span class="p">(</span><span class="nx">receiver_atom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">OrderSheet</span>: <span class="kt">FC</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">purchase</span> <span class="o">=</span> <span class="nx">useUpdateAtom</span><span class="p">(</span><span class="nx">purchaseAtom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">EditReceiverView</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nx">purchase</span><span class="p">()}&gt;</span><span class="err">구매하기</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">OrderSheetWithProvider</span>: <span class="kt">FC</span><span class="p">&lt;</span><span class="nt">Props</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">Provider</span>
</span></span><span class="line"><span class="cl">      <span class="na">initialValues</span><span class="o">=</span><span class="p">{</span><span class="nx">getInitialValues</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">props</span><span class="p">.</span><span class="nx">order_sheet</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">props</span><span class="p">.</span><span class="nx">default_receiver</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">)}</span>
</span></span><span class="line"><span class="cl">    <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">OrderSheet</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">Provider</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">OrderSheetWithProvider</span><span class="p">;</span>
</span></span></code></pre></div><h2 id="테스트">테스트</h2>
<p>테스트는 중요하지만, 잘 하기는 쉽지 않습니다. 특히 수시로 변경되는 UI는 안정적이고 믿을 수 있는 테스트를 작성하기가 더 어렵습니다.
하지만 상태를 뷰와 분리하면 그나마 테스트가 좀 쉬워집니다. Jotai로 만든 store는 뷰와 무관하기 때문에 테스트 작성이 비교적 용이합니다.</p>
<p>다음과 같이 포인트 최대 적용이라는 액션을 만들었습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">atom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 주문액
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">payment_amount_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 소유한 포인트 금액
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">available_point_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 최대 사용가능한 포인트 금액
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">maximum_usable_point_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">((</span><span class="kr">get</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">available_point</span> <span class="o">=</span> <span class="kr">get</span><span class="p">(</span><span class="nx">available_point_atom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">available_point</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">payment_amount</span> <span class="o">=</span> <span class="kr">get</span><span class="p">(</span><span class="nx">payment_amount_atom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">available_point</span> <span class="o">&lt;=</span> <span class="nx">payment_amount</span> <span class="o">?</span> <span class="nx">available_point</span> : <span class="kt">payment_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 사용할 포인트 금액
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">point_to_use_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 사용가능한 최대 포인트를 적용한다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">applyAllPointAtom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="kr">get</span><span class="p">,</span> <span class="kr">set</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">set</span><span class="p">(</span><span class="nx">point_to_use_atom</span><span class="p">,</span> <span class="kr">get</span><span class="p">(</span><span class="nx">maximum_usable_point_atom</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Provider의 initialValues를 위한 도움 함수
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">getInitialValues</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">payment_amount</span>: <span class="kt">number</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">available_point</span>: <span class="kt">number</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="p">[</span><span class="nx">Atom</span><span class="p">&lt;</span><span class="nt">unknown</span><span class="p">&gt;,</span> <span class="kt">unknown</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">payment_amount_atom</span><span class="p">,</span> <span class="nx">payment_amount</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">available_point_atom</span><span class="p">,</span> <span class="nx">available_point</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>다음은 이 액션에 대한 테스트 코드입니다.(action 파일과 같은 디렉토리에 위치시켰습니다)
현재 카카오스타일은 <a href="https://jestjs.io/">Jest</a> 프레임워크를 사용중이고(서버는 <a href="https://mochajs.org/">Mocha</a>를 사용하고 있습니다),
<a href="https://testing-library.com/">Testing Library</a>의 도움을 받고 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">renderHook</span><span class="p">,</span> <span class="nx">act</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@testing-library/react-hooks&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Provider</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">useAtomValue</span><span class="p">,</span> <span class="nx">useUpdateAtom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai/utils&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">getInitialValues</span><span class="p">,</span> <span class="nx">maximum_usable_point_atom</span><span class="p">,</span> <span class="nx">point_to_use_atom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;../atoms&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">applyAllPointAtom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;./applyAllPoint&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;applyAllPoint&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;포인트 사용액 기본값은 0이다&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">result</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">renderHook</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">point_to_use</span>: <span class="kt">useAtomValue</span><span class="p">(</span><span class="nx">point_to_use_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">point_to_use</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;사용 가능한 금액만큼 적용된다&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">initial_values</span> <span class="o">=</span> <span class="nx">getInitialValues</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="mi">92500</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mi">10000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">result</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">renderHook</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">point_to_use</span>: <span class="kt">useAtomValue</span><span class="p">(</span><span class="nx">point_to_use_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">maximum_usable_point</span>: <span class="kt">useAtomValue</span><span class="p">(</span><span class="nx">maximum_usable_point_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">applyAllPoint</span>: <span class="kt">useUpdateAtom</span><span class="p">(</span><span class="nx">applyAllPointAtom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">}),</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wrapper</span><span class="o">:</span> <span class="p">({</span> <span class="nx">children</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nt">Provider</span> <span class="na">initialValues</span><span class="o">=</span><span class="p">{</span><span class="nx">initial_values</span><span class="p">}&gt;{</span><span class="nx">children</span><span class="p">}&lt;/</span><span class="nt">Provider</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">act</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">applyAllPoint</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">maximum_usable_point</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">point_to_use</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;사용 가능한 금액이 주문 금액보다 많으면 주문 금액만큼 적용된다&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">initial_values</span> <span class="o">=</span> <span class="nx">getInitialValues</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="mi">92500</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mi">200000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">result</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">renderHook</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">point_to_use</span>: <span class="kt">useAtomValue</span><span class="p">(</span><span class="nx">point_to_use_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">maximum_usable_point</span>: <span class="kt">useAtomValue</span><span class="p">(</span><span class="nx">maximum_usable_point_atom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">applyAllPoint</span>: <span class="kt">useUpdateAtom</span><span class="p">(</span><span class="nx">applyAllPointAtom</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">}),</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wrapper</span><span class="o">:</span> <span class="p">({</span> <span class="nx">children</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nt">Provider</span> <span class="na">initialValues</span><span class="o">=</span><span class="p">{</span><span class="nx">initial_values</span><span class="p">}&gt;{</span><span class="nx">children</span><span class="p">}&lt;/</span><span class="nt">Provider</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">act</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">applyAllPoint</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">maximum_usable_point</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">92500</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">point_to_use</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">92500</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div>
        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-01-13-1-frontend-state-management/'>프론트엔드 상태 관리에 대한 여정</a></h2>
          <p class='posts-date'>13 Jan 2022</p>
        </div>
        <div class='panel-body'>
          <p>카카오스타일은 React에서 상태 관리를 위해 최근에 <a href="https://jotai.org/">Jotai</a>를 도입했습니다. Jotai에 대해 소개하기에 앞서 Jotai에 다다르기까지의 과정에 대해 설명해보려고 합니다.</p>
<h2 id="선언형-ui">선언형 UI</h2>
<p>할일 관리 화면을 상상해봅시다. 초기 웹에서 보편적이였던 jQuery를 사용한다면, 할 일 추가를 위해 다음과 같이 작성할 것 같습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">todos</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#text&#39;</span><span class="p">).</span><span class="nx">change</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">todos</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">completed</span>: <span class="kt">false</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#list&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="sb">`&lt;li&gt;</span><span class="si">${</span><span class="nx">text</span><span class="si">}</span><span class="sb">&lt;/li&gt;`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>이런 구성은 todos 변수(모델)와 #list 원소의 내용(뷰)을 동기화 시키는 것이 굉장히 어렵습니다. 그래서 React를 비롯한 대부분의 현대식 프레임워크는 모델과 뷰의 관계를 선언형(declarative)으로 정의하면 알아서 모델의 변경 사항을 뷰에 반영해주어서 뷰 코드를 단순하게 만들어줍니다.</p>
<blockquote>
<p>최근에는 네이티브 앱 개발에서도 SwiftUI나 Jetpack compose 처럼 선언형 UI 프레임워크가 나오고 있습니다.</p>
</blockquote>
<p>저는 어떤 화면을 표현하기 위한 데이터와 뷰와의 관계(매핑) 대부분은 직관적으로 정의할 수 있다고 생각합니다. 이렇게 구성한 뷰를 React가 효율적으로 최종 DOM에 반영해주기 때문에, 결국 우리가 가장 신경써야 할 부분은 데이터 모델링과 사용자 행위에 따라 데이터가 어떻게 바뀌는지에 대한 것입니다. 이 데이터를 React에서는 상태라 부르고, 극단적으로 (렌더링은 React가 책임져주므로) 상태 관리만 잘 하면 좋은 어플리케이션이 만들어진다고 생각합니다. 이게 중요하지만 그만큼 어렵다 보니 상태 관리 라이브러리가 다양하게 나온 것이라고 생각합니다.</p>
<blockquote>
<p>이 데이터에는 UI를 위한 데이터(예를 들어 Collapse 컴포넌트의 접기 상태)도 있다는 것에서 일반적인 모델과 구분됩니다. 저는 이게 MVVM 패턴의 ViewModel이라고 생각합니다. 현재 네이티브 앱에서 선언형 UI까지는 하지 못햇지만 MVVM 패턴을 사용해 뷰와 데이터를 분리하고 있습니다.</p>
</blockquote>
<h2 id="mithril">Mithril</h2>
<p>지그재그 초기에는 내부 툴을 위해 <a href="https://mithril.js.org/">Mithril</a>을 사용했는데 몇단계의 개선을 통해 최종적으로는 다음과 같이 MVVM 구성을 했습니다.</p>
<blockquote>
<p>당시에는 제 기준으로 React와 큰 차이가 없었는데, 이후 React는 <a href="https://ko.reactjs.org/docs/hooks-intro.html">훅</a>이라는 큰 변화가 생겼고, Mithril은 큰 변화없이 정체되다가 현재는 완전히 멈추었습니다. 2019년 이후 React를 사용하는 것으로 정책이 바뀌었지만, 일부 프로젝트(예 FAQ)에 아직 흔적이 남아있습니다.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">SignupViewAttrs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">token?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">SignupViewModel</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">token</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">email</span>: <span class="kt">Stream.Stream</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">password</span>: <span class="kt">Stream.Stream</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">password_confirm</span>: <span class="kt">Stream.Stream</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">enabled</span>: <span class="kt">Stream.Stream</span><span class="p">&lt;</span><span class="nt">boolean</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="nx">attrs</span>: <span class="kt">SignupViewAttrs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">token</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">Stream</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">Stream</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">password_confirm</span> <span class="o">=</span> <span class="nx">Stream</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">eanbled</span> <span class="o">=</span> <span class="nx">Stream</span><span class="p">.</span><span class="nx">merge</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">password_confirm</span><span class="p">]).</span><span class="nx">map</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">([</span><span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">password_confirm</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">email</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">password</span> <span class="o">===</span> <span class="nx">password_confirm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">signup</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// signup logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">SignupView</span> <span class="kr">implements</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ClassComponent</span><span class="p">&lt;</span><span class="nt">SignupViewAttrs</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">vm</span>: <span class="kt">SignupViewModel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">oninit</span><span class="p">({</span> <span class="nx">attrs</span> <span class="p">}</span><span class="o">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">CVnode</span><span class="p">&lt;</span><span class="nt">SignupViewAttrs</span><span class="p">&gt;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">vm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SignupViewModel</span><span class="p">(</span><span class="nx">attrs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">view</span><span class="p">({</span> <span class="nx">attrs</span> <span class="p">}</span><span class="o">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">CVnode</span><span class="p">&lt;</span><span class="nt">SignupViewAttrs</span><span class="p">&gt;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">form</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;form-horizontal&#39;</span> <span class="na">onsubmit</span><span class="o">=</span><span class="p">{(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">signup</span><span class="p">(</span><span class="nx">event</span><span class="p">)}&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;form-group&#39;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;form-control&#39;</span> <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">email</span><span class="p">()}</span> <span class="na">onchange</span><span class="o">=</span><span class="p">{</span><span class="nx">m</span><span class="p">.</span><span class="nx">withAttr</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">email</span><span class="p">)}</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;form-group&#39;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">input</span>
</span></span><span class="line"><span class="cl">            <span class="na">type</span><span class="o">=</span><span class="s">&#39;password&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="na">class</span><span class="o">=</span><span class="s">&#39;form-control&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">password</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl">            <span class="na">onchange</span><span class="o">=</span><span class="p">{</span><span class="nx">m</span><span class="p">.</span><span class="nx">withAttr</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">password</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">          <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;form-group&#39;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">input</span>
</span></span><span class="line"><span class="cl">            <span class="na">type</span><span class="o">=</span><span class="s">&#39;password&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="na">class</span><span class="o">=</span><span class="s">&#39;form-control&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">password_confirm</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl">            <span class="na">onchange</span><span class="o">=</span><span class="p">{</span><span class="nx">m</span><span class="p">.</span><span class="nx">withAttr</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">password_confirm</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">          <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;form-group&#39;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;submit&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;btn btn-default&#39;</span> <span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">enabled</span><span class="p">()}&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="err">가입하기</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="mobx">MobX</h2>
<p>이후에 2019년 초 커머스 플랫폼으로 전환을 시작하면서 웹으로 구성한 화면들이 생겨나기 시작했는데 이때 React와 <a href="https://nextjs.org/">Next.js</a>를 선택했습니다. 그리고 상태관리 라이브러리를 선택해야 했는데, 당시 <a href="https://redux.js.org/">Redux</a>가 대새였지만 저희팀은 <a href="https://mobx.js.org/">MobX</a>를 선택했습니다. 그 선택에 제가 관여를 하진 않았는데, 아마 OOP 스타일인게 영향을 미치지 않았을까 싶습니다. 거기에 지금도 그렇지만 Redux를 잘 쓰려면 알아야 할 개념과 부가적인 라이브러리가 많습니다. 개인적으로 상태는 최소한의 범위만 영향을 주는 것이 부수 효과가 적다고 생각하기 때문에, <a href="https://redux.js.org/tutorials/fundamentals/part-2-concepts-data-flow#single-source-of-truth">글로벌 상태를 하나의 스토어에 두는 Redux 컨셉</a>에 거부감이 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">computed</span><span class="p">,</span> <span class="nx">observable</span><span class="p">,</span> <span class="nx">observer</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;mobx&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">Store</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@observable</span> <span class="nx">email</span>: <span class="kt">string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@observable</span> <span class="nx">password</span>: <span class="kt">string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@observable</span> <span class="nx">password_confirm</span>: <span class="kt">string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">@computed</span>
</span></span><span class="line"><span class="cl">  <span class="kr">get</span> <span class="nx">enabled() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">password_confirm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">@observer</span>
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">LoginView</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span><span class="o">&lt;</span><span class="p">{</span> <span class="nx">store</span>: <span class="kt">Store</span> <span class="p">}</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">render() {</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">store</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">store</span><span class="p">.</span><span class="nx">email</span><span class="p">}</span> <span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">store</span><span class="p">.</span><span class="nx">password</span><span class="p">}</span> <span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">store</span><span class="p">.</span><span class="nx">password_confirm</span><span class="p">}</span> <span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">password_confirm</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="o">!</span><span class="nx">store</span><span class="p">.</span><span class="nx">enabled</span><span class="p">}&gt;</span><span class="err">가입하기</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="usereducer">useReducer</h2>
<p>이후 회사 내부에 여러 웹 프로젝트가 생기면서 기술에 파편화가 일어나고 있던 상황에서, 2021년 중반에 새로 시작한 프로젝트를 새로운 표준으로 삼기 위해, 상태 관리에 대해 다시 한번 조사해봤습니다. 이미 훅이 대세가 됐고 너무 좋아해서 기본 훅을 최대한 활용해 보기로 했습니다. MobX는 데코레이터를 활용하는 것과 훅과 어울리지 않는 다는 인상이 있어 배제했습니다. (최신 버전에서는 달라진 것으로 알고 있습니다)</p>
<p>처음 시도는 useReducer였습니다. 다만 이것만으로는 반복되는 코드가 많아서 <a href="https://redux-toolkit.js.org/">Redux Toolkit</a>의 도움을 받았습니다. 그리고 <a href="https://github.com/erikras/ducks-modular-redux">Ducks 패턴</a>을 참고해서 파일 구성을 했습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// store.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">createSelector</span><span class="p">,</span> <span class="nx">createSlice</span><span class="p">,</span> <span class="nx">PayloadAction</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@reduxjs/toolkit&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">State</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">email</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">password</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">submitting</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">initial_state</span>: <span class="kt">State</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">submitting</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">login_slice</span> <span class="o">=</span> <span class="nx">createSlice</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;login&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">initialState</span>: <span class="kt">initial_state</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">reducers</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setEmail</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">action</span>: <span class="kt">PayloadAction</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">state</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">action</span><span class="p">.</span><span class="nx">payload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setPassword</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">action</span>: <span class="kt">PayloadAction</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">state</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">action</span><span class="p">.</span><span class="nx">payload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">startLogin</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">state</span><span class="p">.</span><span class="nx">submitting</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">endLogin</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">state</span><span class="p">.</span><span class="nx">submitting</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="p">{</span> <span class="nx">setEmail</span><span class="p">,</span> <span class="nx">setPassword</span><span class="p">,</span> <span class="nx">startLogin</span><span class="p">,</span> <span class="nx">endLogin</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">login_slice</span><span class="p">.</span><span class="nx">actions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">login_slice</span><span class="p">.</span><span class="nx">reducer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">self_selector</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span>: <span class="kt">State</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">button_enabled_selecter</span> <span class="o">=</span> <span class="nx">createSelector</span><span class="p">(</span><span class="nx">self_selector</span><span class="p">,</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">state</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">submitting</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">selector</span> <span class="o">=</span> <span class="nx">createSelector</span><span class="p">(</span><span class="nx">button_enabled_selecter</span><span class="p">,</span> <span class="p">(</span><span class="nx">button_enabled</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">button_enabled</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Login.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">useReducer</span><span class="p">,</span> <span class="nx">ReactElement</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;react&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">reducer</span><span class="p">,</span> <span class="p">{</span> <span class="nx">initial_state</span><span class="p">,</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">setEmail</span><span class="p">,</span> <span class="nx">setPassword</span><span class="p">,</span> <span class="nx">startLogin</span><span class="p">,</span> <span class="nx">endLogin</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;./store&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">Login</span><span class="p">()</span><span class="o">:</span> <span class="nx">ReactElement</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">state</span><span class="p">,</span> <span class="nx">dispatch</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useReducer</span><span class="p">(</span><span class="nx">reducer</span><span class="p">,</span> <span class="nx">initial_state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">button_enabled</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">login</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">dispatch</span><span class="p">(</span><span class="nx">startLogin</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// login logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">DefaultRouter</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">dispatch</span><span class="p">(</span><span class="nx">endLogin</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#39;max-w-screen-md mx-auto mt-10&#39;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#39;text-4xl&#39;</span><span class="p">&gt;</span><span class="err">이메일</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#39;my-4&#39;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">input</span>
</span></span><span class="line"><span class="cl">            <span class="na">className</span><span class="o">=</span><span class="s">&#39;w-full border-2 border-black text-4xl px-6 py-4&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="na">name</span><span class="o">=</span><span class="s">&#39;email&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">email</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">dispatch</span><span class="p">(</span><span class="nx">setEmail</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">))}</span>
</span></span><span class="line"><span class="cl">          <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#39;text-4xl&#39;</span><span class="p">&gt;</span><span class="err">암호</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#39;my-4&#39;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">input</span>
</span></span><span class="line"><span class="cl">            <span class="na">className</span><span class="o">=</span><span class="s">&#39;w-full border-2 border-black text-4xl px-6 py-4&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="na">name</span><span class="o">=</span><span class="s">&#39;password&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="na">type</span><span class="o">=</span><span class="s">&#39;password&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">password</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">dispatch</span><span class="p">(</span><span class="nx">setPassword</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">))}</span>
</span></span><span class="line"><span class="cl">          <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#39;mt-8&#39;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">button</span>
</span></span><span class="line"><span class="cl">          <span class="na">className</span><span class="o">=</span><span class="s">&#39;bg-blue-300 w-full border-2 border-black text-4xl px-6 py-4 disabled:opacity-50&#39;</span>
</span></span><span class="line"><span class="cl">          <span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">login</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="o">!</span><span class="nx">button_enabled</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="err">로그인하기</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>UI와 로직을 분리하는게 가장 큰 목표인데, login 로직이 아직 컴포넌트에 남아있습니다. useReducer로는 비동기 처리가 어려워서 <a href="https://github.com/dai-shi/use-reducer-async">use-reducer-async 모듈</a>을 참고해 비동기 리듀서를 만들었습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Dispatch</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Reducer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ReducerAction</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ReducerState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useCallback</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useEffect</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useLayoutEffect</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useReducer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useRef</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;react&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">AnyAction</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;redux&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">AsyncAction</span><span class="p">&lt;</span><span class="nt">S</span><span class="err">,</span> <span class="na">A </span><span class="o">=</span> <span class="na">AnyAction</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dispatch</span>: <span class="kt">AsyncDispatch</span><span class="p">&lt;</span><span class="nt">S</span><span class="err">,</span> <span class="na">A</span><span class="p">&gt;,</span> <span class="nx">getState</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">S</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">AsyncDispatch</span><span class="p">&lt;</span><span class="nt">S</span><span class="err">,</span> <span class="na">A</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">Dispatch</span><span class="p">&lt;</span><span class="nt">A</span> <span class="err">|</span> <span class="na">AsyncAction</span><span class="err">&lt;</span><span class="na">S</span><span class="err">,</span> <span class="na">A</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">isBrowser</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">useIsomorphicLayoutEffect</span> <span class="o">=</span> <span class="nx">isBrowser</span> <span class="o">?</span> <span class="nx">useLayoutEffect</span> : <span class="kt">useEffect</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">useAsyncReducer</span><span class="p">&lt;</span><span class="nt">R</span> <span class="na">extends</span> <span class="na">Reducer</span><span class="err">&lt;</span><span class="na">any</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">reducer</span>: <span class="kt">R</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">initialState</span>: <span class="kt">ReducerState</span><span class="p">&lt;</span><span class="nt">R</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">initState</span><span class="o">?:</span> <span class="p">(</span><span class="nx">state</span>: <span class="kt">ReducerState</span><span class="p">&lt;</span><span class="nt">R</span><span class="p">&gt;)</span> <span class="o">=&gt;</span> <span class="nx">ReducerState</span><span class="p">&lt;</span><span class="nt">R</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">:</span> <span class="p">[</span><span class="nx">ReducerState</span><span class="p">&lt;</span><span class="nt">R</span><span class="p">&gt;,</span> <span class="nx">AsyncDispatch</span><span class="p">&lt;</span><span class="nt">ReducerState</span><span class="err">&lt;</span><span class="na">R</span><span class="p">&gt;,</span> <span class="nx">ReducerAction</span><span class="p">&lt;</span><span class="nt">R</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">state</span><span class="p">,</span> <span class="nx">dispatch</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useReducer</span><span class="p">(</span><span class="nx">reducer</span><span class="p">,</span> <span class="nx">initialState</span><span class="p">,</span> <span class="nx">initState</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">last_state</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useIsomorphicLayoutEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">last_state</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="p">[</span><span class="nx">state</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">getState</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">last_state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="p">[]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">async_dispatch</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nx">action</span>: <span class="kt">ReducerAction</span><span class="p">&lt;</span><span class="nt">R</span><span class="p">&gt;</span> <span class="o">|</span> <span class="nx">AsyncAction</span><span class="p">&lt;</span><span class="nt">ReducerState</span><span class="err">&lt;</span><span class="na">R</span><span class="p">&gt;,</span> <span class="nx">ReducerAction</span><span class="p">&lt;</span><span class="nt">R</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">action</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nx">action</span> <span class="kr">as</span> <span class="nx">AsyncAction</span><span class="p">&lt;</span><span class="nt">ReducerState</span><span class="err">&lt;</span><span class="na">R</span><span class="p">&gt;,</span> <span class="nx">ReducerAction</span><span class="p">&lt;</span><span class="nt">R</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">)(</span><span class="nx">async_dispatch</span><span class="p">,</span> <span class="nx">getState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">dispatch</span><span class="p">(</span><span class="nx">action</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">dispatch</span><span class="p">,</span> <span class="nx">getState</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">[</span><span class="nx">state</span><span class="p">,</span> <span class="nx">async_dispatch</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>이후에 다음과 같이 login 액션을 분리했습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">login</span><span class="p">()</span><span class="o">:</span> <span class="nx">AsyncAction</span><span class="p">&lt;</span><span class="nt">State</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">dispatch</span><span class="p">,</span> <span class="nx">getState</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">getState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="nx">dispatch</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">startLogin</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// login logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">DefaultRouter</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">dispatch</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">endLogin</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="jotai">Jotai</h2>
<p>useReducuer를 사용해 한 페이지에 있는 여러 개의 상태를 개별 useState 대신 별도 파일로 분리하는 목적은 달성했지만 썩 맘에 들지 않았습니다.</p>
<ul>
<li>개인적으로 그냥 비지니스 로직이 담긴 함수를 리듀서라고 정의하는 것에 대한 거부감이 좀 있습니다. (로직을 처리하는게 아니라, state → state 변환을 처리하는 개념에 치중)</li>
<li>동기 액션과 비동기 액션 처리 정의가 다르게 생겼습니다.</li>
<li>button_enabled 같은 계산된 속성과 일반 속성 사용법이 너무 다릅니다.</li>
<li>개별 상태를 하위 컴포넌트에 일일이 전달할 필요는 없어졌지만 (Prop Drilling), state와 dispatch는 하위 컴포넌트에 전달해야 했습니다. (Context 적용을 고민해봤지만, 뭔가 잘 어울리지 않았습니다.)</li>
</ul>
<p>연구를 더 하면 더 낫게 구성할 가능성도 있지만, 근본적으로 제가 원하는 모습이 아닌 것 같다는 생각이 들었습니다.</p>
<p>우선 Redux 같은 복잡한 라이브러리를 쓰지 않고, React 기본 기능을 최대한 활용하면서 Prop Drilling을 피할 수 있는 방향, 즉 Context를 어떻게 활용하면 좋을까 여러가지 찾아봤습니다. 그런데 해당 화면에 필요한 상태를 한 Context에 모두 담아버리면 성능 이슈가 있다고 나왔습니다. (그래서 useContextSelector 같은게 나온 것으로 알고 있습니다.)</p>
<p>그러던 중 프론트엔드 미팅에서 누군가 Jotai를 써봤다는 얘기가 나와서 한번 조사를 해보게 됐습니다. 처음에는 어떻게 쓰면 좋을지 감이 안 잡혔는데, 일단 큰 state를 정의하는 대신, 개별 상태(atom)를 정의해서 조합해서 사용한다는 것이 맘에 와 닿았고 좀 더 깊에 연구를 들어갔습니다. 그 결과 제가 원하는 것을 대부분 달성할 수 있는 것으로 확인됐습니다. (계산된 속성/반응형 속성 관련해서는 아직 해결책을 못 찾은 부분이 있습니다) 무엇보다 개념이 단순하고 코드 크기가 작다는 것이 맘에 들었습니다. <a href="https://recoiljs.org/ko/">Recoil</a>도 Facebook이 직접 관리해서 장기적으로 유지가 될 가능성이 높다고 생각해 살펴봤지만, key가 존재하고, selector가 atom과 구분되는 등 비슷한 개념을 더 복잡하게 정의하고 있다고 생각해 최종적으로는 선택하지 않았습니다. (사업 초기에 Mithril을 선택한 이유도 비슷했습니다. React, RxJS등에서 제게 필요한 최소한의 기능만 작은 코드 베이스로 제공했습니다.)</p>
<p>Jotai 사용법은 단순합니다. 원하는 상태가 있으면 atom으로 정의하고, useState 대신, useAtom을 사용하면 됩니다. 그러면 다른 컴포넌트에서도 useAtom을 통해 그 값을 얻거나 변경할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">atom</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jotai&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">count_atom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">Counter</span>: <span class="kt">FC</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">count</span><span class="p">,</span> <span class="nx">setCount</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useAtom</span><span class="p">(</span><span class="nx">count_atom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>액션(로직)의 경우 쓰기 전용 atom으로 정의하면 됩니다. 값을 담은 변수는 snake_case, 함수는 camelCase로 정의하는 저희 컨벤션에 따라 로직을 담은 atom은 camelCase로 정의합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">incCountAtom</span> <span class="o">=</span> <span class="nx">atom</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="kr">get</span><span class="p">,</span> <span class="kr">set</span><span class="p">,</span> <span class="nx">inc</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">set</span><span class="p">(</span><span class="nx">count_atom</span><span class="p">,</span> <span class="kr">get</span><span class="p">(</span><span class="nx">count_atom</span><span class="p">)</span> <span class="o">+</span> <span class="nx">inc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">Counter</span>: <span class="kt">FC</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">incCount</span> <span class="o">=</span> <span class="nx">useUpdateAtom</span><span class="p">(</span><span class="nx">incCountAtom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>그냥 정의하면 모든 atom은 전역으로 공유됩니다. 독립된 공간이 필요하다면 Provider로 감싸주면 됩니다. 이번에 만든 어플리케이션은 대부분 Next.js 페이지 단위로 상태를 관리하고 있어서 페이지 컴포넌트를 Provider로 감싸서 사용하고 있습니다.</p>
<p>다음 글에서는 Jotai 활용에 대해 좀 더 자세히 설명하도록 하겠습니다.</p>

        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2021-07-31-1-graphql-error-guide/'>GraphQL 에러 처리 규칙</a></h2>
          <p class='posts-date'>31 Jul 2021</p>
        </div>
        <div class='panel-body'>
          <p>Java로 코드를 작성해보신 분이라면 throws에 의해 컴파일 에러가 발생했을 때 뭔지는 잘 모르겠고 IDE가 제시한 대로 catch로 감싸고 넘어간 경험이 누구에게나 있을 것이라 생각합니다. 그만큼 예외 상황은 잘 이해하고 적절히 처리하기는 쉽지 않은 것 같습니다. 오늘은 카카오스타일이 사용하고 있는 GraphQL에서 에러를 어떻게 전달하고 처리하고 있는지 설명하려고 합니다.</p>
<h2 id="graphql-에러-형식">GraphQL 에러 형식</h2>
<p>GraphQL은 다음과 같은 데이터를 반환합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;root_field&#34;</span><span class="p">:</span> <span class="err">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errors&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;error message&#34;</span><span class="p">,</span> <span class="nt">&#34;locations&#34;</span><span class="p">:</span> <span class="p">[],</span> <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="p">[]</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>GraphQL을 처음 접했을 때는 errors가 배열이라는 것을 이해하지 못했습니다. 그래서 다음과 같이 API를 설계하는 실수를 하기도 합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-graphql" data-lang="graphql"><span class="line"><span class="cl"><span class="kd">type</span><span class="w"> </span><span class="nc">Mutation</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="py">authenticate</span><span class="p">(</span><span class="kd">input</span><span class="p">:</span><span class="w"> </span><span class="nc">AuthenticateInput</span><span class="p">!):</span><span class="w"> </span><span class="nc">AuthenticateResult</span><span class="p">!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nc">type</span><span class="w"> </span><span class="py">AuthenticateResult</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="py">success</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="py">user_id</span><span class="p">:</span><span class="w"> </span><span class="nc">ID</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="py">error_code</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>errors가 배열인 이유는 명확합니다. GraphQL은 여러 데이터를 한번에 요청할 수 있는데, 그 중 일부 데이터만 반환하는 것이 가능합니다. 반환에 실패에 한 경우 그 이유(데이터 없음, 권한 없음등)를 반환해야 하는데 그 이유가 여러가지 일 수 있는 것이죠.</p>
<p>현재 카카오스타일은 에러 발생시 errors에 데이터를 채워서 반환합니다. 다만 에러가 여러개인 경우 적절한 처리방법을 알지 못해 첫번째 에러만 유의미하게 처리합니다. API에 따라 null을 반환할 수도 있기 때문에 data 필드가 null인 것을 에러로 처리하지는 않고 errors 배열에 데이터가 하나 이상있으면 에러로 처리합니다. 반대로 errors 배열에 데이터가 있으면 data 필드에 값이 있어도 에러로 처리하고 있습니다.</p>
<h2 id="message-필드와-에러-코드">message 필드와 에러 코드</h2>
<p>사용자에게는 사용자 친화적인 에러 메시지를 표시해줘야 합니다. 이 메시지를 어디서 관리해야 하는지도 쟁점입니다.</p>
<p>같은 상황이여도 사용자마다 다른 메시지가 필요할 수도 있고, UI 이슈라고 보면 클라이언트에서 관리하는게 맞을 것 같기도 합니다만, 클라이언트는 수정이 어렵다라는 이슈가 있습니다. (특히 앱인 경우) 또한 에러 상황마다 일일이 분기 처리를 해야 합니다. 테이블로 메시지를 관리할 수도 있습니다만 어떤 에러 메시지는 고정 메시지가 아닐 수도 있습니다. (예, xxx 상품은 구매할 수 없습니다)</p>
<p>이런 이유로 에러 메시지는 서버가 관리하고 있습니다. 클라이언트는 대부분의 경우 서버가 보내주는 에러 메시지를 맥락에 대한 이해없이 그대로 보여주는 식으로 동작합니다. 다만 이 경우 다국어 처리에 대한 고민이 필요합니다. 클라이언트가 에러 메시지를 처리하면 클라이언트 언어를 인식해서 적절한 메시지를 표시할 수 있지만, 서버는 클라이언트에게서 언어 정보를 받아서 요청별로 에러 메시지를 다르게 구성하는 처리를 해야 합니다.</p>
<p>일부 에러 상황은 클라이언트가 특별히 처리를 해야 할 수도 있습니다. (예를 들어 로그인이 안 되어 있다는 에러를 만난 경우 로그인 페이지로 이동) 이런 경우 사용자 친화적인 메시지를 보고 처리하는 것은 무리기 때문에 (특히 언어마다 메시지가 다르다면) 에러 코드도 같이 보내야 합니다.</p>
<p>GraphQL 에러 형식에서 message 필드에는 사용자 친화적인 메시지를 담고 있습니다. 에러 코드에 대한 표준은 없기 때문에 extensions에 담아서 반환해야 합니다. 다음은 이 형식에 따른 에러 메시지 예입니다</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errors&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;로그인을 해주세요.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;extensions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="s2">&#34;auth_not_logged_in&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="추가-정보">추가 정보</h2>
<p>에러 메시지와 에러 코드만 있어도 대부분은 문제가 없지만 추가 정보가 필요한 경우가 있습니다. 이런 정보는 extensions에 담고 있습니다.</p>
<p>에러가 발생할 경우 로그에는 주어진 에러 코드로 에러를 기록합니다. 에러 코드가 있다고 모두 오류 상황은 아니고 프로세스상 일상적으로 발생할 수 밖에 없는 에러가 있기도 합니다. 사용자에게는 에러를 반환하는 것이 맞지만, 모니터링에서는 에러로 취급하지 않을 에러인 경우 ignorable 란 필드를 true 로 설정하고 있습니다.</p>
<p>어떤 클라이언트/상황에서는 단순히 에러 메시지가 아니라 더 많은 정보를 표시하고 싶을 수도 있습니다. (예를 들어 에러 팝업 타이틀이나, 아이콘, 닫기 버튼 메시지등) 이런 경우를 위해 <code>contents?: { type: string; title: string; message: string; link_title?: string; link_url?: string };</code> 와 같이 스키마를 정해서 소통하는 API도 있습니다. (전반적으로 적용해도 될 것 같지만 아직 표준화가 덜 됐습니다)</p>
<p>어떤 에러는 부가적인 정보가 필요한 경우가 있습니다. 예를 들어 소셜 로그인시 이미 해당 이메일의 계정이 존재할 수 있습니다. 이메일이 같다고 무조건 로그인을 시키면 안 되고, 대신 사용자에게 이메일이 이미 사용중이니 해당 계정으로 로그인을 시도하도록 유도하기로 했고, 이를 위해 마스킹된 이메일 문자열을 email 필드에 담아서 반환하도록 했습니다.</p>
<h2 id="http-상태-코드">HTTP 상태 코드</h2>
<p>GraphQL 스펙은 전달 방식에 대해 정의하고 있지 않지만 일반적으로는 HTTP 프로토콜을 사용합니다. 이때 HTTP 상태 코드를 사용할지 여부도 쟁점입니다.</p>
<p>처음 GraphQL 서빙을 위해 사용했던 <a href="https://www.npmjs.com/package/express-graphql">express-graphql</a>는 에러시 500 에러를 반환했습니다. 그 다음으로 사용한 <a href="https://www.npmjs.com/package/apollo-server-express">apollo-server-express</a>는 에러 상황에서도 200을 반환해서 약간의 혼란이 있었습니다.</p>
<p>현재 논의가 진행 중인 <a href="https://github.com/graphql/graphql-over-http">스펙</a>에서는 2xx이 아닌 에러를 반환하는 것으로 진행되고 있습니다만 (부분 성공의 경우는 200이여야 합니다) 카카오스타일에서는 현재 무조건 200을 반환하는 것으로 정했습니다.</p>
<p>GraphQL 문법에 어긋나는 경우에만 400 에러 등을 반환하고, 내부 리졸버를 정상적으로 수행한 경우에는 200입니다. 비지니스 로직의 실패는 HTTP 상태 코드가 아닌 errors 필드를 보고 판단하게 됩니다.</p>
<p>다만 앞으로 바뀔 여지가 있기에 HTTP 상태 코드를 의존하지 않는 형태로 클라이언트를 작성하고 있습니다.</p>

        </div>
      </div>
      
    </div>

    
<div class='col-xs-12 text-center'>
  
  <ul class='pagination'>
    
    <li><a href='/ko/tech/'>&laquo; 처음</a></li>
    <li><a href='/ko/tech/page/3/'>&lt; 이전</a></li>
    

    
    <li class='disabled'><span>&hellip;</span></li>
    

    
    
    
    
    
    
    
    
    
    <li><a href='/ko/tech/page/2/'>2</a></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/3/'>3</a></li>
    
    
    
    
    
    <li class='active'><span>4</span></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/5/'>5</a></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/6/'>6</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    <li class='disabled'><span>&hellip;</span></li>
    

    
    <li><a href='/ko/tech/page/5/'>다음 &gt;</a></li>
    <li><a href='/ko/tech/page/16/'>끝 &raquo;</a></li>
    
  </ul>
  
</div>

  </div>

</div>

<div class='container-fluid'>
  <hr>
  <footer>
    <p>
      &copy; 2014-2021 Sangmin Yoon
      <span class='pull-right text-muted'>
        powered by
        <a href='https://gohugo.io/' target='_blank'>Hugo</a>
        ,
        <a href='http://getbootstrap.com/' target='_blank'>Bootstrap</a>
        ,
        <a href='http://www.dnsever.com' target='dnsever'><img src='http://banner.dnsever.com/dnsever-banner_62x15.gif'
            border='0' alt='DNS server, DNS service '></a>
      </span>
    </p>
  </footer>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-48366784-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script src='https://code.jquery.com/jquery-1.12.4.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>

</body>

</html>
