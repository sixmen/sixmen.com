<!DOCTYPE html>
<html lang='ko'>
<head>
  <meta charset='utf-8'>

  
    <title>sixmen.com: Tech</title>
  
  
  <meta name='author' content='Sangmin Yoon'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>

  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'>
  <link href='/css/style.css?body=1' rel='stylesheet' type='text/css' media='all'>
  <link href='/css/pygments.css?body=1' rel='stylesheet' type='text/css' media='all'>

  <!--[if lt IE 9]>
    <script src='https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js'></script>
    <script src='https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js'></script>
  <![endif]-->
</head>
<body>

<div class='hp-navbar'>
  <div class='container-fluid'><div class='row'><div class='col-xs-12'>
    
    <nav class='hp-nav'>
      <a class='hp-nav-item' href='/ko/'>Home</a>
      <a class='hp-nav-item' href='/ko/mylife/'>MyLife</a>
      <a class='hp-nav-item' href='/ko/travel/'>Travel</a>
      <a class='hp-nav-item active' href='/ko/tech/'>Tech</a>
      <a class='hp-nav-item' href='/ko/tags/'>Tags</a>
      <a class='hp-nav-item pull-right' href='/en/'>English</a>
    </nav>
  </div></div></div>
</div>





<div class='container'>

<div class='row' style='margin-top: 20px;'>

<div class='col-sm-10 col-sm-offset-1'>
  
  <div class='panel panel-default'>
    <div class='panel-heading'>
      <h2 class='posts-title'><a href='/ko/tech/2017-02-08-1-why-croquis-selects-nodejs/'>크로키가 Node.js를 선택한 이유</a></h2>
      <p class='posts-date'>08 Feb 2017</p>
    </div>
    <div class='panel-body'>
      <p>현재 크로키에서는 서버용 웹 프레임워크로 <a href="http://nodejs.org/">Node.js</a> 위에서
<a href="http://expressjs.com/">Express</a>를 사용하고 있습니다.</p>

<p>이번 글에서는 어떤 이유로 Node.js를 사용하게 되었는지 설명하려고 합니다.
여러분들이 웹 프레임워크를 선택하시는 데 참고가 되었으면 합니다.</p>

<hr />

<p>크로크닷컴을 설립한 것은 2012년 2월입니다.
회사를 차리면서 구상했던 것은 SNS 성격을 가진 서비스로 당연히 서버가 필요했습니다.
서버 프로그래밍은 2004년 무렵 Tomcat을 잠깐 써본 것이 전부였기 때문에
어떤 언어/프레임워크를 써야 하는지부터가 고민의 시작이었습니다.</p>

<p>몇 가지 후보군이 있었던 것으로 기억합니다.</p>

<p>첫 번째는 국내 웹에서 이미 많이 사용하고 있던 PHP입니다.</p>

<p>두 번째는 국내에서 또 많이 사용하는 ASP입니다.</p>

<p>세 번째는 대형 서비스에서 많이 사용하는 스프링입니다.
지금도 이력서를 받아보면 스프링을 사용/공부했다는 사람들이 종종 보입니다.</p>

<p>네 번째는 <a href="http://rubyonrails.org/">루비 온 레일즈</a>입니다.</p>

<p>마지막이 <a href="http://nodejs.org/">Node.js</a>입니다.
회사 설립 당시에 버전이 0.6이었는데, 국내에 책도 나오면서
이곳저곳에서 화제가 되었기에 살펴보았습니다.</p>

<p>그 외에 <a href="https://www.djangoproject.com/">장고</a>도 스타트업에서 많이 쓰이고
이력서에 장고를 사용했다는 사람이 심심치 않게 보이는데, 2012년 당시에
보면서도 그냥 지나쳤던 건지 널리 쓰이지 않았던 것인지 정확히 기억나지는 않지만,
후보로 고려하지 않았던 것 같습니다.</p>

<hr />

<p>PHP는 언어로서 완성도가 떨어진다고 생각하고 있었기에 배제를 했습니다.
또한, 서버로는 당연히 리눅스를 생각했기에 ASP도 바로 배제되었습니다.</p>

<p>스프링은 조금 고민이 되었지만, Tomcat을 통한 경험이 좋지 않아서
컴파일해서 배포해야 하는 프레임워크를 후보에서 제외했습니다.
(Tomcat과 스프링이 뭐가 다른 건지 잘 모르고,
10년 동안 많이 발전했을 수도 있지만, 워낙 거부감이 컸습니다.)</p>

<p>레일즈에 대해서는 지인에게 회의 중에 나온 내용을
바로바로 구현해가면서 확인해봤다는 무용담(?)을 들었던 적이 있고
2007년에 관련 책도 산 적이 있기에 (잘 보지는 않았지만),
일단 후보로 두었습니다.</p>

<p>Node.js는 당시에 여러 곳에서 빠르다는 이유로 주목받고 있었기에
레일즈와 두개를 주요 후보로 설정했습니다.</p>

<hr />

<p>정확히 비교하자만 레일즈=Express 이고, 루비=Node.js 겠죠.
레일즈는 이미 많은 기능이 있었고,
Express는 그에 비하면 단순한 기능만을 지원했습니다.
아마 저희가 웹 서비스를 만들려고 했다면 레일즈를 골랐을 수도 있습니다.
하지만 저희는 앱만 생각하고 있었기에 웹 프로토콜(HTTP) 요청만
처리할 수 있으면 됐습니다.
그리고 반대중적(?) 성격이 조금 있어서 레일즈가 제시하는 대로
프로그램을 만들어야 한다는 것이 썩 맘에 들지는 않았습니다.</p>

<p>그러나 무엇보다 Node.js를 선택한 결정적인 이유는 이벤트 주도 방식 때문입니다.
대학교에서 공부할 무렵부터 스레드와 락 개념을 별로 좋아하지 않았습니다.
스레드는 컨텐스트 전환에 불필요한 비용이 많이 든다고 생각했고,
데이터를 보호하기 위해서 락이 필요한데 문제 없이 작성하는 것이 어렵다고 봤습니다.
거기에 이벤트 주도 방식으로 단일 스레드에서 동작한다는 것이 제 취향에 맞았습니다.</p>

<p>Node.js를 선택하는데 당시 얘기가 많던 성능 문제는 크게 고려상황은 아니였습니다.
이벤트 주도 방식때문에 스레드 방식보다는 성능이 잘 나오는게 당연하다는 생각이 있었고,
다른 언어에서도 이벤트 주도 방식을 사용한다면 성능 차이는 그렇게 나지 않을 거라고 봤습니다.
(비슷하게 작성한다면 Java 같은 컴파일 언어가 당연히 성능이 좋을 것이라 생각했습니다.)
실제로 Node.js가 아니더라도 이벤트 주도 방식을 쓰는 Netty난 Twisted 같은 것도 이미 존재했습니다.
Node.js 가 뜬 이후에 나온 Vert.x 같은 것도 있고요.</p>

<hr />

<p>그럼에도 불구하고 Node.js를 선택한 것은 JavaScript라는 언어때문입니다.</p>

<p>프로토타입을 통한 상속이라던지,
this 바인딩등 보편적인 언어들과 다른 특성들 때문에 익히기 어려웠기에
사실 그다지 JavaScript는 좋아하는 언어는 아니였습니다.</p>

<p>일반적인 언어라면 어떤 것을 사용해서도 모든 일을 할 수 있다고 생각하고 있지만,
언어의 표현력에 따라 난이도는 달라집니다.
그런면에서 JavaScript는 개념이 색다르거나 잘못되어서(변수 스코프같은 경우),
제대로 사용하지 못하고 실수하기 좋은 언어라는 생각이 있었습니다.</p>

<p>하지만 이벤트 주도 방식에 대해서는 큰 장점이 있었습니다.
태생이 JavaScript는 브라우저 언어였기에 스레드에 대한 개념이 원래 고려되어 있지 않습니다.
(요새는 웹 워커 같은 것이 추가되고 있지만)
따라서 Node.js의 API는 모두 비동기적으로 동작하게 설계가 되어 있습니다.
반면 Java나 Python등의 언어에서는 이벤트 주도 방식으로 처리를 하려면,
원래 사용하던 API를 사용하면 안 되고 Java NIO나 Python asyncio 같은 것을 사용해야 합니다.</p>

<p>저는 이 차이가 제일 중요하다고 판단했습니다.
이벤트 주도 방식으로 서버를 작성하려면 블로킹 I/O를 사용하면 안 되는데,
언어/플랫폼 적으로 기본이 블로킹 I/O라면 의도치 않게 사용할 확률이 높다고 봤습니다.</p>

<hr />

<p>결론적으로 서버에는 이벤트 주도 방식이 가장 좋다고 생각했는데,
언어/플랫폼 태생적으로 이벤트 주도 방식인 Node.js를 사용하는 것이 맞다고 판단했습니다.</p>

<p>JavaScript의 단점은 CoffeeScript를 사용하는 것으로 회피했습니다.
다만 프로젝트가 커질 수록 형검사에 대한 요구가 커져서 TypeScript로
이전하는 것을 계속 고려중입니다.</p>

<p>콜백의 어려움은 초반에는 <a href="https://github.com/caolan/async">async</a>로,
현재는 Promise를 사용해서 피하고 있습니다.
TypeScript로 이전한 후에는 async/await를 사용해볼 예정입니다.</p>

<p>스프링이나 레일즈, 장고등에 비해 구인에 어려움은 조금 있지만,
현재는 Node.js를 선택한 것에 만족하고 있습니다.</p>

    </div>
  </div>
  
  <div class='panel panel-default'>
    <div class='panel-heading'>
      <h2 class='posts-title'><a href='/ko/tech/2017-01-15-1-process-unix-pipe-with-nodejs/'>Node.js로 유닉스 파이프 처리하기</a></h2>
      <p class='posts-date'>15 Jan 2017</p>
    </div>
    <div class='panel-body'>
      

<p>크로키에서는 로그를 JSON 문자열로 만들어 일자별(혹은 시간별)로 묶은 후
gzip으로 압축해서 저장하고 있습니다.
그런데 이미 만들어진 로그를 수정해야 하는 일이 생겼습니다.</p>

<p>예를 들면</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="p">{</span><span class="s2">&quot;date&quot;</span><span class="o">:</span><span class="s2">&quot;Fri Jan 15 2016 00:00:01 GMT+0000 (UTC)&quot;</span><span class="p">,</span><span class="s2">&quot;path&quot;</span><span class="o">:</span><span class="s2">&quot;/foobar&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;date&quot;</span><span class="o">:</span><span class="s2">&quot;Fri Jan 15 2016 00:00:03 GMT+0000 (UTC)&quot;</span><span class="p">,</span><span class="s2">&quot;path&quot;</span><span class="o">:</span><span class="s2">&quot;/croquis&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;date&quot;</span><span class="o">:</span><span class="s2">&quot;Fri Jan 15 2016 00:00:10 GMT+0000 (UTC)&quot;</span><span class="p">,</span><span class="s2">&quot;path&quot;</span><span class="o">:</span><span class="s2">&quot;/awesome&quot;</span><span class="p">}</span>
</code></pre></div>


<p>였던 데이터를</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="p">{</span><span class="s2">&quot;date&quot;</span><span class="o">:</span><span class="s2">&quot;2016-01-15T00:00:01.000Z&quot;</span><span class="p">,</span><span class="s2">&quot;path&quot;</span><span class="o">:</span><span class="s2">&quot;/foobar&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;date&quot;</span><span class="o">:</span><span class="s2">&quot;2016-01-15T00:00:03.000Z&quot;</span><span class="p">,</span><span class="s2">&quot;path&quot;</span><span class="o">:</span><span class="s2">&quot;/croquis&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;date&quot;</span><span class="o">:</span><span class="s2">&quot;2016-01-15T00:00:10.000Z&quot;</span><span class="p">,</span><span class="s2">&quot;path&quot;</span><span class="o">:</span><span class="s2">&quot;/awesome&quot;</span><span class="p">}</span>
</code></pre></div>


<p>처럼 바꿔야 했습니다.</p>

<p>로그 전체를 읽어와서 줄별로 변환하고 다시 기록하면 되는 일이지만
로그가 커서 잘 동작하지 않았습니다.</p>

<p>그래서 유닉스의 파이프 형태로 처리하기로 했습니다.</p>

<p>위의 작업을 하는 Node.js 프로그램은 다음과 같습니다.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kr">const</span> <span class="nx">byline</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;byline&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">byline</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdin</span><span class="p">);</span>
<span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
  <span class="nx">data</span><span class="p">.</span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">date</span><span class="p">).</span><span class="nx">toISOString</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
<span class="p">});</span>
</code></pre></div>


<p><a href="https://github.com/jahewson/node-byline">byline</a>은 스트림을 줄별로 처리할 수 있게 해주는 모듈입니다.
줄별로 들어온 JSON 문자열을 파싱하고 원하는 처리를 한 후 다시 쓰기만 하는 단순한 코드입니다.
이 프로그램을 유닉스 파이프라인에 넣으면 원하는 결과를 얻을 수 있습니다.</p>

<p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ gunzip -c original/01.data.gz <span class="p">|</span> node convert.js <span class="p">|</span> gzip &gt; converted/01.data.gz
</code></pre></div>
</p>

<h3 id="보너스">보너스</h3>

<p>이 작업을 순수히 Node.js만 가지고도 할 수 있습니다.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;stream&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">zlib</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;zlib&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">byline</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;byline&#39;</span><span class="p">);</span>

<span class="kr">class</span> <span class="nx">Convert</span> <span class="kr">extends</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">Transform</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">_transform</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">date</span><span class="p">).</span><span class="nx">toISOString</span><span class="p">();</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">&#39;original/01.data.gz&#39;</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">zlib</span><span class="p">.</span><span class="nx">createGunzip</span><span class="p">())</span>
  <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">byline</span><span class="p">())</span>
  <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="k">new</span> <span class="nx">Convert</span><span class="p">())</span>
  <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">zlib</span><span class="p">.</span><span class="nx">createGzip</span><span class="p">())</span>
  <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="s1">&#39;converted/01.data.gz&#39;</span><span class="p">));</span>
</code></pre></div>


<p>하지만 파이프의 특성상 하나의 프로그램이 하나의 작업만
할 수록 응용하기가 편해집니다.
예를 들어 파일이 로컬에 있는게 아니고 S3에 있다면
유닉스 파이프로는 다음과 같이 바꾸면 됩니다.</p>

<p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ aws s3 cp s3://mybucket/stream.txt - <span class="p">|</span> gunzip <span class="p">|</span> node convert.js <span class="p">|</span> gzip &gt; converted/01.data.gz
</code></pre></div>
</p>

<p>Node.js로도 작성할 수 있지만 훨씬 많은 코드를 작성해야겠죠.</p>

    </div>
  </div>
  
  <div class='panel panel-default'>
    <div class='panel-heading'>
      <h2 class='posts-title'><a href='/ko/tech/2017-01-06-3-github-wiki-to-slack-setup-github-hook/'>GitHub 위키 이벤트를 슬랙으로 받기 - 4. GitHub 웹훅 연결하기</a></h2>
      <p class='posts-date'>06 Jan 2017</p>
    </div>
    <div class='panel-body'>
      <p>이제 GitHub 웹훅을 처리할 수 있게 됐습니다.
<a href='/ko/tech/2017-01-06-2-github-wiki-to-slack-aws-api-gateway/'>이전 글</a>에서
생성한 URL을 GitHub에 설정해줍니다.</p>

<p>GitHub 저장소의 Settings 탭에 가면 Webhooks 메뉴가 있습니다. 여기서 웹훅을 추가할 수 있습니다.</p>

<p><img src="/img/ko/tech/2017-01-06-3-01.jpg" alt="Add webhook" /></p>

<p>아래 부분에서 웹훅을 통해 받을 이벤트를 설정할 수 있습니다.
다른 이벤트는 이미 받고 있으므로 여기서는 Gollum(GitHub 위키 엔진) 이벤트만 체크해줍니다.</p>

<p><img src="/img/ko/tech/2017-01-06-3-02.jpg" alt="Select events" /></p>

<p>위키에 변경을 가하면 'Recent Deliveries' 섹션에 그 내용이 보여집니다.
Lambda 함수가 GitHub 위키 이벤트를 의도한대로 처리하는지 테스트하기 위해
이 내용을 사용할 있습니다.
AWS Lambda 편집화면에서 Actions -&gt; Configure test event 에서 입력할 수 있습니다.</p>

<p>다음은 최종 Lambda 코드입니다.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;aws-sdk&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">hookUrl</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">hookUrl</span><span class="p">);</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span><span class="p">;</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Content-Length&#39;</span><span class="o">:</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">https</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">resolve</span><span class="p">({</span>
          <span class="nx">statusCode</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">decryptHookUrl</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">hookUrl</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">hookUrl</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">kms</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">KMS</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">encryptedHookUrl</span><span class="p">,</span> <span class="s1">&#39;base64&#39;</span><span class="p">);</span>
      <span class="nx">kms</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">({</span> <span class="nx">CiphertextBlob</span><span class="o">:</span> <span class="nx">blob</span> <span class="p">},</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">hookUrl</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">Plaintext</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">);</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">hookUrl</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">processGithubPayload</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kr">const</span> <span class="nx">repo</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nx">full_name</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">page_link</span> <span class="o">=</span> <span class="nx">page</span><span class="p">.</span><span class="nx">html_url</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="nx">page</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">sender_link</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nx">html_url</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nx">login</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;github wiki&#39;</span><span class="p">,</span>
    <span class="nx">text</span><span class="o">:</span> <span class="sb">`[</span><span class="si">${</span><span class="nx">repo</span><span class="si">}</span><span class="sb">] &lt;</span><span class="si">${</span><span class="nx">page_link</span><span class="si">}</span><span class="sb">&gt; is </span><span class="si">${</span><span class="nx">page</span><span class="p">.</span><span class="nx">action</span><span class="si">}</span><span class="sb"> by &lt;</span><span class="si">${</span><span class="nx">sender_link</span><span class="si">}</span><span class="sb">&gt;`</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">decryptHookUrl</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">processGithubPayload</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
    <span class="nx">message</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="s1">&#39;#auto-github&#39;</span><span class="p">;</span>
    <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
</code></pre></div>


<p>이제 위키를 수정하고 슬랙에 메시지가 표시되는 것을 확인하면 끝입니다.
수정내역이나 커밋 메시지를 표시해주면 좋은데 아쉽게도 해당 데이터는 없는 것 같습니다.</p>

    </div>
  </div>
  
</div>


<div class='col-xs-12 text-center'>
  
  <ul class='pagination'>
    
      <li class='disabled'><span>&laquo; 처음</span></li>
      <li class='disabled'><span>&lt; 이전</span></li>
    

    

    
      
      
      
        <li class='active'><span>1</span></li>
      
    
      
      
      
        <li><a href='/ko/tech/page/2/'>2</a></li>
      
    
      
      
      
        <li><a href='/ko/tech/page/3/'>3</a></li>
      
    
      
      
      
      
    
      
      
      
      
    
      
      
      
      
    
      
      
      
      
    
      
      
      
      
    

    
    
      <li class='disabled'><span>&hellip;</span></li>
    

    
      <li><a href='/ko/tech/page/2/'>다음 &gt;</a></li>
      <li><a href='/ko/tech/page/8/'>끝 &raquo;</a></li>
    
  </ul>
  
</div>


</div>

</div>

<div class='container-fluid'>
  <hr>
  <footer>
    <p>
      &copy; 2014-2016 Sangmin Yoon
      <span class='pull-right text-muted'>
        powered by
        <a href='https://gohugo.io/' target='_blank'>Hugo</a>
        ,
        <a href='http://getbootstrap.com/' target='_blank'>Bootstrap</a>
        ,
        <a href='http://www.dnsever.com' target='dnsever'><img src='http://banner.dnsever.com/dnsever-banner_62x15.gif' border='0' alt='DNS server, DNS service '></a>
      </span>
    </p>
  </footer>
</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-48366784-1', 'auto');
ga('send', 'pageview');
</script>

<script src='https://code.jquery.com/jquery-1.12.4.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>

</body>
</html>

