<!DOCTYPE html>
<html lang='ko'>

<head>
  <meta charset='utf-8'>

  
  <title>sixmen.com: Tech</title>
  
  
  <meta name='author' content='Sangmin Yoon'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>

  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'>
  <link href='/css/style.css?body=1' rel='stylesheet' type='text/css' media='all'>
  <link href='/css/syntax.css?body=1' rel='stylesheet' type='text/css' media='all'>

  <!--[if lt IE 9]>
  <script src='https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js'></script>
  <script src='https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js'></script>
  <![endif]-->
</head>

<body>
<div class='hp-navbar'>
  <div class='container-fluid'>
    <div class='row'>
      <div class='col-xs-12'>
        
        <nav class='hp-nav'>
          <a class='hp-nav-item'
            href='/ko/'>Home</a>
          <a class='hp-nav-item'
            href='/ko/mylife/'>MyLife</a>
          <a class='hp-nav-item'
            href='/ko/travel/'>Travel</a>
          <a class='hp-nav-item active'
            href='/ko/tech/'>Tech</a>
          <a class='hp-nav-item'
            href='/ko/tags/'>Tags</a>
          <a class='hp-nav-item pull-right' href='/en/'>English</a>
        </nav>
      </div>
    </div>
  </div>
</div>



<div class='container'>

  <div class='row' style='margin-top: 20px;'>

    <div class='col-sm-10 col-sm-offset-1'>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-04-09-1-esm-problem/'>ESM 삽질기</a></h2>
          <p class='posts-date'>09 Apr 2022</p>
        </div>
        <div class='panel-body'>
          <p>저희는 주기적으로 Node.js 모듈을 최신 버전으로 업데이트하고 있습니다.
Node.js를 10년째 사용 중인데, CoffeeScript → TypeScript, 콜백 → Async.js → Promise(&amp; async, await) 전환 하면서 몇 번 혼란의 시기가 있었습니다.
하지만 모듈 시스템은 쭉 이어져왔습니다.
그런데 최근에 이 모듈 시스템에 큰 변화가 생겼고 기존 변화와 다르게 양립이 잘 안 되서 모듈 업데이트를 제대로 못 하고 있습니다.
이 문제를 일으킨 ESM이 뭐고 어떤 작업이 필요한지 알아보려고 합니다. (개인적으로 만족하는 깔끔한 해결책이 나오지 못했습니다)</p>
<h2 id="발생하는-문제">발생하는 문제</h2>
<p><a href="https://www.npmjs.com/package/chalk">chalk</a> 란 모듈이 5.0으로 가면서 Pure ESM 모듈이 됐습니다. 이를 가져다 쓰면 다음과 같은 에러가 발생합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">chalk</span> <span class="kr">from</span> <span class="s1">&#39;chalk&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">yellow</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">));</span>
</span></span></code></pre></div><pre tabindex="0"><code>Error [ERR_REQUIRE_ESM]: require() of ES Module /a/node_modules/chalk/source/index.js from /a/a.ts not supported.
Instead change the require of index.js in /a/a.ts to a dynamic import() which is available in all CommonJS modules.
</code></pre><h2 id="esm이란-무엇인가">ESM이란 무엇인가?</h2>
<p>초기 JavaScript는 모듈 시스템이 없었습니다.
클라이언트쪽에서는 <a href="https://requirejs.org/">Require.js</a>란 것이 많이 쓰였습니다.
한편 서버(Node.js)에서는 CommonJS가 적용되어 따로 발전을 했습니다.
라이브러리가 클라이언트, 서버를 모두 지원하기 위한 <a href="https://stackoverflow.com/questions/16521471/relation-between-commonjs-amd-and-requirejs">패턴들이 개발</a>되어 적용됐던 기억이 나네요.
그후 <a href="https://browserify.org/">Browserify</a>, <a href="https://webpack.js.org/">webpack</a> 같은 번들 시스템이 나오면서 CommonJS 쪽으로 통일되었습니다.</p>
<p>대부분의 경우 잘 동작하지만 뭔가 문제가 있으시까 새로운 시스템이 나왔겠죠? 상세한 히스토리는 잘 모르지만 제가 아는 CommonJS의 가장 큰 문제는 런타임에 모듈을 읽는 다는 것입니다.
다음 예를 보겠습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="c1">// a.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./b&#39;</span><span class="p">).</span><span class="nx">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;a2&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">exports</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// b.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;b1&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./a&#39;</span><span class="p">).</span><span class="nx">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;b2&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">exports</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ node a.js 
</span></span><span class="line"><span class="cl">a1
</span></span><span class="line"><span class="cl">b1
</span></span><span class="line"><span class="cl">undefined
</span></span><span class="line"><span class="cl">b2
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl">a2
</span></span></code></pre></div><p>위의 예에서 보다시피 require는 그 줄에 다다를 때 실행됩니다.
순환 참조가 발생하는 경우(<code>require('./a')</code>) 모듈을 다시 읽지는 않습니다.
이때문에 주의를 기울이지 않으면 위 예처럼 모듈이 내보낸 값이 얻어지지 않는 문제가 발생할 수 있습니다.</p>
<p>TypeScript의 import문은 사실 require로 변환되는 코드이기 때문에 기존 컴파일 언어에 익숙하신 분이 보면 당황할만한 부분이 좀 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// a.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">b</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;./b&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;a2&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// b.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;b1&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">a</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;./a&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;b2&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span></code></pre></div><pre tabindex="0"><code>$ ts-node a.ts 
a1
b1
undefined
b2
2
a2
</code></pre><p>아마 이런 저런 이유 때문에 <a href="https://nodejs.org/api/esm.html">ESM</a>이란 것이 나왔으리라 생각합니다.
(몇년전에 <code>.cjs</code>, <code>.mjs</code> 확장자 얘기가 나오는 글들 보면서 무슨 얘기가 진행되는 거야 라고 넘어간 기억이 있습니다.)</p>
<p>async/await 문법이 나온 이후에 가장 아쉬운 점 중 하나가 최상위 단계에서 await가 불가능하다는 것입니다.</p>
<pre tabindex="0"><code>$ cat a.js                                                                                                                                                                         1 ↵
await Promise.resolve(1);
$ node a.js 
/a/a.js:1
await Promise.resolve(1);
^^^^^

SyntaxError: await is only valid in async functions and the top level bodies of modules
</code></pre><p>따라서 함수를 만들거나 <a href="https://developer.mozilla.org/ko/docs/Glossary/IIFE">IIFE</a>를 사용해야 했습니다.
이것은 CommonJS의 한계로 인한 것이고 ESM에서는 가능해졌습니다.
이런 이유도 있어서 CommonJS에서 ESM 모듈을 require 하는 것이 불가능합니다.
반대로 ESM 모듈에서 CommonJS 모듈을 읽는 것은 가능하지만 신경써야 할 것들이 있습니다.</p>
<p>이렇게 ESM이 만들어진 후에 Sindre Sorhus란 분이 <a href="https://blog.sindresorhus.com/get-ready-for-esm-aa53530b3f77">ESM 전환을 선언</a>했습니다.
그리고 이 분이 만드는 많은 모듈들(예 <a href="https://www.npmjs.com/package/file-type">file-type</a>.
<a href="https://www.npmjs.com/~sindresorhus">npm 개인 홈</a>에 들어가보면 1165개의 모듈에 관여하고 있다고 나오네요)이 <a href="https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c">Pure ESM</a> 모듈로 전환됐습니다.
Pure ESM은 모듈이 CommonJS/ESM 양쪽을 지원하도록 구성할 수도 있지만, 굳이 ESM만 제공한다는 뜻입니다.</p>
<p>문제는 CommonJS 프로젝트에서는 ESM 모듈을 불러오는 것이 불가능하다는 것에 있습니다.
따라서 프로젝트가 ESM으로 전환해야지만 Pure ESM 모듈을 사용할 수 있습니다.</p>
<h2 id="무엇이-문제인가">무엇이 문제인가?</h2>
<h3 id="typescript에서-원인-찾기">TypeScript에서 원인 찾기</h3>
<p>위 예제에서 다시 시작하겠습니다</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">chalk</span> <span class="kr">from</span> <span class="s1">&#39;chalk&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">yellow</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">));</span>
</span></span></code></pre></div><p>ts-node로 실행해보면 다음과 같은 에러가 발생합니다.</p>
<pre tabindex="0"><code>$ ts-node a.ts 
Error [ERR_REQUIRE_ESM]: require() of ES Module /a/node_modules/chalk/source/index.js from /a/a.ts not supported.
Instead change the require of index.js in /a/a.ts to a dynamic import() which is available in all CommonJS modules.
</code></pre><p>컴파일된 JavaScript 결과물을 보면 원인을 알 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="s2">&#34;use strict&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">exports</span><span class="p">.</span><span class="nx">__esModule</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">chalk_1</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;chalk&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk_1</span><span class="p">[</span><span class="s2">&#34;default&#34;</span><span class="p">].</span><span class="nx">yellow</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">));</span>
</span></span></code></pre></div><p>ESM 모듈은 require가 아니라 import를 해야 합니다.</p>
<h3 id="javascript에서-문제-해결">JavaScript에서 문제 해결</h3>
<p>TypeScript가 아니라 JavaScript로 import 구문을 사용해 작성해 봅니다. 이번에는 다른 에러가 납니다.</p>
<pre tabindex="0"><code>$ cat a.js 
import chalk from &#39;chalk&#39;;
console.log(chalk.yellow(&#39;Hello&#39;));
$ node a.js
(node:72179) Warning: To load an ES module, set &#34;type&#34;: &#34;module&#34; in the package.json or use the .mjs extension.
/a/a.js:1
import chalk from &#39;chalk&#39;;
^^^^^^

SyntaxError: Cannot use import statement outside a module
</code></pre><p>파일명을 <code>.mjs</code>로 바꾸면 잘 실행됩니다.</p>
<pre tabindex="0"><code>$ node a.mjs 
Hello
</code></pre><p>파일명을 바꾸는 대신 전체 프로젝트를 ESM을 사용하는 것으로 선언할 수 있습니다. package.json에 <code>&quot;type&quot;: &quot;module&quot;</code>을 추가합니다.</p>
<pre tabindex="0"><code>$ cat a.js 
import chalk from &#39;chalk&#39;;
console.log(chalk.yellow(&#39;Hello&#39;));
$ cat package.json 
{
  &#34;type&#34;: &#34;module&#34;,
  &#34;dependencies&#34;: {
    &#34;chalk&#34;: &#34;^5.0.1&#34;
  }
}
$ node a.js 
Hello
</code></pre><p>또는 TypeScript 실행시 보여준 에러 처럼 dynamic import를 사용할 수 있습니다.</p>
<pre tabindex="0"><code>$ cat a.js 
(async () =&gt; {
  const chalk = await import(&#39;chalk&#39;);
  console.log(chalk.default.yellow(&#39;Hello&#39;));
})();
$ node a.js 
Hello
</code></pre><p>정리하면 JavaScript에서 Pure ESM 모듈을 읽기 위해서는 다음 세가지 방법이 있습니다.</p>
<ul>
<li><code>.mjs</code> 확장자 사용</li>
<li>전체 프로젝트를 ESM으로 전환</li>
<li>dynamic import 사용</li>
</ul>
<h3 id="typescript로-되돌아-가서">TypeScript로 되돌아 가서</h3>
<p><code>.mts</code> 란 확장자도 인식하고, tsc로 컴파일 해보면 <code>.mjs</code>로 나오긴 하지만 적절한 변환은 안 됩니다.</p>
<p>dynamic import 구문을 사용해도 여전히 실행이 안 됩니다.
컴파일된 결과물을 보면 여전히 require로 변환이 됩니다.
이를 해결하려면 모듈시스템을 ES 것을 사용한다고 선언해야 합니다.
tsconfig에서 <a href="https://www.typescriptlang.org/tsconfig#module">module 설정</a>을 적절히 해줘야 합니다.</p>
<pre tabindex="0"><code>$ cat a.ts 
(async () =&gt; {
  const chalk = await import(&#39;chalk&#39;);
  console.log(chalk.default.yellow(&#39;Hello&#39;));
})();
$ cat tsconfig.json 
{
  &#34;compilerOptions&#34;: {
    &#34;target&#34;: &#34;es2017&#34;,
    &#34;module&#34;: &#34;es2020&#34;,
    &#34;moduleResolution&#34;: &#34;node&#34;
  }
}
$ ts-node a.ts 
Hello
</code></pre><p>import를 require로 변환하지 않고 그대로 두는 건 module 설정이지만, Node.js에서 import 구문을 이해하는 것을 별개입니다.
package.json에 <code>&quot;type&quot;: &quot;module&quot;</code> 도 추가하면 일반 import 구문도 동작합니다.
ts-node로 실행시에는 <code>--esm</code> 옵션을 줘야 동작합니다.</p>
<pre tabindex="0"><code>$ cat a.ts 
import chalk from &#39;chalk&#39;;
console.log(chalk.yellow(&#39;Hello&#39;));
$ cat package.json 
{
  &#34;type&#34;: &#34;module&#34;,
  &#34;dependencies&#34;: {...}
}
$ ts-node --esm a
Hello
$ tsc --module es2020 
$ cat a.js
import chalk from &#39;chalk&#39;;
console.log(chalk.yellow(&#39;Hello&#39;));
</code></pre><h2 id="실전-적용">실전 적용</h2>
<p>이제 ESM의 동작 원리에 대해 약간 감이 옵니다. (저는 이 글을 쓰면서 정리하는데도 아직도 헷갈립니다) 이제 실전 적용을 해봅니다.</p>
<p>JavaScript에서는 require와 dynamic import를 혼합해서 쓸 수 있습니다.
다시 말해 ESM 전환(<code>&quot;type&quot;: &quot;module&quot;</code>)을 하지 않아도 ESM 모듈을 쓰는 것이 가능합니다.
(static import가 안 되므로 코드를 다르게 작성하는 불편함은 있습니다.)</p>
<p>하지만 TypeScript에서는 import를 require로 변환 또는 모드 import로 유지, 두 가지 선택지 밖에 없습니다.
require로는 ESM 모듈을 쓸 수 없으므로 import 유지(<code>&quot;module&quot;: &quot;es2020&quot;</code>)를 해야 합니다.
이 경우 Node.js에서 import 구문을 사용하므로 ESM 전환(<code>&quot;type&quot;: &quot;module&quot;</code>)도 해야 합니다.</p>
<p>단순히 import 구문만 쓰면 되는게 아닙니다.
<a href="https://nodejs.org/api/esm.html#mandatory-file-extensions">불러올 파일의 확장자를 모두 기술</a>해줘야 합니다.
TypeScript 임에도 불구하고 <code>.js</code> 확장자를 써줘야 합니다.
또 저는 디렉토리명으로 import 하는 것을 종종 사용하는데 모두 파일명으로 바꿔줘야 합니다.
(<code>from './services' → from '.services/index.js'</code>) 이 과정을 도와주는 도구(<a href="https://www.npmjs.com/package/fix-esm-import-path">fix-esm-import-path</a>)도 있습니다.</p>
<p>샘플로 만들어본 프로젝트에서는 이걸로 동작했습니다.
하지만 실제 프로젝트로 가니 또 다른 이슈가 있었습니다.
<code>__dirname</code> 을 쓸 수 없다고 해서 변환을 해야 했습니다.
(예 <code>loadSchemaSync(join(__dirname, './index.graphql')</code>)</p>
<p>이제 컴파일도 되고 구동해봅니다. 안 됩니다. ESM 모듈에서는 require 구문을 쓰는게 아예 안 됩니다.</p>
<pre tabindex="0"><code>$ node a.js 
file:///a/a.js:1
const http = require(&#39;http&#39;);
             ^

ReferenceError: require is not defined in ES module scope, you can use import instead
This file is being treated as an ES module because it has a &#39;.js&#39; file extension and &#39;/a/package.json&#39; contains &#34;type&#34;: &#34;module&#34;. To treat it as a CommonJS script, rename it to use the &#39;.cjs&#39; file extension.
</code></pre><p>그런데 저희 주요 프로젝트 구조에는 TypeScript 내에서 require를 의존하는 곳이 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="c1">// tools/server.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TZ</span> <span class="o">=</span> <span class="s1">&#39;Etc/UTC&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ts-node/register/transpile-only&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../app/server&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// config/index.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">loadConfig</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">dir</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">env</span><span class="o">?:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">T</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">base</span> <span class="o">=</span> <span class="nx">cloneDeep</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">dir</span><span class="si">}</span><span class="sb">/default`</span><span class="p">).</span><span class="k">default</span> <span class="nx">as</span> <span class="nx">T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>다른 건 몰라도 config는 당장 고치기 어려워 보였습니다.
또 즐겨쓰고 있는 <a href="https://github.com/croquiscom/rinore">REPL</a>도 제대로 동작을 안 하는 건 좀 심각했습니다.</p>
<h2 id="그래서-해결책은">그래서 해결책은?</h2>
<p>결국 이 이상 시간을 쏟기는 어려워서 어플리케이션을 ESM 모드로 전환하는 것은 포기했습니다.
하지만 ESM 모듈은 여전히 필요했습니다.</p>
<p>다행히 이번에 조사할 때는 저번에 찾지 못했던 <a href="https://github.com/TypeStrong/ts-node/discussions/1290">회피 방법</a>을 찾았습니다.
TypeScript가 변환하지 않도록 import 문을 감추는 것입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s1">&#39;specifier&#39;</span><span class="p">,</span> <span class="s1">&#39;return import(specifier)&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><a href="https://stackoverflow.com/a/70546326/3239514">eval도 가능</a>하다는데 테스트해보진 않았습니다.</p>
<p>다만 위 코드보다는 라이브러리를 활용하는 솔루션이 더 직관적인 것 같아서 이 방법을 사용했습니다.
<a href="https://www.npmjs.com/package/tsimportlib">tsimportlib</a> 라이브러리를 사용하면 됩니다.</p>
<p>아쉬운 대로 동작합니다만 나중에 프로젝트가 ESM으로 전환됐을 때 dynamic import를 static import로 바꿔줘야 할 것 같아 꼭 필요한 곳에만 쓰는 것으로 생각하고 있습니다.</p>
<p>다행히 dynamic import는 서버에서만 필요했고, 프론트엔드 코드에서는 Next.js등이 잘 처리해주는지 static import로도 잘 동작했습니다.</p>
<h2 id="마무리">마무리</h2>
<p>개인적인 느낌으로 ESM은 Python2 → Python3를 전환시의 혼란을 보는 것 같습니다.
저를 포함해 많은 사람들이 당황해하고 불만을 터트리네요</p>
<p><img src="/img/ko/tech/2022-04-09-1-01.png" alt="https://github.com/sindresorhus/meta/discussions/15#discussioncomment-2495719">
<a href="https://github.com/sindresorhus/meta/discussions/15#discussioncomment-2495719">https://github.com/sindresorhus/meta/discussions/15#discussioncomment-2495719</a></p>
<p>하지만 좋은 싫든 ESM으로의 전환은 시작된 것 같습니다.
조금 더 생태계가 안정되면 다시 전환 시도를 해야 할 것 같습니다.</p>
<h2 id="appendix">Appendix</h2>
<ul>
<li><a href="https://nodejs.org/api/esm.html">Modules: ECMAScript modules | Node.js Documentation</a></li>
<li><a href="https://developer.mozilla.org/ko/docs/Web/JavaScript/Guide/Modules">JavaScript modules - JavaScript | MDN</a></li>
<li><a href="https://redfin.engineering/node-modules-at-war-why-commonjs-and-es-modules-cant-get-along-9617135eeca1">Node Modules at War: Why CommonJS and ES Modules Can’t Get Along</a> (<a href="https://roseline.oopy.io/dev/translation-why-cjs-and-esm-cannot-get-along">번역</a>, <a href="https://yceffort.kr/2020/08/commonjs-esmodules">요약</a>)</li>
<li><a href="https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c">Pure ESM package</a></li>
<li><a href="https://blog.sindresorhus.com/get-ready-for-esm-aa53530b3f77">Get Ready For ESM. JavaScript Modules will soon be a… | by Sindre Sorhus | 🦄 Sindre Sorhus’ blog</a></li>
<li><a href="https://docs.joshuatz.com/cheatsheets/node-and-npm/node-esm/">ES Modules in NodeJS - Troubleshooting Resources</a></li>
<li><a href="https://github.com/TypeStrong/ts-node/discussions/1290">Dynamic `import()` with `&ldquo;module&rdquo;: &ldquo;commonjs&rdquo;`</a></li>
<li><a href="https://typestrong.org/ts-node/docs/imports/">CommonJS vs native ECMAScript modules | ts-node</a></li>
<li><a href="https://www.npmjs.com/package/tsimportlib">tsimportlib</a></li>
</ul>

        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-03-31-3-build-eks-cluster-with-terraform/'>Terraform으로 EKS 구축하기</a></h2>
          <p class='posts-date'>31 Mar 2022</p>
        </div>
        <div class='panel-body'>
          <p><a href="/ko/tech/2022-03-31-2-web-application-using-eks/">이전 글</a>에서는 ECS / EKS에서 서비스 하는 것에 대한 개념을 풀어 써봤습니다. 이번 글에서는 잘 만들어진 모듈을 이용해 빠르게 구성해보겠습니다.</p>
<blockquote>
<p>모듈을 이용하면 편하긴 하지만 내부 개념을 정확히 이해하지 못한 채 사용하면 문제가 발생했을 때 해결이 어려운 것 같습니다. 결국 기본이 중요하다고 생각합니다.</p>
</blockquote>
<h2 id="vpc-셋업">VPC 셋업</h2>
<p><a href="https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest">VPC 모듈</a>을 사용하면 이전에 길게 썼던 것을 짧게 기술할 수 있습니다. 이전에 만든 VPC 구조와 같지만 NAT 게이트웨이가 AZ 별로 따로 존재합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;aws&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  region</span> <span class="o">=</span> <span class="s2">&#34;ap-northeast-2&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span> <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="s2">&#34;vpc&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  source</span> <span class="o">=</span> <span class="s2">&#34;terraform-aws-modules/vpc/aws&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr</span> <span class="o">=</span> <span class="s2">&#34;10.194.0.0/16&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  azs</span>             <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;ap-northeast-2a&#34;, &#34;ap-northeast-2c&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  public_subnets</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.0.0/24&#34;, &#34;10.194.1.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  private_subnets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.100.0/24&#34;, &#34;10.194.101.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  enable_nat_gateway</span>     <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="n">  one_nat_gateway_per_az</span> <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  enable_dns_hostnames</span> <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  public_subnet_tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/role/elb&#34;</span>                      <span class="o">=</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  private_subnet_tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/role/internal-elb&#34;</span>             <span class="o">=</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="eks-클러스터-생성">EKS 클러스터 생성</h2>
<p><a href="https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest">AWS EKS 모듈</a>을 사용하면 EKS 클러스터도 쉽게 생성가능합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">module</span> <span class="s2">&#34;eks&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  source</span> <span class="o">=</span> <span class="s2">&#34;terraform-aws-modules/eks/aws&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span>                    <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cluster_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_version</span>                 <span class="o">=</span> <span class="s2">&#34;1.21&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_endpoint_private_access</span> <span class="o">=</span> <span class="kt">false</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_endpoint_public_access</span>  <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  cluster_addons</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    coredns</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      resolve_conflicts</span> <span class="o">=</span> <span class="s2">&#34;OVERWRITE&#34;</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl"><span class="n">    kube-proxy</span> <span class="o">=</span> {}
</span></span><span class="line"><span class="cl"><span class="n">    vpc-cni</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      resolve_conflicts</span> <span class="o">=</span> <span class="s2">&#34;OVERWRITE&#34;</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>     <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">vpc</span><span class="p">.</span><span class="k">vpc_id</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnet_ids</span> <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">vpc</span><span class="p">.</span><span class="k">private_subnets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  cloudwatch_log_group_retention_in_days</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  fargate_profiles</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    default</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      name</span> <span class="o">=</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">      selectors</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        {
</span></span><span class="line"><span class="cl"><span class="n">          namespace</span> <span class="o">=</span> <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">        }<span class="p">,</span>
</span></span><span class="line"><span class="cl">        {
</span></span><span class="line"><span class="cl"><span class="n">          namespace</span> <span class="o">=</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>coredns 모듈 생성에서 계속 멈춰 있는 것을 볼 수 있습니다. Fargate만 있어서인데, <a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-getting-started.html#fargate-gs-coredns">CoreDNS 패치를 해 주면</a>
잠시 후 완료됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ aws eks update-kubeconfig --region ap-northeast-2 --name simon-test --alias simon-test
</span></span><span class="line"><span class="cl">$ kubectl patch deployment coredns -n kube-system --type json -p<span class="o">=</span><span class="s1">&#39;[{&#34;op&#34;: &#34;remove&#34;, &#34;path&#34;: &#34;/spec/template/metadata/annotations/eks.amazonaws.com~1compute-type&#34;}]&#39;</span>
</span></span></code></pre></div><h2 id="aws-load-balancer-controller-설치">AWS Load Balancer Controller 설치</h2>
<p><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/aws-load-balancer-controller.html">AWS Load Balancer Controller</a>도 Terraform으로 설치가능합니다. 관련된 모듈이 여러 개 있는데 미묘하게 다 동작을 하지 않아서 결국은 자체적으로 구현해봤습니다. 이전에 쉘에서 실행한 명령을 Terraform으로 구성했다고 보시면 됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  lb_controller_iam_role_name</span>        <span class="o">=</span> <span class="s2">&#34;inhouse-eks-aws-lb-ctrl&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  lb_controller_service_account_name</span> <span class="o">=</span> <span class="s2">&#34;aws-load-balancer-controller&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">data</span> <span class="s2">&#34;aws_eks_cluster_auth&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cluster_name</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;helm&#34;</span> {
</span></span><span class="line"><span class="cl">  <span class="k">kubernetes</span> {
</span></span><span class="line"><span class="cl"><span class="n">    host</span>                   <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_endpoint</span>
</span></span><span class="line"><span class="cl"><span class="n">    token</span>                  <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="k">aws_eks_cluster_auth</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">token</span>
</span></span><span class="line"><span class="cl"><span class="n">    cluster_ca_certificate</span> <span class="o">=</span> <span class="k">base64decode</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_certificate_authority_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="s2">&#34;lb_controller_role&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  source</span> <span class="o">=</span> <span class="s2">&#34;terraform-aws-modules/iam/aws//modules/iam-assumable-role-with-oidc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  create_role</span> <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  role_name</span>        <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">lb_controller_iam_role_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  role_path</span>        <span class="o">=</span> <span class="s2">&#34;/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role_description</span> <span class="o">=</span> <span class="s2">&#34;Used by AWS Load Balancer Controller for EKS&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  role_permissions_boundary_arn</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  provider_url</span> <span class="o">=</span> <span class="k">replace</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_oidc_issuer_url</span><span class="p">,</span> <span class="s2">&#34;https://&#34;, &#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">  oidc_fully_qualified_subjects</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;system:serviceaccount:kube-system:${local.lb_controller_service_account_name}&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  oidc_fully_qualified_audiences</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;sts.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">data</span> <span class="s2">&#34;http&#34; &#34;iam_policy&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  url</span> <span class="o">=</span> <span class="s2">&#34;https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.0/docs/install/iam_policy.json&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy&#34; &#34;controller&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name_prefix</span> <span class="o">=</span> <span class="s2">&#34;AWSLoadBalancerControllerIAMPolicy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  policy</span>      <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="k">http</span><span class="p">.</span><span class="k">iam_policy</span><span class="p">.</span><span class="k">body</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>        <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">lb_controller_role</span><span class="p">.</span><span class="k">iam_role_name</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;helm_release&#34; &#34;release&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span>       <span class="o">=</span> <span class="s2">&#34;aws-load-balancer-controller&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  chart</span>      <span class="o">=</span> <span class="s2">&#34;aws-load-balancer-controller&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  repository</span> <span class="o">=</span> <span class="s2">&#34;https://aws.github.io/eks-charts&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  namespace</span>  <span class="o">=</span> <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">dynamic</span> <span class="s2">&#34;set&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">    for_each</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      &#34;clusterName&#34;</span>           <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_id</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;serviceAccount.create&#34;</span> <span class="o">=</span> <span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;serviceAccount.name&#34;</span>   <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">lb_controller_service_account_name</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;region&#34;</span>                <span class="o">=</span> <span class="s2">&#34;ap-northeast-2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;vpcId&#34;</span>                 <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">vpc</span><span class="p">.</span><span class="k">vpc_id</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;image.repository&#34;</span>      <span class="o">=</span> <span class="s2">&#34;602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon/aws-load-balancer-controller&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">      &#34;serviceAccount.annotations.eks\\.amazonaws\\.com/role-arn&#34;</span> <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">lb_controller_role</span><span class="p">.</span><span class="k">iam_role_arn</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    <span class="k">content</span> {
</span></span><span class="line"><span class="cl"><span class="n">      name</span>  <span class="o">=</span> <span class="k">set</span><span class="p">.</span><span class="k">key</span>
</span></span><span class="line"><span class="cl"><span class="n">      value</span> <span class="o">=</span> <span class="k">set</span><span class="p">.</span><span class="k">value</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="어플리케이션-구동">어플리케이션 구동</h2>
<p>간단한 서버(이번에는 공개 서버 - <code>k8s.gcr.io/echoserver</code> -를 이용합니다)를 Terraform으로 구성하겠습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;kubernetes&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  host</span>                   <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_endpoint</span>
</span></span><span class="line"><span class="cl"><span class="n">  token</span>                  <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="k">aws_eks_cluster_auth</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">token</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_ca_certificate</span> <span class="o">=</span> <span class="k">base64decode</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_certificate_authority_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;kubernetes_deployment&#34; &#34;echo&#34;</span> {
</span></span><span class="line"><span class="cl">  <span class="k">metadata</span> {
</span></span><span class="line"><span class="cl"><span class="n">    name</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  <span class="k">spec</span> {
</span></span><span class="line"><span class="cl"><span class="n">    replicas</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">selector</span> {
</span></span><span class="line"><span class="cl"><span class="n">      match_labels</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">        &#34;app.kubernetes.io/name&#34;</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    <span class="k">template</span> {
</span></span><span class="line"><span class="cl">      <span class="k">metadata</span> {
</span></span><span class="line"><span class="cl"><span class="n">        labels</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">          &#34;app.kubernetes.io/name&#34;</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">      <span class="k">spec</span> {
</span></span><span class="line"><span class="cl">        <span class="k">container</span> {
</span></span><span class="line"><span class="cl"><span class="n">          image</span> <span class="o">=</span> <span class="s2">&#34;k8s.gcr.io/echoserver:1.10&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">          name</span>  <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;kubernetes_service&#34; &#34;echo&#34;</span> {
</span></span><span class="line"><span class="cl">  <span class="k">metadata</span> {
</span></span><span class="line"><span class="cl"><span class="n">    name</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  <span class="k">spec</span> {
</span></span><span class="line"><span class="cl"><span class="n">    selector</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      &#34;app.kubernetes.io/name&#34;</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    <span class="k">port</span> {
</span></span><span class="line"><span class="cl"><span class="n">      port</span>        <span class="o">=</span> <span class="m">8080</span>
</span></span><span class="line"><span class="cl"><span class="n">      target_port</span> <span class="o">=</span> <span class="m">8080</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl"><span class="n">    type</span> <span class="o">=</span> <span class="s2">&#34;NodePort&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;kubernetes_ingress_v1&#34; &#34;alb&#34;</span> {
</span></span><span class="line"><span class="cl">  <span class="k">metadata</span> {
</span></span><span class="line"><span class="cl"><span class="n">    name</span> <span class="o">=</span> <span class="s2">&#34;alb&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    annotations</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      &#34;alb.ingress.kubernetes.io/scheme&#34;</span>      <span class="o">=</span> <span class="s2">&#34;internet-facing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;alb.ingress.kubernetes.io/target-type&#34;</span> <span class="o">=</span> <span class="s2">&#34;ip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  <span class="k">spec</span> {
</span></span><span class="line"><span class="cl"><span class="n">    ingress_class_name</span> <span class="o">=</span> <span class="s2">&#34;alb&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">rule</span> {
</span></span><span class="line"><span class="cl">      <span class="k">http</span> {
</span></span><span class="line"><span class="cl">        <span class="k">path</span> {
</span></span><span class="line"><span class="cl">          <span class="k">backend</span> {
</span></span><span class="line"><span class="cl">            <span class="k">service</span> {
</span></span><span class="line"><span class="cl"><span class="n">              name</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="k">port</span> {
</span></span><span class="line"><span class="cl"><span class="n">                number</span> <span class="o">=</span> <span class="m">8080</span>
</span></span><span class="line"><span class="cl">              }
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">          }
</span></span><span class="line"><span class="cl"><span class="n">          path</span> <span class="o">=</span> <span class="s2">&#34;/*&#34;</span>
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>이제 로드 밸런서 주소로 요청을 보내면 응답을 보내옵니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># k8s-default-alb-622014ceba-1089817135.ap-northeast-2.elb.amazonaws.com 같은 주소를 가집니다</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">LB_HOST</span><span class="o">=</span><span class="k">$(</span>kubectl get ingress/alb -ojson <span class="p">|</span> jq -r <span class="s2">&#34;.status.loadBalancer.ingress[0].hostname&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">$ curl <span class="nv">$LB_HOST</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Hostname: echo-5499565745-tk7dm
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Pod Information:
</span></span><span class="line"><span class="cl">	-no pod information available-
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Server values:
</span></span><span class="line"><span class="cl">	<span class="nv">server_version</span><span class="o">=</span>nginx: 1.13.3 - lua: <span class="m">10008</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Request Information:
</span></span><span class="line"><span class="cl">	<span class="nv">client_address</span><span class="o">=</span>10.194.1.162
</span></span><span class="line"><span class="cl">	<span class="nv">method</span><span class="o">=</span>GET
</span></span><span class="line"><span class="cl">	real <span class="nv">path</span><span class="o">=</span>/
</span></span><span class="line"><span class="cl">	<span class="nv">query</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">	<span class="nv">request_version</span><span class="o">=</span>1.1
</span></span><span class="line"><span class="cl">	<span class="nv">request_scheme</span><span class="o">=</span>http
</span></span><span class="line"><span class="cl">	<span class="nv">request_uri</span><span class="o">=</span>http://k8s-default-alb-622014ceba-1089817135.ap-northeast-2.elb.amazonaws.com:8080/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Request Headers:
</span></span><span class="line"><span class="cl">	<span class="nv">accept</span><span class="o">=</span>*/*
</span></span><span class="line"><span class="cl">	<span class="nv">host</span><span class="o">=</span>k8s-default-alb-622014ceba-1089817135.ap-northeast-2.elb.amazonaws.com
</span></span><span class="line"><span class="cl">	user-agent<span class="o">=</span>curl/7.77.0
</span></span><span class="line"><span class="cl">	x-amzn-trace-id<span class="o">=</span><span class="nv">Root</span><span class="o">=</span>1-6244434a-56cbdde1124166e4168d1cf4
</span></span><span class="line"><span class="cl">	x-forwarded-for<span class="o">=</span>1.2.3.4
</span></span><span class="line"><span class="cl">	x-forwarded-port<span class="o">=</span><span class="m">80</span>
</span></span><span class="line"><span class="cl">	x-forwarded-proto<span class="o">=</span>http
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Request Body:
</span></span><span class="line"><span class="cl">	-no body in request-
</span></span></code></pre></div><p>위 예에서는 같은 Terraform 파일에서 정의를 했기 때문에 module.eks의 출력을 이용했습니다. 만약 별도 스택으로 정의를 할 예정이고, kubeconfig가 설정된 상태면 다음과 같이 provider를 설정할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;kubernetes&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  config_path</span>    <span class="o">=</span> <span class="s2">&#34;~/.kube/config&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  config_context</span> <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="후기">후기</h2>
<p>EKS 시리즈 글을 작성하면서 클러스터 생성을 여러 번 반복했습니다. 반복할 때마다 하나씩 빼먹어서 문제점을 찾는데 한참 걸렸습니다. 그에 비해 잘 구성된 Terraform 모듈을 활용하니 확실히 편했습니다.</p>
<p>하지만 각 단계를 한번씩 해봐서 전체적인 이해가 된 상황(서브넷 태깅이 왜 필요한지, CoreDNS는 왜 생성되지 않는지등)이여서 모듈 활용도 가능했다고 봅니다.</p>
<p>이번 예에서는 예제 파일을 단순하게 하기 위해서, 쿠버네티스에서 동작하는 어플리케이션까지 Terraform으로 구성해봤습니다. Terraform으로 인프라를 통일하면 좋다고 생각하지만, 쿠버네티스는 별개의 정의 스펙이 있다보니 애매한 점이 있는 것 같습니다. 실제로 저희 실 서비스의 경우는 Terraform이 아니라 <a href="https://helm.sh/">Helm Charts</a>를 사용해 어플리케이션을 정의했습니다.</p>
<p>이번 글이 쿠버네티스와 EKS를 이해하는데 도움이 되었기를 바랍니다.</p>
<h2 id="appendix">Appendix</h2>
<ul>
<li>예제 파일: <a href="/file/ko/tech/2022-03-31-3-simon-sample.zip">simon-sample.zip</a></li>
<li><a href="https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest">terraform-aws-modules/vpc/aws | Terraform Registry</a></li>
<li><a href="https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest">terraform-aws-modules/eks/aws | Terraform Registry</a></li>
<li>AWS Load Balancer Controller 모듈
<ul>
<li><a href="https://registry.terraform.io/modules/Young-ook/eks/aws/latest/examples/lb">Young-ook/eks/aws | Terraform Registry</a></li>
<li><a href="https://registry.terraform.io/modules/DNXLabs/eks-lb-controller/aws/latest">DNXLabs/eks-lb-controller/aws | Terraform Registry</a></li>
<li><a href="https://registry.terraform.io/modules/basisai/lb-controller/aws/latest">basisai/lb-controller/aws | Terraform Registry</a></li>
</ul>
</li>
<li><a href="https://phoenixnap.com/blog/helm-vs-terraform">Helm vs Terraform: What Are the Differences</a></li>
<li><a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs">Kubernetes Provider</a></li>
</ul>

        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-03-31-2-web-application-using-eks/'>EKS를 사용해서 어플리케이션 서비스 하기</a></h2>
          <p class='posts-date'>31 Mar 2022</p>
        </div>
        <div class='panel-body'>
          <p><a href="/ko/tech/2022-03-31-1-web-application-using-ecs/">ECS 아티클</a>에 이어 이번 글에서는 같은 서비스를 EKS로 구축해보도록 하겠습니다.</p>
<p>간단하게 구축하는 것은 <a href="https://eksctl.io/">eksctl</a>을 쓰면 되지만, 내부 이해를 위해 여기서는 기본부터 구현하도록 하겠습니다.</p>
<h2 id="vpc-셋업">VPC 셋업</h2>
<p>VPC는 이전과 마찬가지로 두 개의 AZ에 퍼블릭 서브넷과 프리이빗 서브넷이 필요합니다. 다만 로드 밸런서가 정상적으로 배치되려며 특정한 태그를 서브넷에 부여해야합니다.</p>
<p><img src="/img/ko/tech/2022-03-31-2-01.png" alt="Sample VPC"></p>
<p>서비스 컨테이너만 정의하는 ECS와 달리 쿠버네티스는 클러스터 내에서 로드 밸런서, 영구 볼륨등도 정의할 수 있습니다. 이때 정의는 쿠버네티스안에서 하지만 실제 만들어지는 것은 쿠버네티스와 무관한 AWS 리소스(ALB, EBS등)입니다. 쿠버네티스 자체는 AWS 구조와 독립적이고, 태그등 다른 방법을 통해 쿠버네티스 리소스가 위치할 AWS 리소스를 찾게 됩니다.</p>
<p><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html">EKS에서 애플리케이션 로드 밸런싱 문서</a>에 따라 다음 태그를 설정해줍니다.</p>
<ul>
<li><code>kubernetes.io/cluster/&lt;name&gt;</code>: <code>shared</code></li>
<li><code>kubernetes.io/role/internal-elb</code>: 프라이빗 서브넷에 대해 <code>1</code>로 설정합니다.</li>
<li><code>kubernetes.io/role/elb</code>: 퍼블릭 서브넷에 대해 <code>1</code>로 설정합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;aws&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  region</span> <span class="o">=</span> <span class="s2">&#34;ap-northeast-2&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_name</span>        <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr</span>            <span class="o">=</span> <span class="s2">&#34;10.194.0.0/16&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  public_subnets</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.0.0/24&#34;, &#34;10.194.1.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  private_subnets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.100.0/24&#34;, &#34;10.194.101.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  azs</span>             <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;ap-northeast-2a&#34;, &#34;ap-northeast-2c&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span>    <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC를 생성합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_vpc&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cidr</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>       <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">vpc_name</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC 생성시 기본으로 생성되는 라우트 테이블에 이름을 붙입니다
</span></span></span><span class="line"><span class="cl"><span class="c1">## 이걸 서브넷에 연결해 써도 되지만, 여기서는 사용하지 않습니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_default_route_table&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  default_route_table_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">default_route_table_id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>                   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-default&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC 생성시 기본으로 생성되는 보안 그룹에 이름을 붙입니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_default_security_group&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-default&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷에 연결할 인터넷 게이트웨이를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_internet_gateway&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-igw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷에 적용할 라우팅 테이블
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-public&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷에서 인터넷에 트래픽 요청시 앞서 정의한 인터넷 게이트웨이로 보냅니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route&#34; &#34;public_worldwide&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span>         <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  destination_cidr_block</span> <span class="o">=</span> <span class="s2">&#34;0.0.0.0/0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  gateway_id</span>             <span class="o">=</span> <span class="k">aws_internet_gateway</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷을 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_subnet&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">)</span><span class="c1"> # 여러개를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>                  <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span>              <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  availability_zone</span>       <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">azs</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  map_public_ip_on_launch</span> <span class="o">=</span> <span class="kt">true</span><span class="c1"> # 퍼플릭 서브넷에 배치되는 서비스는 자동으로 공개 IP를 부여합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-public-${count.index + 1}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span><span class="p">,</span><span class="c1"> # 다른 부분
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">    &#34;kubernetes.io/role/elb&#34;</span>                      <span class="o">=</span> <span class="s2">&#34;1&#34;</span><span class="c1"> # 다른 부분
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷을 라우팅 테이블에 연결합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table_association&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>      <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">public</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span> <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## NAT 게이트웨이는 고정 IP를 필요로 합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_eip&#34; &#34;nat_gateway&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc</span>  <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-natgw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷에서 인터넷 접속시 사용할 NAT 게이트웨이
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_nat_gateway&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  allocation_id</span> <span class="o">=</span> <span class="k">aws_eip</span><span class="p">.</span><span class="k">nat_gateway</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>     <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">public</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="k">id</span><span class="c1"> # NAT 게이트웨이 자체는 퍼플릭 서브넷에 위치해야 합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  tags</span>          <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-natgw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷에 적용할 라우팅 테이블
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-private&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷에서 인터넷에 트래픽 요청시 앞서 정의한 NAT 게이트웨이로 보냅니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route&#34; &#34;private_worldwide&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span>         <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">private</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  destination_cidr_block</span> <span class="o">=</span> <span class="s2">&#34;0.0.0.0/0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  nat_gateway_id</span>         <span class="o">=</span> <span class="k">aws_nat_gateway</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷을 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_subnet&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">)</span><span class="c1"> # 여러개를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>            <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span>        <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  availability_zone</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">azs</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-private-${count.index + 1}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span><span class="p">,</span><span class="c1"> # 다른 부분
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">    &#34;kubernetes.io/role/internal-elb&#34;</span>             <span class="o">=</span> <span class="s2">&#34;1&#34;</span><span class="c1"> # 다른 부분
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷을 라우팅 테이블에 연결합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table_association&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>      <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span> <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">private</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="eks-클러스터-생성">EKS 클러스터 생성</h2>
<p>ECS가 하나의 리소스로 끝난 것에 비해 EKS는 조금 복잡합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1">## 클러스터가 사용할 역할을 정의합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1">## AmazonEKSClusterPolicy와 AmazonEKSVPCResourceController를 포함합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_iam_role&#34; &#34;cluster&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;${local.cluster_name}-eks-cluster-role&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  assume_role_policy</span> <span class="o">=</span> <span class="k">jsonencode</span><span class="p">(</span>{
</span></span><span class="line"><span class="cl"><span class="n">    Version</span> <span class="o">=</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    Statement</span> <span class="o">=</span> <span class="p">[</span>{
</span></span><span class="line"><span class="cl"><span class="n">      Effect</span> <span class="o">=</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Principal</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">        Service</span> <span class="o">=</span> <span class="s2">&#34;eks.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">      }<span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Action</span> <span class="o">=</span> <span class="s2">&#34;sts:AssumeRole&#34;</span>
</span></span><span class="line"><span class="cl">    }<span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy_attachment&#34; &#34;cluster_AmazonEKSClusterPolicy&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  policy_arn</span> <span class="o">=</span> <span class="s2">&#34;arn:aws:iam::aws:policy/AmazonEKSClusterPolicy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy_attachment&#34; &#34;cluster_AmazonEKSVPCResourceController&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  policy_arn</span> <span class="o">=</span> <span class="s2">&#34;arn:aws:iam::aws:policy/AmazonEKSVPCResourceController&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## EKS 클러스터를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_eks_cluster&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span>     <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cluster_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  role_arn</span> <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl">  <span class="k">vpc_config</span> {
</span></span><span class="line"><span class="cl"><span class="n">    subnet_ids</span> <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl"><span class="n">  depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="c1"> # see https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/eks_cluster#example-usage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">aws_iam_role_policy_attachment</span><span class="p">.</span><span class="k">cluster_AmazonEKSClusterPolicy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">aws_iam_role_policy_attachment</span><span class="p">.</span><span class="k">cluster_AmazonEKSVPCResourceController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## Fargate에서 팟 배치시 사용하는 실행 역할을 정의합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1">## AmazonEKSFargatePodExecutionRolePolicy를 포함합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_iam_role&#34; &#34;pod_execution&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;${local.cluster_name}-eks-pod-execution-role&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  assume_role_policy</span> <span class="o">=</span> <span class="k">jsonencode</span><span class="p">(</span>{
</span></span><span class="line"><span class="cl"><span class="n">    Version</span> <span class="o">=</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    Statement</span> <span class="o">=</span> <span class="p">[</span>{
</span></span><span class="line"><span class="cl"><span class="n">      Effect</span> <span class="o">=</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Principal</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">        Service</span> <span class="o">=</span> <span class="s2">&#34;eks-fargate-pods.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">      }<span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Action</span> <span class="o">=</span> <span class="s2">&#34;sts:AssumeRole&#34;</span>
</span></span><span class="line"><span class="cl">    }<span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy_attachment&#34; &#34;pod_execution_AmazonEKSFargatePodExecutionRolePolicy&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  policy_arn</span> <span class="o">=</span> <span class="s2">&#34;arn:aws:iam::aws:policy/AmazonEKSFargatePodExecutionRolePolicy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">pod_execution</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## EKS 클러스터에 노드를 Fargate로 공급합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1">## default/kube-system 네임스페이스를 가진 팟에 대해 적용됩니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_eks_fargate_profile&#34; &#34;default&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span>           <span class="o">=</span> <span class="k">aws_eks_cluster</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl"><span class="n">  fargate_profile_name</span>   <span class="o">=</span> <span class="s2">&#34;fp-default&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  pod_execution_role_arn</span> <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">pod_execution</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnet_ids</span>             <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="k">id</span><span class="c1"> # 프라이빗 서브넷만 줄 수 있습니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">selector</span> {
</span></span><span class="line"><span class="cl"><span class="n">    namespace</span> <span class="o">=</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  <span class="k">selector</span> {
</span></span><span class="line"><span class="cl"><span class="n">    namespace</span> <span class="o">=</span> <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>쿠버네티스 클러스터에 접근할 수 있도록 <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-kubeconfig.html">kubeconfig를 생성</a>합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ aws eks update-kubeconfig --region ap-northeast-2 --name simon-test --alias simon-test
</span></span></code></pre></div><p>이제 쿠버네티스 클러스터의 상태를 볼 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get svc
</span></span><span class="line"><span class="cl">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
</span></span><span class="line"><span class="cl">kubernetes   ClusterIP   172.20.0.1   &lt;none&gt;        443/TCP   23m
</span></span></code></pre></div><p>그런데 팟 목록을 보면 기본적으로 실행되어야 할 coredns 팟이 뜨지 않는 것이 보입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get pods -n kube-system
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">coredns-6dbb778559-clx8r   0/1     Pending   <span class="m">0</span>          13m
</span></span><span class="line"><span class="cl">coredns-6dbb778559-zpx2h   0/1     Pending   <span class="m">0</span>          13m
</span></span></code></pre></div><p>Fargate 노드만 사용하려면 <a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-getting-started.html#fargate-gs-coredns">CoreDNS 내용을 수정 해줘야</a> 합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl patch deployment coredns <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -n kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --type json <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -p<span class="o">=</span><span class="s1">&#39;[{&#34;op&#34;: &#34;remove&#34;, &#34;path&#34;: &#34;/spec/template/metadata/annotations/eks.amazonaws.com~1compute-type&#34;}]&#39;</span>
</span></span><span class="line"><span class="cl">deployment.apps/coredns patched
</span></span><span class="line"><span class="cl">$ kubectl get pods -n kube-system                          
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">coredns-6f99dbb876-hp667   1/1     Running   <span class="m">0</span>          4m
</span></span><span class="line"><span class="cl">coredns-6f99dbb876-skrgn   1/1     Running   <span class="m">0</span>          4m
</span></span></code></pre></div><p>컨테이너에 IAM 권한을 부여하려면 <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html">OIDC 공급자 생성</a>이 필요합니다</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ eksctl utils associate-iam-oidc-provider --cluster simon-test --approve
</span></span></code></pre></div><h2 id="서비스-구동">서비스 구동</h2>
<p>이제 우리가 만든 어플리케이션을 EKS 클러스터에 올릴 차례입니다.</p>
<p>이전과 마찬가지로 ECR 저장소를 만들고 이미지를 올려둡니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  app_name</span> <span class="o">=</span> <span class="s2">&#34;simon-sample&#34;</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## simon-sample 앱을 위한 저장소를 만듭니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_ecr_repository&#34; &#34;simon_sample&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">app_name</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>이 이미지를 띄우는 것은 쿠버네티스가 처리합니다.</p>
<p>쿠버네티스에 띄우는 가장 작은 단위는 <a href="https://kubernetes.io/ko/docs/concepts/workloads/pods/">파드</a>입니다. 다만 파드로 띄우면 서버를 확장하는 것이 어렵습니다. <a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/replicaset/">레플리카셋</a>이라는 리소스를 사용하면 파드를 여러개 띄울 수 있습니다. 여기에 더해 <a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/">디플로이먼트</a>를 리소스를 사용하면 어플리케이션 갱신시 레플리카셋 교체를 해줍니다.</p>
<p>다음과 같이 쿠버네티스 리소스를 정의합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;aws-account-id&gt;.dkr.ecr.ap-northeast-2.amazonaws.com/simon-sample:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span></code></pre></div><p>다음 명령으로 적용합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl apply -f simon-sample.yaml
</span></span><span class="line"><span class="cl">deployment.apps/simon-sample created
</span></span></code></pre></div><p>보통 5분 안에(빠르면 1분 안에) 다음과 같이 Running 상태로 바뀝니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get pods -o wide                 
</span></span><span class="line"><span class="cl">NAME                           READY   STATUS    RESTARTS   AGE     IP              NODE                    NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">simon-sample-dd88b97bc-svtd6   1/1     Running   <span class="m">0</span>          3m45s   10.194.101.15   fargate-10.194.101.15   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>포트 포워딩으로 세팅하고, HTTP 요청을 하면 응답이 오는 것을 볼 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl port-forward simon-sample-dd88b97bc-svtd6 3000:3000
</span></span><span class="line"><span class="cl">Forwarding from 127.0.0.1:3000 -&gt; <span class="m">3000</span>
</span></span><span class="line"><span class="cl">Handling connection <span class="k">for</span> <span class="m">3000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## from other terminal</span>
</span></span><span class="line"><span class="cl">$ curl localhost:3000 --data <span class="s1">&#39;hello world&#39;</span>
</span></span><span class="line"><span class="cl">hello world
</span></span></code></pre></div><h2 id="서비스를-외부에-노출하기">서비스를 외부에 노출하기</h2>
<p>ECS와 마찬가지로 실제 서비스가 되려면 외부에 노출된 로드 밸런서에 우리의 서비스를 붙여줘야 합니다. ECS와 달리 쿠버네티스에서는 로드 밸런서 정의도 쿠버네티스 리소스로 정의합니다. 하지만 실제로는 EKS가 알아서 AWS 로드 밸런서를 생성하게 됩니다.</p>
<p>어플리케이션 계층(L7)에서 동작하는 Application Load Balancer(ALB)를 생성하기 위한 리소스 타입은 <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a> 입니다.</p>
<p>우선 <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/aws-load-balancer-controller.html">AWS Load Balancer Controller 추가 기능 설치</a>가 필요합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## ALB를 컨트롤 할 수 있는 정책을 생성합니다.</span>
</span></span><span class="line"><span class="cl">$ curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.0/docs/install/iam_policy.json
</span></span><span class="line"><span class="cl">$ aws iam create-policy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --policy-name AWSLoadBalancerControllerIAMPolicy-simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --policy-document file://iam_policy.json
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 위 정책을 포함한 IAM 역할을 생성합니다.</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">ACCOUNT_ID</span><span class="o">=</span><span class="k">$(</span>aws sts get-caller-identity <span class="p">|</span> jq -r .Account<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">OIDC_URL</span><span class="o">=</span><span class="k">$(</span>aws eks describe-cluster --name simon-test --query <span class="s2">&#34;cluster.identity.oidc.issuer&#34;</span> --output text <span class="p">|</span> sed <span class="s2">&#34;s|https://||&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">$ cat &gt; load-balancer-role-trust-policy.json <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">{
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;Statement&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="s">        {
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Principal&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">                &#34;Federated&#34;: &#34;arn:aws:iam::${ACCOUNT_ID}:oidc-provider/$OIDC_URL&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">            },
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Action&#34;: &#34;sts:AssumeRoleWithWebIdentity&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Condition&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">                &#34;StringEquals&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">                    &#34;${OIDC_URL}:aud&#34;: &#34;sts.amazonaws.com&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">                    &#34;${OIDC_URL}:sub&#34;: &#34;system:serviceaccount:kube-system:aws-load-balancer-controller&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                }
</span></span></span><span class="line"><span class="cl"><span class="s">            }
</span></span></span><span class="line"><span class="cl"><span class="s">        }
</span></span></span><span class="line"><span class="cl"><span class="s">    ]
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">$ aws iam create-role <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --role-name AmazonEKSLoadBalancerControllerRole-simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --assume-role-policy-document file://<span class="s2">&#34;load-balancer-role-trust-policy.json&#34;</span>
</span></span><span class="line"><span class="cl">$ aws iam attach-role-policy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --policy-arn arn:aws:iam::<span class="si">${</span><span class="nv">ACCOUNT_ID</span><span class="si">}</span>:policy/AWSLoadBalancerControllerIAMPolicy-simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --role-name AmazonEKSLoadBalancerControllerRole-simon-test
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## IAM 역할에 연결된 쿠베네티스 서비스 계정을 생성합니다.</span>
</span></span><span class="line"><span class="cl">$ cat &gt; aws-load-balancer-controller-service-account.yaml <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ServiceAccount
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app.kubernetes.io/component: controller
</span></span></span><span class="line"><span class="cl"><span class="s">    app.kubernetes.io/name: aws-load-balancer-controller
</span></span></span><span class="line"><span class="cl"><span class="s">  name: aws-load-balancer-controller
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: kube-system
</span></span></span><span class="line"><span class="cl"><span class="s">  annotations:
</span></span></span><span class="line"><span class="cl"><span class="s">    eks.amazonaws.com/role-arn: arn:aws:iam::${ACCOUNT_ID}:role/AmazonEKSLoadBalancerControllerRole-simon-test
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">$ kubectl apply -f aws-load-balancer-controller-service-account.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## AWS Load Balancer Controller를 설치합니다</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">VPC_ID</span><span class="o">=</span><span class="k">$(</span>aws ec2 describe-vpcs --filters <span class="nv">Name</span><span class="o">=</span>cidr,Values<span class="o">=</span>10.194.0.0/16 <span class="p">|</span> jq -r .Vpcs<span class="o">[</span>0<span class="o">]</span>.VpcId<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ helm repo add eks https://aws.github.io/eks-charts
</span></span><span class="line"><span class="cl">$ helm repo update
</span></span><span class="line"><span class="cl">$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -n kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">clusterName</span><span class="o">=</span>simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set serviceAccount.create<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set serviceAccount.name<span class="o">=</span>aws-load-balancer-controller <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">region</span><span class="o">=</span>ap-northeast-2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">vpcId</span><span class="o">=</span><span class="nv">$VPC_ID</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set image.repository<span class="o">=</span>602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon/aws-load-balancer-controller
</span></span><span class="line"><span class="cl">NAME: aws-load-balancer-controller
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Sat Mar <span class="m">26</span> 10:02:19 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: kube-system
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">AWS Load Balancer controller installed!
</span></span><span class="line"><span class="cl">$ kubectl get deployment -n kube-system aws-load-balancer-controller
</span></span><span class="line"><span class="cl">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">aws-load-balancer-controller   2/2     <span class="m">2</span>            <span class="m">2</span>           5m51s
</span></span></code></pre></div><p>이제 쿠버네티스를 통해 ALB를 생성하고, 아까 만든 앱을 등록합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-test-alb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/scheme</span><span class="p">:</span><span class="w"> </span><span class="l">internet-facing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/target-type</span><span class="p">:</span><span class="w"> </span><span class="l">ip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">alb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span></code></pre></div><p>이제 로드 밸런서 주소로 요청을 보내면 응답을 보내옵니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## k8s-default-simontes-ea5ab2759b-771587743.ap-northeast-2.elb.amazonaws.com 같은 주소를 가집니다</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">LB_HOST</span><span class="o">=</span><span class="k">$(</span>kubectl get ingress/simon-test-alb -ojson <span class="p">|</span> jq -r .status.loadBalancer.ingress<span class="o">[</span>0<span class="o">]</span>.hostname<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ curl <span class="nv">$LB_HOST</span> --data <span class="s1">&#39;hello world&#39;</span>
</span></span><span class="line"><span class="cl">hello world
</span></span></code></pre></div><h2 id="후기">후기</h2>
<p>확실히 EKS는 ECS에 비해 훨씬 복잡합니다. 그만큼 세세한 컨트롤이 가능하고, AWS에 특화된 개념이 아니라는 것은 장점이라고 봅니다.</p>
<p>이번 글에서는 수동으로 처리해주는 부분이 꽤 있는데 다음에는 더 자동화(Terraform) 해보도록 하겠습니다.</p>
<h2 id="appendix">Appendix</h2>
<ul>
<li>예제 파일: <a href="/file/ko/tech/2022-03-31-2-simon-sample.zip">simon-sample.zip</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html">Amazon EKS의 애플리케이션 로드 밸런싱</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-cluster.html">Amazon EKS 클러스터 생성</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/fargate-getting-started.html">Amazon EKS를 사용하여 AWS Fargate 시작하기</a>
<ul>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/fargate-getting-started.html#fargate-gs-coredns">CoreDNS 업데이트</a></li>
</ul>
</li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-kubeconfig.html">Amazon EKS용 kubeconfig 생성</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html">클러스터에 대한 IAM OIDC 공급자 생성</a></li>
<li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/">AWS Load Balancer Controller</a>
<ul>
<li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/ingress/annotations/">Ingress annotations</a></li>
</ul>
</li>
<li><a href="https://kubernetes.io/ko/docs/home/">쿠버네티스</a>
<ul>
<li><a href="https://kubernetes.io/ko/docs/concepts/workloads/pods/">파드</a></li>
<li><a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/replicaset/">레플리카셋</a></li>
<li><a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/">디플로이먼트</a></li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      
    </div>

    
<div class='col-xs-12 text-center'>
  
  <ul class='pagination'>
    
    <li class='disabled'><span>&laquo; 처음</span></li>
    <li class='disabled'><span>&lt; 이전</span></li>
    

    

    
    
    
    
    <li class='active'><span>1</span></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/2/'>2</a></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/3/'>3</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    <li class='disabled'><span>&hellip;</span></li>
    

    
    <li><a href='/ko/tech/page/2/'>다음 &gt;</a></li>
    <li><a href='/ko/tech/page/14/'>끝 &raquo;</a></li>
    
  </ul>
  
</div>

  </div>

</div>

<div class='container-fluid'>
  <hr>
  <footer>
    <p>
      &copy; 2014-2021 Sangmin Yoon
      <span class='pull-right text-muted'>
        powered by
        <a href='https://gohugo.io/' target='_blank'>Hugo</a>
        ,
        <a href='http://getbootstrap.com/' target='_blank'>Bootstrap</a>
        ,
        <a href='http://www.dnsever.com' target='dnsever'><img src='http://banner.dnsever.com/dnsever-banner_62x15.gif'
            border='0' alt='DNS server, DNS service '></a>
      </span>
    </p>
  </footer>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-48366784-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script src='https://code.jquery.com/jquery-1.12.4.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>

</body>

</html>
