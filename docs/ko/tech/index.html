<!DOCTYPE html>
<html lang='ko'>

<head>
  <meta charset='utf-8'>

  
  <title>sixmen.com: Tech</title>
  
  
  <meta name='author' content='Sangmin Yoon'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>

  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'>
  <link href='/css/style.css?body=1' rel='stylesheet' type='text/css' media='all'>
  <link href='/css/syntax.css?body=1' rel='stylesheet' type='text/css' media='all'>

  <!--[if lt IE 9]>
  <script src='https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js'></script>
  <script src='https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js'></script>
  <![endif]-->
</head>

<body>
<div class='hp-navbar'>
  <div class='container-fluid'>
    <div class='row'>
      <div class='col-xs-12'>
        
        <nav class='hp-nav'>
          <a class='hp-nav-item'
            href='/ko/'>Home</a>
          <a class='hp-nav-item'
            href='/ko/mylife/'>MyLife</a>
          <a class='hp-nav-item'
            href='/ko/travel/'>Travel</a>
          <a class='hp-nav-item active'
            href='/ko/tech/'>Tech</a>
          <a class='hp-nav-item'
            href='/ko/tags/'>Tags</a>
          <a class='hp-nav-item pull-right' href='/en/'>English</a>
        </nav>
      </div>
    </div>
  </div>
</div>



<div class='container'>

  <div class='row' style='margin-top: 20px;'>

    <div class='col-sm-10 col-sm-offset-1'>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-11-15-3-understanding-graphql-4-resolver-arguments-4-info/'>GraphQL 이해하기: (4) 리졸버 인자 - 4. info</a></h2>
          <p class='posts-date'>15 Nov 2022</p>
        </div>
        <div class='panel-body'>
          <p>GraphQL.js 리졸버의 마지막 인자는 info입니다. info는 현재 처리 중인 질의에 대한 정보가 들어가 있습니다. 보통은 리졸버 구현에 info가 필요하지 않지만 최적화나 복잡한 연결을 위해서는 info의 내용이 필요합니다.</p>
<h2 id="variablevalues">variableValues</h2>
<p>variableValues 속성에는 실행시 준 변수 값이 들어있습니다. 그런데 변수를 사용한 경우에만 값이 있기 때문에 생각보다 쓸 만한 곳은 없습니다. 아래 예에서 query도 필드의 인자이지만 variableValues에는 포함되지 않습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">makeExecutableSchema</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@graphql-tools/schema&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">graphql</span><span class="p">,</span> <span class="nx">GraphQLResolveInfo</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;graphql&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">type_defs</span> <span class="o">=</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">type User {
</span></span></span><span class="line"><span class="cl"><span class="sb">  id: ID!
</span></span></span><span class="line"><span class="cl"><span class="sb">  name: String!
</span></span></span><span class="line"><span class="cl"><span class="sb">}
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">type Query {
</span></span></span><span class="line"><span class="cl"><span class="sb">  users(query: String, length: Int): [User!]!
</span></span></span><span class="line"><span class="cl"><span class="sb">}`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Francisco&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Alexander&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Query</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">users</span><span class="o">:</span> <span class="p">(</span><span class="nx">_source</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">_args</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">_context</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">info</span>: <span class="kt">GraphQLResolveInfo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">variableValues</span><span class="p">);</span> <span class="c1">// { length: 5 }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="nx">users</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">User</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="p">(</span><span class="nx">source</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">_args</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">_context</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">info</span>: <span class="kt">GraphQLResolveInfo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">variableValues</span><span class="p">);</span> <span class="c1">// { length: 5 }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">makeExecutableSchema</span><span class="p">({</span> <span class="nx">typeDefs</span>: <span class="kt">type_defs</span><span class="p">,</span> <span class="nx">resolvers</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">await</span> <span class="nx">graphql</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">schema</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">source</span><span class="o">:</span> <span class="sb">`query($length: Int) { users(query: &#34;H&#34;, length: $length) { id name } }`</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">variableValues</span><span class="o">:</span> <span class="p">{</span> <span class="nx">length</span>: <span class="kt">5</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">})();</span>
</span></span></code></pre></div><p>GraphQL Java에서는 DataFetchingEnvironment.getVariables()로 얻을 수 있습니다.</p>
<h2 id="path-fieldname-parenttype-returntype">path, fieldName, parentType, returnType</h2>
<p>path을 통해 현재 리졸버가 어떤 경로에 의해 실행됐는지 알 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">makeExecutableSchema</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@graphql-tools/schema&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">graphql</span><span class="p">,</span> <span class="nx">GraphQLResolveInfo</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;graphql&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">type_defs</span> <span class="o">=</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">type Name {
</span></span></span><span class="line"><span class="cl"><span class="sb">  first: String!
</span></span></span><span class="line"><span class="cl"><span class="sb">  last: String!
</span></span></span><span class="line"><span class="cl"><span class="sb">}
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">type User {
</span></span></span><span class="line"><span class="cl"><span class="sb">  id: ID!
</span></span></span><span class="line"><span class="cl"><span class="sb">  name: Name!
</span></span></span><span class="line"><span class="cl"><span class="sb">}
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">type Query {
</span></span></span><span class="line"><span class="cl"><span class="sb">  users: [User!]!
</span></span></span><span class="line"><span class="cl"><span class="sb">}`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="p">{</span> <span class="nx">first</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="nx">last</span><span class="o">:</span> <span class="s1">&#39;Doe&#39;</span> <span class="p">}</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="p">{</span> <span class="nx">first</span><span class="o">:</span> <span class="s1">&#39;Michael&#39;</span><span class="p">,</span> <span class="nx">last</span><span class="o">:</span> <span class="s1">&#39;Frank&#39;</span> <span class="p">}</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Query</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">users</span><span class="o">:</span> <span class="p">(</span><span class="nx">_source</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">_args</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">_context</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">info</span>: <span class="kt">GraphQLResolveInfo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">users</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">User</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="p">(</span><span class="nx">source</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">_args</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">_context</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">info</span>: <span class="kt">GraphQLResolveInfo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Name</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">first</span><span class="o">:</span> <span class="p">(</span><span class="nx">source</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">_args</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">_context</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">info</span>: <span class="kt">GraphQLResolveInfo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">source</span><span class="p">.</span><span class="nx">first</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">makeExecutableSchema</span><span class="p">({</span> <span class="nx">typeDefs</span>: <span class="kt">type_defs</span><span class="p">,</span> <span class="nx">resolvers</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">await</span> <span class="nx">graphql</span><span class="p">({</span> <span class="nx">schema</span><span class="p">,</span> <span class="nx">source</span><span class="o">:</span> <span class="sb">`query { users { id name { first last } } }`</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">})();</span>
</span></span></code></pre></div><p>다음과 같은 구조의 데이터입니다. users는 배열이기 때문에 중간에 ‘0’이 키로 존재합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span> <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;users&#34;</span><span class="p">,</span> <span class="nt">&#34;typename&#34;</span><span class="p">:</span> <span class="s2">&#34;Query&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;prev&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;prev&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;users&#34;</span><span class="p">,</span> <span class="nt">&#34;typename&#34;</span><span class="p">:</span> <span class="s2">&#34;Query&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="nt">&#34;typename&#34;</span><span class="p">:</span> <span class="s2">&#34;User&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;prev&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;prev&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;prev&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;users&#34;</span><span class="p">,</span> <span class="nt">&#34;typename&#34;</span><span class="p">:</span> <span class="s2">&#34;Query&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="nt">&#34;typename&#34;</span><span class="p">:</span> <span class="s2">&#34;User&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;first&#34;</span><span class="p">,</span> <span class="nt">&#34;typename&#34;</span><span class="p">:</span> <span class="s2">&#34;Name&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>fieldName, parentType, returnType에는 다음 스키마에 해당하는 타입이 들어가 있습니다.</p>
<pre tabindex="0"><code>users, Query, [User!]!
name, User, Name!
first, Name, String!
</code></pre><p>GraphQL Java에서는 DataFetchingEnvironment의 <code>getExecutionStepInfo().getPath()</code>, <code>getField().getName()</code>, <code>getParentType()</code>, <code>getExecutionStepInfo().getType()</code>으로 얻을 수 있습니다.</p>
<h2 id="fieldnodes">fieldNodes</h2>
<p>fieldNodes에는 현재 실행중인 리졸버가 반환해야 하는 필드 정보가 들어가 있습니다. (GraphQL Java에는 getField()로 얻을 수 있습니다.) 쿼리 최적화등에 사용할 수 있어서 가장 많이 쓰는 속성입니다.</p>
<p>위 예에서 각 리졸버에 각각 <code>users { id name { first last } }</code>, <code>name { first last }</code>, <code>first</code>라는 값이 들어온다고 보면 됩니다. GraphQL.js의 내부 구조체를 그대로 주기 때문에 직접 쓰기에는 어렵습니다. 그래서 카카오스타일에서는 <a href="https://github.com/croquiscom/crary-node/tree/master/packages/graphql">@croquiscom/crary-graphql</a>이라는 자체 라이브러리를 만들어 사용하고 있습니다.</p>
<h3 id="getfieldlist">getFieldList</h3>
<p><code>getFieldList(info)</code>를 실행하면 현 리졸버가 반환해야 할 필드 목록을 반환합니다. 위 예에서는 <code>[ 'id', 'name.first', 'name.last' ]</code>, <code>[ 'first', 'last' ]</code>, <code>[]</code>가 실행 결과가 됩니다. 이를 활용해 클라이언트가 요청한 필드만 처리하는 최적화를 할 수 있습니다.</p>
<p>중첩된 필드는 <code>.</code> 으로 묶여 1차원 배열로 반환하는데, 카카오스타일에서 쓰는 ORM인 <a href="https://croquiscom.github.io/cormo/">CORMO</a>에서 객체 컬럼이 있을 때 사용하는 select 구문의 인자로 그대로 쓸 수 있는 형태를 가지고 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">Name</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@cormo</span><span class="p">.</span><span class="nx">Column</span><span class="p">({</span> <span class="kr">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">required</span>: <span class="kt">true</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="kr">public</span> <span class="nx">first</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">@cormo</span><span class="p">.</span><span class="nx">Column</span><span class="p">({</span> <span class="kr">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">required</span>: <span class="kt">true</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="kr">public</span> <span class="nx">last</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">@cormo</span><span class="p">.</span><span class="nx">Model</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">User</span> <span class="kr">extends</span> <span class="nx">cormo</span><span class="p">.</span><span class="nx">BaseModel</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">id</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">@cormo</span><span class="p">.</span><span class="nx">ObjectColumn</span><span class="p">(</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">public</span> <span class="nx">name</span>: <span class="kt">Name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">records</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">where</span><span class="p">().</span><span class="nx">select</span><span class="p">(</span><span class="nx">getFieldList</span><span class="p">(</span><span class="nx">info</span><span class="p">));</span>
</span></span></code></pre></div><p><code>{ users { id name { first } } }</code>와 같이 일부 필드만 요청한 경우 위 코드는 <code>SELECT id, name_first FROM users</code>와 같이 요청한 컬럼만 DB에서 가져오는 최적화된 쿼리로 변환됩니다.</p>
<h3 id="getfieldlist1st">getFieldList1st</h3>
<p>getFieldList1st는 getFieldList와 유사하지만 첫번째 깊이의 필드만 반환합니다. 즉 위 예에서는 <code>[ 'id', 'name' ]</code>, <code>[ 'first', 'last' ]</code>, <code>[]</code> 를 반환합니다.</p>
<p>args 아티클에 있는 total_count, item_list 예에서 <code>getFieldList1st(info).includes('item_list')</code> 조건문을 써서 item_list를 요청한 경우에만 DB에서 목록을 가져오는 최적화를 할 수 있습니다.</p>
<h3 id="addargumenttoinfo-addfieldtoinfo-removeargumentfrominfo-removefieldfrominfo">addArgumentToInfo, addFieldToInfo, removeArgumentFromInfo, removeFieldFromInfo</h3>
<p>카카오스타일에서는 API gateway를 두고 있고, 거기서 GraphQL을 각 마이크로서비스로 분배합니다. 이 때 클라이언트 요청을 일부 변형한 후에 마이크로서비스로 전달할 필요가 있어서 만든 유틸리티입니다. info에 필드를 추가/삭제하거나 인자를 변형할 수 있습니다.</p>
<p>마이크로서비스에서 계정 정보를 반환하는 Query.user(id: ID!) API를 제공한다고 가정해 봅시다. 하지만 API gateway에서는 이 API를 그대로 쓰는게 아니라 현재 로그인한 사용자의 정보를 반환하는 Query.user 형태로 클라이언트에 노출하고 있습니다. 로그인한 사용자 정보는 API gateway가 알고 있고, 마이크로서비스 API 호출시 이를 인자에 추가해줘야 합니다. 이 로직을 다음과 같이 구현하고 있습니다. (hookResolver는 기존 리졸버의 동작 앞뒤에 다른 동작을 추가할 수 있는 유틸리티입니다.)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="nx">hookResolver</span><span class="p">(</span><span class="nx">schema</span><span class="p">.</span><span class="nx">getQueryType</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">getFields</span><span class="p">().</span><span class="nx">user</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">user_id</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">login_user_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">info</span> <span class="o">=</span> <span class="nx">addArgumentToInfo</span><span class="p">(</span><span class="nx">info</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">user_id</span><span class="p">,</span> <span class="k">new</span> <span class="nx">GraphQLNonNull</span><span class="p">(</span><span class="nx">GraphQLID</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 또는 info = info.addArgument(&#39;id&#39;, user_id, new GraphQLNonNull(GraphQLID));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="k">await</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div>
        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-11-15-2-understanding-graphql-4-resolver-arguments-3-context/'>GraphQL 이해하기: (4) 리졸버 인자 - 3. context</a></h2>
          <p class='posts-date'>15 Nov 2022</p>
        </div>
        <div class='panel-body'>
          <p>GraphQL.js 리졸버의 세번째 인자는 context입니다. 이 인자는 온전히 사용자가 설정하는 것으로 매 요청마다 새로 생성되며 같은 요청을 처리하는 리졸버가 상태를 공유하기 위해 사용합니다.</p>
<p>다음과 같이 적당한 값을 넣어서 한번 실행해보면 동작 방식을 금방 이해할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">makeExecutableSchema</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@graphql-tools/schema&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">graphql</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;graphql&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">type_defs</span> <span class="o">=</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">type User {
</span></span></span><span class="line"><span class="cl"><span class="sb">  id: ID!
</span></span></span><span class="line"><span class="cl"><span class="sb">  name: String!
</span></span></span><span class="line"><span class="cl"><span class="sb">}
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">type Query {
</span></span></span><span class="line"><span class="cl"><span class="sb">  users: [User!]!
</span></span></span><span class="line"><span class="cl"><span class="sb">}`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Francisco&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Alexander&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">Context</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">foo</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bar?</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Query</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">users</span><span class="o">:</span> <span class="p">(</span><span class="nx">_source</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">_args</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">context</span>: <span class="kt">Context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">context</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">bar</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">users</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">User</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="p">(</span><span class="nx">source</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">_args</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">context</span>: <span class="kt">Context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">context</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">bar</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">makeExecutableSchema</span><span class="p">({</span> <span class="nx">typeDefs</span>: <span class="kt">type_defs</span><span class="p">,</span> <span class="nx">resolvers</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">await</span> <span class="nx">graphql</span><span class="p">({</span> <span class="nx">schema</span><span class="p">,</span> <span class="nx">source</span><span class="o">:</span> <span class="sb">`query { users { id name } }`</span><span class="p">,</span> <span class="nx">contextValue</span><span class="o">:</span> <span class="p">{</span> <span class="nx">foo</span>: <span class="kt">1</span> <span class="p">}</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="k">await</span> <span class="nx">graphql</span><span class="p">({</span> <span class="nx">schema</span><span class="p">,</span> <span class="nx">source</span><span class="o">:</span> <span class="sb">`query { users { id name } }`</span><span class="p">,</span> <span class="nx">contextValue</span><span class="o">:</span> <span class="p">{</span> <span class="nx">foo</span>: <span class="kt">100</span><span class="p">,</span> <span class="nx">bar</span>: <span class="kt">10</span> <span class="p">}</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">})();</span>
</span></span></code></pre></div><p>실행 결과는 다음과 같습니다.</p>
<pre tabindex="0"><code>users { foo: 1 }
name { foo: 1, bar: 1 }
name { foo: 1, bar: 2 }
users { foo: 100, bar: 10 }
name { foo: 100, bar: 11 }
name { foo: 100, bar: 12 }
</code></pre><p>컨텍스트의 가장 일반적인 사용예는 클라이언트 요청의 부가 정보를 담는 것입니다. 요청시 준 HTTP 헤더, 로그인 상태인 경우 로그인 한 사용자 정보 같은 것들이 있습니다.</p>
<p>다음은 실제 클라이언트 요청을 처리하는 프레임워크인 <a href="https://www.apollographql.com/docs/apollo-server/">Apollo Server</a>에서 컨텍스트를 설정해 본 예제입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">IncomingMessage</span><span class="p">,</span> <span class="nx">ServerResponse</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;http&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">ApolloServer</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@apollo/server&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">startStandaloneServer</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@apollo/server/standalone&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">Context</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">req</span>: <span class="kt">IncomingMessage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">res</span>: <span class="kt">ServerResponse</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Query</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">getUser</span><span class="o">:</span> <span class="p">(</span><span class="nx">_source</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">args</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">context</span>: <span class="kt">Context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">context</span><span class="p">));</span> <span class="c1">// [ &#39;req&#39;, &#39;res&#39; ]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span> <span class="c1">// { host: &#39;localhost:4000&#39;, &#39;content-type&#39;: &#39;application/json&#39;, ... }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="nx">users</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ApolloServer</span><span class="p">({</span> <span class="nx">typeDefs</span><span class="p">,</span> <span class="nx">resolvers</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">await</span> <span class="nx">startStandaloneServer</span><span class="p">&lt;</span><span class="nt">Context</span><span class="p">&gt;(</span><span class="nx">server</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">context</span>: <span class="kt">async</span> <span class="p">({</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">({</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">}),</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">})();</span>
</span></span></code></pre></div><p>GraphQL Java의 경우 GraphQLContext라는 속성으로 제공합니다. DGS Framework의 경우 HTTP 요청을 처리해주는데 이를 제공하기 위해 GraphQLContext를 감싼 DgsContext를 제공합니다. <code>println(dfe.getDgsContext().requestData)</code> 로 내용을 출력해보면 <code>DgsWebMvcRequestData(extensions={}, headers=[host:&quot;localhost:8080&quot;, accept:&quot;application/json&quot;, ...], webRequest=ServletWebRequest: uri=/graphql;client=127.0.0.1)</code> 와 같은 결과를 볼 수 있습니다.</p>
<h2 id="dataloader와-컨텍스트">DataLoader와 컨텍스트</h2>
<p>앞선 글에서 얘기했듯이 리졸버는 독립적으로 동작하는 것이 좋습니다. 그렇다보니 한번에 요청할 수 있는 것을 나눠서 요청하는 N+1 쿼리 문제가 발생합니다. 이를 해결해주는 라이브러리로 <a href="https://github.com/graphql/dataloader">DataLoader</a>가 있습니다. 그런데 이 DataLoader는 요청별로 생성하는 것이 좋습니다. 즉 요청별로 다른 값을 가지는 컨텍스트를 사용할 필요가 있습니다.</p>
<blockquote>
<p>In many applications, a web server using DataLoader serves requests to many different users with different access permissions. It may be dangerous to use one cache across many users, and is encouraged to create a new DataLoader per request:</p>
</blockquote>
<p>필요할 때 DataLoader 인스턴스를 생성하기 위해 카카오스타일에서는 컨텍스트를 활용한 다음 패턴을 주로 사용합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">Context</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">loader</span><span class="o">:</span> <span class="p">{</span> <span class="p">[</span><span class="nx">loader_name</span>: <span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="nx">DataLoader</span><span class="p">&lt;</span><span class="nt">any</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// for Apollo Server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">context</span>: <span class="kt">async</span> <span class="p">({</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">loader</span><span class="o">:</span> <span class="p">{}</span> <span class="p">}),</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// resolver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">my_field</span><span class="p">(</span><span class="nx">soruce</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span>: <span class="kt">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">loader_name</span> <span class="o">=</span> <span class="s1">&#39;MyType.my_field&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">loader</span>: <span class="kt">DataLoader</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">MyFieldType</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">loader</span><span class="p">[</span><span class="nx">loader_name</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">loader</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataLoader</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">MyFieldType</span><span class="p">&gt;(</span><span class="kr">async</span> <span class="p">(</span><span class="nx">keys</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// return Array&lt;MyFieldType&gt; for keys
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">});</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">context</span><span class="p">.</span><span class="nx">loader</span><span class="p">[</span><span class="nx">loader_name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">loader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">key_for_my_field</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>참고로 <a href="https://www.graphql-java.com/documentation/batching">GraphQL Java</a>는 DataLoader에 대한 처리가 라이브러리 내부에 들어와 있습니다. DataLoaderRegistry 클래스를 생성해 ExecutionInput으로 주면 DataFetchingEnvironment.getDataLoader를 통해 DataLoader를 얻을 수 있습니다. <a href="https://netflix.github.io/dgs/data-loaders/">DGS Framework</a>에서는 DgsDataLoader 어노테이션을 통해 등록하면 됩니다.</p>

        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-11-15-1-understanding-graphql-4-resolver-arguments-2-args/'>GraphQL 이해하기: (4) 리졸버 인자 - 2. args</a></h2>
          <p class='posts-date'>15 Nov 2022</p>
        </div>
        <div class='panel-body'>
          <p>GraphQL.js 리졸버의 두번째 인자는 args입니다. 해당 필드에 인자가 주어지면 그 값이 들어옵니다.</p>
<blockquote>
<p>GraphQL Java에서는 DataFetchingEnvironment.getArguments 로 얻을 수 있습니다.</p>
</blockquote>
<h2 id="인자-처리하기">인자 처리하기</h2>
<p>프로그래밍에서 함수 호출에 인자가 있는 것은 당연하기 때문에 어렵지 않은 개념일 겁니다. 다만 GraphQL에서 간과하기 쉬운 특성으로 객체 속성에도 인자를 줄 수 있다는 점이 있습니다. 이를 활용해 데이터를 서버에서 적절히 가공해 클라이언트에 주도록 할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">makeExecutableSchema</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@graphql-tools/schema&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">graphql</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;graphql&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">type_defs</span> <span class="o">=</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">type User {
</span></span></span><span class="line"><span class="cl"><span class="sb">  id: ID!
</span></span></span><span class="line"><span class="cl"><span class="sb">  name(length: Int): String!
</span></span></span><span class="line"><span class="cl"><span class="sb">}
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">type Query {
</span></span></span><span class="line"><span class="cl"><span class="sb">  users(query: String, length: Int): [User!]!
</span></span></span><span class="line"><span class="cl"><span class="sb">}`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">User</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">id</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">users</span>: <span class="kt">User</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Francisco&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Alexander&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Picasso&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Charles&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Frederick&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Nicholas&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Query</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">users</span><span class="o">:</span> <span class="p">(</span><span class="nx">_source</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">args</span><span class="o">:</span> <span class="p">{</span> <span class="nx">query?</span>: <span class="kt">string</span><span class="p">;</span> <span class="nx">length?</span>: <span class="kt">number</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`users args: </span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">filtered</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">query</span> <span class="o">?</span> <span class="nx">users</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">query</span><span class="o">!</span><span class="p">))</span> <span class="o">:</span> <span class="nx">users</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">filtered</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="nx">filtered</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">User</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="p">(</span><span class="nx">source</span>: <span class="kt">User</span><span class="p">,</span> <span class="nx">args</span><span class="o">:</span> <span class="p">{</span> <span class="nx">length?</span>: <span class="kt">number</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`name args: </span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">makeExecutableSchema</span><span class="p">({</span> <span class="nx">typeDefs</span>: <span class="kt">type_defs</span><span class="p">,</span> <span class="nx">resolvers</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">graphql</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">schema</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">source</span><span class="o">:</span> <span class="sb">`query {
</span></span></span><span class="line"><span class="cl"><span class="sb">  a: users(query: &#34;o&#34;, length: 2) { id name }
</span></span></span><span class="line"><span class="cl"><span class="sb">  b: users(length: 2) { id name(length: 3) }
</span></span></span><span class="line"><span class="cl"><span class="sb">  c: users(query: &#34;o&#34;, length: null) { id name(length: null) }
</span></span></span><span class="line"><span class="cl"><span class="sb">}`</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">})();</span>
</span></span></code></pre></div><p>실행 결과는 너무 당연해서 별다른 설명이 필요없습니다.</p>
<pre tabindex="0"><code>users args: {&#34;query&#34;:&#34;o&#34;,&#34;length&#34;:2}
name args: {}
name args: {}
users args: {&#34;length&#34;:2}
name args: {&#34;length&#34;:3}
name args: {&#34;length&#34;:3}
users args: {&#34;query&#34;:&#34;o&#34;,&#34;length&#34;:null}
name args: {&#34;length&#34;:null}
name args: {&#34;length&#34;:null}
name args: {&#34;length&#34;:null}
{
  &#34;data&#34;: {
    &#34;a&#34;: [
      { &#34;id&#34;: &#34;1&#34;, &#34;name&#34;: &#34;Francisco&#34; },
      { &#34;id&#34;: &#34;3&#34;, &#34;name&#34;: &#34;Picasso&#34; }
    ],
    &#34;b&#34;: [
      { &#34;id&#34;: &#34;1&#34;, &#34;name&#34;: &#34;Fra&#34; },
      { &#34;id&#34;: &#34;2&#34;, &#34;name&#34;: &#34;Ale&#34; }
    ],
    &#34;c&#34;: [
      { &#34;id&#34;: &#34;1&#34;, &#34;name&#34;: &#34;Francisco&#34; },
      { &#34;id&#34;: &#34;3&#34;, &#34;name&#34;: &#34;Picasso&#34; },
      { &#34;id&#34;: &#34;6&#34;, &#34;name&#34;: &#34;Nicholas&#34; }
    ]
  }
}
</code></pre><p>하나 주목할 점은 nullable 인자에 null을 준 것과 아예 누락한게 다르다는 점입니다. JavaScript에서 null과 undefined는 모든 사람들에게 혼란을 주는 괴이한 스펙이지만, 가끔은 유용/필요할 때가 있습니다. 다만 GraphQL API는 모든 언어를 생각해야 하기 때문에 null과 누락이 다르다는 특성을 실제 활용한 적은 없습니다.</p>
<p>다음은 DGS Framework로 구현한 예입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">data</span> <span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="k">val</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">users</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">User</span><span class="p">(</span><span class="s2">&#34;1&#34;</span><span class="p">,</span> <span class="s2">&#34;Francisco&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">User</span><span class="p">(</span><span class="s2">&#34;2&#34;</span><span class="p">,</span> <span class="s2">&#34;Alexander&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">User</span><span class="p">(</span><span class="s2">&#34;3&#34;</span><span class="p">,</span> <span class="s2">&#34;Picasso&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">User</span><span class="p">(</span><span class="s2">&#34;4&#34;</span><span class="p">,</span> <span class="s2">&#34;Charles&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">User</span><span class="p">(</span><span class="s2">&#34;5&#34;</span><span class="p">,</span> <span class="s2">&#34;Frederick&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">User</span><span class="p">(</span><span class="s2">&#34;6&#34;</span><span class="p">,</span> <span class="s2">&#34;Nicholas&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@DgsComponent</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserDataFetcher</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DgsQuery</span>
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">users</span><span class="p">(</span><span class="n">dfe</span><span class="p">:</span> <span class="n">DgsDataFetchingEnvironment</span><span class="p">):</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">query</span> <span class="p">=</span> <span class="n">dfe</span><span class="p">.</span><span class="n">getArgument</span><span class="p">&lt;</span><span class="n">String</span><span class="p">?&gt;(</span><span class="s2">&#34;query&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">length</span> <span class="p">=</span> <span class="n">dfe</span><span class="p">.</span><span class="n">getArgument</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">?&gt;(</span><span class="s2">&#34;length&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;users </span><span class="si">${dfe.arguments}</span><span class="s2"> / </span><span class="si">$query</span><span class="s2"> / </span><span class="si">$length</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">filtered</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">query</span> <span class="o">!=</span> <span class="k">null</span><span class="p">)</span> <span class="n">users</span><span class="p">.</span><span class="n">filter</span> <span class="p">{</span> <span class="k">it</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">}</span> <span class="k">else</span> <span class="n">users</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">!=</span> <span class="k">null</span><span class="p">)</span> <span class="n">filtered</span><span class="p">.</span><span class="n">subList</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="k">else</span> <span class="n">filtered</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DgsData</span><span class="p">(</span><span class="n">parentType</span> <span class="p">=</span> <span class="s2">&#34;User&#34;</span><span class="p">,</span> <span class="k">field</span> <span class="p">=</span> <span class="s2">&#34;name&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">name</span><span class="p">(</span><span class="n">dfe</span><span class="p">:</span> <span class="n">DgsDataFetchingEnvironment</span><span class="p">):</span> <span class="n">String</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">length</span> <span class="p">=</span> <span class="n">dfe</span><span class="p">.</span><span class="n">getArgument</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">?&gt;(</span><span class="s2">&#34;length&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;name </span><span class="si">${dfe.arguments}</span><span class="s2"> / </span><span class="si">$length</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">name</span> <span class="p">=</span> <span class="n">dfe</span><span class="p">.</span><span class="n">getSource</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;().</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">!=</span> <span class="k">null</span><span class="p">)</span> <span class="n">name</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="k">else</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>질의 결과는 당연히 동일하고, arguments를 한번 살펴보면 null이 들어온 경우와 값이 주어지지 않은 경우가 구분되는 것을 확인할 수 있습니다.</p>
<pre tabindex="0"><code>users {query=o, length=2} / o / 2
name {} / null
name {} / null
users {length=2} / null / 2
name {length=3} / 3
name {length=3} / 3
users {query=o, length=null} / o / null
name {length=null} / null
name {length=null} / null
name {length=null} / null
</code></pre><h2 id="상위-필드의-인자-사용">상위 필드의 인자 사용</h2>
<p>User 타입의 필드 리졸버를 구현이 필요하다고 생각해봅시다. 그런데 이 User 객체가 getPosts → Post → author를 거쳐 온 것인지, getUser에서 온 것인지 구분할 수가 없습니다. 따라서 리졸버는 가급적 어떤 경로에서 온 것인지 몰라도 동작하도록 구현하는 것이 바람직합니다. 그런데 상위 필드의 인자를 사용한다? 얼핏 봐도 하면 안 되는 일 같지만 아쉽게도 이게 필요한 경우가 있습니다.</p>
<p>서버에서 리소스 목록을 반환하는 API는 기본이라고 볼 수 있죠. 그리고 이 목록이 방대하기 때문에 페이지네이션으로 가져오는 경우도 흔합니다. 페이지네이션을 보여주려면 요청한 목록 외에 전체 리소스 개수도 필요합니다. 물론 GraphQL을 사용하면 목록과 개수를 한번에 요청하는 것이 가능합니다. 흔한 요구사항인 만큼 페이스북이 처음 GraphQL을 내놓을때 <a href="https://relay.dev/graphql/connections.htm">Connections</a> 라는 스펙을 <a href="https://relay.dev/">Relay</a>와 함께 제시했습니다.</p>
<p>이 스펙으로 포스트 목록을 요청하면 다음과 같은 형태가 됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-graphql" data-lang="graphql"><span class="line"><span class="cl"><span class="kd">query</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nc">getPosts</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">totalCount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">pageInfo</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="py">hasNextPage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">edges</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="py">cursor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="py">node</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="py">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="py">title</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="py">author</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="py">name</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>개인적으로 이 스펙은 복잡해서 이해하기 어렵다고 느껴졌기 때문에 카카오스타일에서는 Connection, Edge, Node 대신 단순한 List, Item 개념을 사용해서 목록을 구현하고 있습니다. cursor를 위로 빼서 Edge 필요성을 없애고, hasNextPage를 <code>next_cursor != null</code> 로 대체했다고 보시면 됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-graphql" data-lang="graphql"><span class="line"><span class="cl"><span class="kd">type</span><span class="w"> </span><span class="nc">PostList</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="py">total_count</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="py">item_list</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nc">Post</span><span class="p">!]!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="py">next_cursor</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">type</span><span class="w"> </span><span class="nc">Query</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="py">getPosts</span><span class="p">:</span><span class="w"> </span><span class="nc">PostList</span><span class="p">!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>항상 글 전체 목록만 가져올리는 없겠죠? 원하는 글 목록에 대한 조건을 추가해봅시다. 페이지네이션은 전통적인 방식인 OFFSET &amp; LIMIT으로 구현하기로 했습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-graphql" data-lang="graphql"><span class="line"><span class="cl"><span class="kd">type</span><span class="w"> </span><span class="nc">Query</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="py">getPosts</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="py">author_id</span><span class="p">:</span><span class="w"> </span><span class="nc">ID</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="py">date_created_gte</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="py">date_created_lt</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="py">title_contains</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="py">limit</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="py">skip</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">):</span><span class="w"> </span><span class="nc">PostList</span><span class="p">!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>total_count, item_list를 구현할 때 위 인자를 모두 알아야 합니다. (total_count 구현시에는 limit, skip이 필요하지 않습니다) 하지만 이 리졸버에서 getPosts의 인자를 얻을 방법이 없습니다. 그렇다고 total_count, item_list에 인자를 중복 기술하는 것은 좋아보이지 않습니다.</p>
<p>이전 source 설명 아티클에서 말씀드린 테크닉을 사용하면 상위 인자를 얻을 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Query</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">getPosts</span><span class="o">:</span> <span class="p">(</span><span class="nx">_source</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">args</span>: <span class="kt">GetPostsArgs</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">__args</span>: <span class="kt">args</span> <span class="p">}),</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">PostList</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">total_count</span><span class="o">:</span> <span class="p">({</span> <span class="nx">__args</span>: <span class="kt">args</span> <span class="p">}</span><span class="o">:</span> <span class="p">{</span> <span class="nx">__args</span>: <span class="kt">GetPostsArgs</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// get total count with arguments
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">item_list</span><span class="o">:</span> <span class="p">({</span> <span class="nx">__args</span>: <span class="kt">args</span> <span class="p">}</span><span class="o">:</span> <span class="p">{</span> <span class="nx">__args</span>: <span class="kt">GetPostsArgs</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// get item list with arguments
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>원 리졸버의 args와 헷갈리기 때문에 익숙해지려면 시간이 걸리지만 동작은 합니다. 이 테크닉을 사용하지 않으려면 getPosts에서 total_count, item_list를 모두 구해 반환하면 됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Query</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">getPosts</span><span class="o">:</span> <span class="p">(</span><span class="nx">_source</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">args</span>: <span class="kt">GetPostsArgs</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">total_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// get total count with arguments
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kr">const</span> <span class="nx">item_list</span> <span class="o">=</span> <span class="p">[];</span> <span class="c1">// get item list with arguments
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="p">{</span> <span class="nx">total_count</span><span class="p">,</span> <span class="nx">item_list</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>이 경우 내가 total_count, item_list 중 하나만 요청한 경우에도 나머지를 계산해야 하는 비효율이 발생합니다. (다음에 설명할 info를 사용해 최적화할 수는 있습니다) 어느 쪽이든 그렇게 깔끔하지는 않습니다만, 개인적으로는 주로 전자의 패턴을 많이 사용하고 있습니다. (후자로 한 경우도 있습니다.) 상위 인자를 접근하는 것은 일반적으로 좋지 않은 패턴이므로 위와 같이 실질적으로 하나의 쌍으로 간주되는 경우만 사용하시는 것이 좋습니다.</p>
<p>GraphQL Java도 똑같이 구현할 수 있지만, 상위 필드가 반환해주는 값을 별도로 전달 받을 수 있는 localContext 라는 개념이 있어 이를 활용할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PostDataFetcher</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">data</span> <span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="k">val</span> <span class="py">title</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="k">val</span> <span class="py">author</span><span class="n">_id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">data</span> <span class="k">class</span> <span class="nc">PostList</span><span class="p">(</span><span class="k">val</span> <span class="py">total</span><span class="n">_count</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="k">val</span> <span class="py">item</span><span class="n">_list</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">&gt;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DgsQuery</span>
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">getPosts</span><span class="p">(</span><span class="n">dfe</span><span class="p">:</span> <span class="n">DgsDataFetchingEnvironment</span><span class="p">):</span> <span class="n">DataFetcherResult</span><span class="p">&lt;</span><span class="n">PostList</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;getPosts </span><span class="si">${dfe.arguments}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">DataFetcherResult</span><span class="p">.</span><span class="n">newResult</span><span class="p">&lt;</span><span class="n">PostList</span><span class="p">&gt;()</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="k">data</span><span class="p">(</span><span class="n">PostList</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">emptyList</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">localContext</span><span class="p">(</span><span class="n">dfe</span><span class="p">.</span><span class="n">arguments</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DgsData</span><span class="p">(</span><span class="n">parentType</span> <span class="p">=</span> <span class="s2">&#34;PostList&#34;</span><span class="p">,</span> <span class="k">field</span> <span class="p">=</span> <span class="s2">&#34;total_count&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">totalCount</span><span class="p">(</span><span class="n">dfe</span><span class="p">:</span> <span class="n">DgsDataFetchingEnvironment</span><span class="p">):</span> <span class="n">Int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;totalCount </span><span class="si">${dfe.getLocalContext&lt;Map&lt;String, Object&gt;&gt;()}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">10</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DgsData</span><span class="p">(</span><span class="n">parentType</span> <span class="p">=</span> <span class="s2">&#34;PostList&#34;</span><span class="p">,</span> <span class="k">field</span> <span class="p">=</span> <span class="s2">&#34;item_list&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">itemList</span><span class="p">(</span><span class="n">dfe</span><span class="p">:</span> <span class="n">DgsDataFetchingEnvironment</span><span class="p">):</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;itemList </span><span class="si">${dfe.getLocalContext&lt;Map&lt;String, Object&gt;&gt;()}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">listOf</span><span class="p">(</span><span class="n">Post</span><span class="p">(</span><span class="s2">&#34;1&#34;</span><span class="p">,</span> <span class="s2">&#34;Post 1&#34;</span><span class="p">,</span> <span class="s2">&#34;51&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
        </div>
      </div>
      
    </div>

    
<div class='col-xs-12 text-center'>
  
  <ul class='pagination'>
    
    <li class='disabled'><span>&laquo; 처음</span></li>
    <li class='disabled'><span>&lt; 이전</span></li>
    

    

    
    
    
    
    <li class='active'><span>1</span></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/2/'>2</a></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/3/'>3</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    <li class='disabled'><span>&hellip;</span></li>
    

    
    <li><a href='/ko/tech/page/2/'>다음 &gt;</a></li>
    <li><a href='/ko/tech/page/17/'>끝 &raquo;</a></li>
    
  </ul>
  
</div>

  </div>

</div>

<div class='container-fluid'>
  <hr>
  <footer>
    <p>
      &copy; 2014-2021 Sangmin Yoon
      <span class='pull-right text-muted'>
        powered by
        <a href='https://gohugo.io/' target='_blank'>Hugo</a>
        ,
        <a href='http://getbootstrap.com/' target='_blank'>Bootstrap</a>
        ,
        <a href='http://www.dnsever.com' target='dnsever'><img src='http://banner.dnsever.com/dnsever-banner_62x15.gif'
            border='0' alt='DNS server, DNS service '></a>
      </span>
    </p>
  </footer>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-48366784-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script src='https://code.jquery.com/jquery-1.12.4.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>

</body>

</html>
