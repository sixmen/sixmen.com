<!DOCTYPE html>
<html lang='ko'>

<head>
  <meta charset='utf-8'>

  
  <title>sixmen.com: Tech</title>
  
  
  <meta name='author' content='Sangmin Yoon'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>

  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'>
  <link href='/css/style.css?body=1' rel='stylesheet' type='text/css' media='all'>
  <link href='/css/syntax.css?body=1' rel='stylesheet' type='text/css' media='all'>

  <!--[if lt IE 9]>
  <script src='https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js'></script>
  <script src='https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js'></script>
  <![endif]-->
</head>

<body>
<div class='hp-navbar'>
  <div class='container-fluid'>
    <div class='row'>
      <div class='col-xs-12'>
        
        <nav class='hp-nav'>
          <a class='hp-nav-item'
            href='/ko/'>Home</a>
          <a class='hp-nav-item'
            href='/ko/mylife/'>MyLife</a>
          <a class='hp-nav-item'
            href='/ko/travel/'>Travel</a>
          <a class='hp-nav-item active'
            href='/ko/tech/'>Tech</a>
          <a class='hp-nav-item'
            href='/ko/tags/'>Tags</a>
          <a class='hp-nav-item pull-right' href='/en/'>English</a>
        </nav>
      </div>
    </div>
  </div>
</div>



<div class='container'>

  <div class='row' style='margin-top: 20px;'>

    <div class='col-sm-10 col-sm-offset-1'>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-03-31-3-build-eks-cluster-with-terraform/'>Terraform으로 EKS 구축하기</a></h2>
          <p class='posts-date'>31 Mar 2022</p>
        </div>
        <div class='panel-body'>
          <p><a href="/ko/tech/2022-03-31-2-web-application-using-eks/">이전 글</a>에서는 ECS / EKS에서 서비스 하는 것에 대한 개념을 풀어 써봤습니다. 이번 글에서는 잘 만들어진 모듈을 이용해 빠르게 구성해보겠습니다.</p>
<blockquote>
<p>모듈을 이용하면 편하긴 하지만 내부 개념을 정확히 이해하지 못한 채 사용하면 문제가 발생했을 때 해결이 어려운 것 같습니다. 결국 기본이 중요하다고 생각합니다.</p>
</blockquote>
<h2 id="vpc-셋업">VPC 셋업</h2>
<p><a href="https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest">VPC 모듈</a>을 사용하면 이전에 길게 썼던 것을 짧게 기술할 수 있습니다. 이전에 만든 VPC 구조와 같지만 NAT 게이트웨이가 AZ 별로 따로 존재합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;aws&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  region</span> <span class="o">=</span> <span class="s2">&#34;ap-northeast-2&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span> <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="s2">&#34;vpc&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  source</span> <span class="o">=</span> <span class="s2">&#34;terraform-aws-modules/vpc/aws&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr</span> <span class="o">=</span> <span class="s2">&#34;10.194.0.0/16&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  azs</span>             <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;ap-northeast-2a&#34;, &#34;ap-northeast-2c&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  public_subnets</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.0.0/24&#34;, &#34;10.194.1.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  private_subnets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.100.0/24&#34;, &#34;10.194.101.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  enable_nat_gateway</span>     <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="n">  one_nat_gateway_per_az</span> <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  enable_dns_hostnames</span> <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  public_subnet_tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/role/elb&#34;</span>                      <span class="o">=</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  private_subnet_tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/role/internal-elb&#34;</span>             <span class="o">=</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="eks-클러스터-생성">EKS 클러스터 생성</h2>
<p><a href="https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest">AWS EKS 모듈</a>을 사용하면 EKS 클러스터도 쉽게 생성가능합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">module</span> <span class="s2">&#34;eks&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  source</span> <span class="o">=</span> <span class="s2">&#34;terraform-aws-modules/eks/aws&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span>                    <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cluster_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_version</span>                 <span class="o">=</span> <span class="s2">&#34;1.21&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_endpoint_private_access</span> <span class="o">=</span> <span class="kt">false</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_endpoint_public_access</span>  <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  cluster_addons</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    coredns</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      resolve_conflicts</span> <span class="o">=</span> <span class="s2">&#34;OVERWRITE&#34;</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl"><span class="n">    kube-proxy</span> <span class="o">=</span> {}
</span></span><span class="line"><span class="cl"><span class="n">    vpc-cni</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      resolve_conflicts</span> <span class="o">=</span> <span class="s2">&#34;OVERWRITE&#34;</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>     <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">vpc</span><span class="p">.</span><span class="k">vpc_id</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnet_ids</span> <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">vpc</span><span class="p">.</span><span class="k">private_subnets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  cloudwatch_log_group_retention_in_days</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  fargate_profiles</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    default</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      name</span> <span class="o">=</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">      selectors</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        {
</span></span><span class="line"><span class="cl"><span class="n">          namespace</span> <span class="o">=</span> <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">        }<span class="p">,</span>
</span></span><span class="line"><span class="cl">        {
</span></span><span class="line"><span class="cl"><span class="n">          namespace</span> <span class="o">=</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>coredns 모듈 생성에서 계속 멈춰 있는 것을 볼 수 있습니다. Fargate만 있어서인데, <a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-getting-started.html#fargate-gs-coredns">CoreDNS 패치를 해 주면</a>
잠시 후 완료됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ aws eks update-kubeconfig --region ap-northeast-2 --name simon-test --alias simon-test
</span></span><span class="line"><span class="cl">$ kubectl patch deployment coredns -n kube-system --type json -p<span class="o">=</span><span class="s1">&#39;[{&#34;op&#34;: &#34;remove&#34;, &#34;path&#34;: &#34;/spec/template/metadata/annotations/eks.amazonaws.com~1compute-type&#34;}]&#39;</span>
</span></span></code></pre></div><h2 id="aws-load-balancer-controller-설치">AWS Load Balancer Controller 설치</h2>
<p><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/aws-load-balancer-controller.html">AWS Load Balancer Controller</a>도 Terraform으로 설치가능합니다. 관련된 모듈이 여러 개 있는데 미묘하게 다 동작을 하지 않아서 결국은 자체적으로 구현해봤습니다. 이전에 쉘에서 실행한 명령을 Terraform으로 구성했다고 보시면 됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  lb_controller_iam_role_name</span>        <span class="o">=</span> <span class="s2">&#34;inhouse-eks-aws-lb-ctrl&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  lb_controller_service_account_name</span> <span class="o">=</span> <span class="s2">&#34;aws-load-balancer-controller&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">data</span> <span class="s2">&#34;aws_eks_cluster_auth&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cluster_name</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;helm&#34;</span> {
</span></span><span class="line"><span class="cl">  <span class="k">kubernetes</span> {
</span></span><span class="line"><span class="cl"><span class="n">    host</span>                   <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_endpoint</span>
</span></span><span class="line"><span class="cl"><span class="n">    token</span>                  <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="k">aws_eks_cluster_auth</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">token</span>
</span></span><span class="line"><span class="cl"><span class="n">    cluster_ca_certificate</span> <span class="o">=</span> <span class="k">base64decode</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_certificate_authority_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="s2">&#34;lb_controller_role&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  source</span> <span class="o">=</span> <span class="s2">&#34;terraform-aws-modules/iam/aws//modules/iam-assumable-role-with-oidc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  create_role</span> <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  role_name</span>        <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">lb_controller_iam_role_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  role_path</span>        <span class="o">=</span> <span class="s2">&#34;/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role_description</span> <span class="o">=</span> <span class="s2">&#34;Used by AWS Load Balancer Controller for EKS&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  role_permissions_boundary_arn</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  provider_url</span> <span class="o">=</span> <span class="k">replace</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_oidc_issuer_url</span><span class="p">,</span> <span class="s2">&#34;https://&#34;, &#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">  oidc_fully_qualified_subjects</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;system:serviceaccount:kube-system:${local.lb_controller_service_account_name}&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  oidc_fully_qualified_audiences</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;sts.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">data</span> <span class="s2">&#34;http&#34; &#34;iam_policy&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  url</span> <span class="o">=</span> <span class="s2">&#34;https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.0/docs/install/iam_policy.json&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy&#34; &#34;controller&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name_prefix</span> <span class="o">=</span> <span class="s2">&#34;AWSLoadBalancerControllerIAMPolicy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  policy</span>      <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="k">http</span><span class="p">.</span><span class="k">iam_policy</span><span class="p">.</span><span class="k">body</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>        <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">lb_controller_role</span><span class="p">.</span><span class="k">iam_role_name</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;helm_release&#34; &#34;release&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span>       <span class="o">=</span> <span class="s2">&#34;aws-load-balancer-controller&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  chart</span>      <span class="o">=</span> <span class="s2">&#34;aws-load-balancer-controller&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  repository</span> <span class="o">=</span> <span class="s2">&#34;https://aws.github.io/eks-charts&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  namespace</span>  <span class="o">=</span> <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">dynamic</span> <span class="s2">&#34;set&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">    for_each</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      &#34;clusterName&#34;</span>           <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_id</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;serviceAccount.create&#34;</span> <span class="o">=</span> <span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;serviceAccount.name&#34;</span>   <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">lb_controller_service_account_name</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;region&#34;</span>                <span class="o">=</span> <span class="s2">&#34;ap-northeast-2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;vpcId&#34;</span>                 <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">vpc</span><span class="p">.</span><span class="k">vpc_id</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;image.repository&#34;</span>      <span class="o">=</span> <span class="s2">&#34;602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon/aws-load-balancer-controller&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">      &#34;serviceAccount.annotations.eks\\.amazonaws\\.com/role-arn&#34;</span> <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">lb_controller_role</span><span class="p">.</span><span class="k">iam_role_arn</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    <span class="k">content</span> {
</span></span><span class="line"><span class="cl"><span class="n">      name</span>  <span class="o">=</span> <span class="k">set</span><span class="p">.</span><span class="k">key</span>
</span></span><span class="line"><span class="cl"><span class="n">      value</span> <span class="o">=</span> <span class="k">set</span><span class="p">.</span><span class="k">value</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="어플리케이션-구동">어플리케이션 구동</h2>
<p>간단한 서버(이번에는 공개 서버 - <code>k8s.gcr.io/echoserver</code> -를 이용합니다)를 Terraform으로 구성하겠습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;kubernetes&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  host</span>                   <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_endpoint</span>
</span></span><span class="line"><span class="cl"><span class="n">  token</span>                  <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="k">aws_eks_cluster_auth</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">token</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_ca_certificate</span> <span class="o">=</span> <span class="k">base64decode</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_certificate_authority_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;kubernetes_deployment&#34; &#34;echo&#34;</span> {
</span></span><span class="line"><span class="cl">  <span class="k">metadata</span> {
</span></span><span class="line"><span class="cl"><span class="n">    name</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  <span class="k">spec</span> {
</span></span><span class="line"><span class="cl"><span class="n">    replicas</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">selector</span> {
</span></span><span class="line"><span class="cl"><span class="n">      match_labels</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">        &#34;app.kubernetes.io/name&#34;</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    <span class="k">template</span> {
</span></span><span class="line"><span class="cl">      <span class="k">metadata</span> {
</span></span><span class="line"><span class="cl"><span class="n">        labels</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">          &#34;app.kubernetes.io/name&#34;</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">      <span class="k">spec</span> {
</span></span><span class="line"><span class="cl">        <span class="k">container</span> {
</span></span><span class="line"><span class="cl"><span class="n">          image</span> <span class="o">=</span> <span class="s2">&#34;k8s.gcr.io/echoserver:1.10&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">          name</span>  <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;kubernetes_service&#34; &#34;echo&#34;</span> {
</span></span><span class="line"><span class="cl">  <span class="k">metadata</span> {
</span></span><span class="line"><span class="cl"><span class="n">    name</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  <span class="k">spec</span> {
</span></span><span class="line"><span class="cl"><span class="n">    selector</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      &#34;app.kubernetes.io/name&#34;</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    <span class="k">port</span> {
</span></span><span class="line"><span class="cl"><span class="n">      port</span>        <span class="o">=</span> <span class="m">8080</span>
</span></span><span class="line"><span class="cl"><span class="n">      target_port</span> <span class="o">=</span> <span class="m">8080</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl"><span class="n">    type</span> <span class="o">=</span> <span class="s2">&#34;NodePort&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;kubernetes_ingress_v1&#34; &#34;alb&#34;</span> {
</span></span><span class="line"><span class="cl">  <span class="k">metadata</span> {
</span></span><span class="line"><span class="cl"><span class="n">    name</span> <span class="o">=</span> <span class="s2">&#34;alb&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    annotations</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      &#34;alb.ingress.kubernetes.io/scheme&#34;</span>      <span class="o">=</span> <span class="s2">&#34;internet-facing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;alb.ingress.kubernetes.io/target-type&#34;</span> <span class="o">=</span> <span class="s2">&#34;ip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  <span class="k">spec</span> {
</span></span><span class="line"><span class="cl"><span class="n">    ingress_class_name</span> <span class="o">=</span> <span class="s2">&#34;alb&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">rule</span> {
</span></span><span class="line"><span class="cl">      <span class="k">http</span> {
</span></span><span class="line"><span class="cl">        <span class="k">path</span> {
</span></span><span class="line"><span class="cl">          <span class="k">backend</span> {
</span></span><span class="line"><span class="cl">            <span class="k">service</span> {
</span></span><span class="line"><span class="cl"><span class="n">              name</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="k">port</span> {
</span></span><span class="line"><span class="cl"><span class="n">                number</span> <span class="o">=</span> <span class="m">8080</span>
</span></span><span class="line"><span class="cl">              }
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">          }
</span></span><span class="line"><span class="cl"><span class="n">          path</span> <span class="o">=</span> <span class="s2">&#34;/*&#34;</span>
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>이제 로드 밸런서 주소로 요청을 보내면 응답을 보내옵니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># k8s-default-alb-622014ceba-1089817135.ap-northeast-2.elb.amazonaws.com 같은 주소를 가집니다</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">LB_HOST</span><span class="o">=</span><span class="k">$(</span>kubectl get ingress/alb -ojson <span class="p">|</span> jq -r <span class="s2">&#34;.status.loadBalancer.ingress[0].hostname&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">$ curl <span class="nv">$LB_HOST</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Hostname: echo-5499565745-tk7dm
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Pod Information:
</span></span><span class="line"><span class="cl">	-no pod information available-
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Server values:
</span></span><span class="line"><span class="cl">	<span class="nv">server_version</span><span class="o">=</span>nginx: 1.13.3 - lua: <span class="m">10008</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Request Information:
</span></span><span class="line"><span class="cl">	<span class="nv">client_address</span><span class="o">=</span>10.194.1.162
</span></span><span class="line"><span class="cl">	<span class="nv">method</span><span class="o">=</span>GET
</span></span><span class="line"><span class="cl">	real <span class="nv">path</span><span class="o">=</span>/
</span></span><span class="line"><span class="cl">	<span class="nv">query</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">	<span class="nv">request_version</span><span class="o">=</span>1.1
</span></span><span class="line"><span class="cl">	<span class="nv">request_scheme</span><span class="o">=</span>http
</span></span><span class="line"><span class="cl">	<span class="nv">request_uri</span><span class="o">=</span>http://k8s-default-alb-622014ceba-1089817135.ap-northeast-2.elb.amazonaws.com:8080/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Request Headers:
</span></span><span class="line"><span class="cl">	<span class="nv">accept</span><span class="o">=</span>*/*
</span></span><span class="line"><span class="cl">	<span class="nv">host</span><span class="o">=</span>k8s-default-alb-622014ceba-1089817135.ap-northeast-2.elb.amazonaws.com
</span></span><span class="line"><span class="cl">	user-agent<span class="o">=</span>curl/7.77.0
</span></span><span class="line"><span class="cl">	x-amzn-trace-id<span class="o">=</span><span class="nv">Root</span><span class="o">=</span>1-6244434a-56cbdde1124166e4168d1cf4
</span></span><span class="line"><span class="cl">	x-forwarded-for<span class="o">=</span>1.2.3.4
</span></span><span class="line"><span class="cl">	x-forwarded-port<span class="o">=</span><span class="m">80</span>
</span></span><span class="line"><span class="cl">	x-forwarded-proto<span class="o">=</span>http
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Request Body:
</span></span><span class="line"><span class="cl">	-no body in request-
</span></span></code></pre></div><p>위 예에서는 같은 Terraform 파일에서 정의를 했기 때문에 module.eks의 출력을 이용했습니다. 만약 별도 스택으로 정의를 할 예정이고, kubeconfig가 설정된 상태면 다음과 같이 provider를 설정할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;kubernetes&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  config_path</span>    <span class="o">=</span> <span class="s2">&#34;~/.kube/config&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  config_context</span> <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="후기">후기</h2>
<p>EKS 시리즈 글을 작성하면서 클러스터 생성을 여러 번 반복했습니다. 반복할 때마다 하나씩 빼먹어서 문제점을 찾는데 한참 걸렸습니다. 그에 비해 잘 구성된 Terraform 모듈을 활용하니 확실히 편했습니다.</p>
<p>하지만 각 단계를 한번씩 해봐서 전체적인 이해가 된 상황(서브넷 태깅이 왜 필요한지, CoreDNS는 왜 생성되지 않는지등)이여서 모듈 활용도 가능했다고 봅니다.</p>
<p>이번 예에서는 예제 파일을 단순하게 하기 위해서, 쿠버네티스에서 동작하는 어플리케이션까지 Terraform으로 구성해봤습니다. Terraform으로 인프라를 통일하면 좋다고 생각하지만, 쿠버네티스는 별개의 정의 스펙이 있다보니 애매한 점이 있는 것 같습니다. 실제로 저희 실 서비스의 경우는 Terraform이 아니라 <a href="https://helm.sh/">Helm Charts</a>를 사용해 어플리케이션을 정의했습니다.</p>
<p>이번 글이 쿠버네티스와 EKS를 이해하는데 도움이 되었기를 바랍니다.</p>
<h2 id="appendix">Appendix</h2>
<ul>
<li>예제 파일: <a href="/file/ko/tech/2022-03-31-3-simon-sample.zip">simon-sample.zip</a></li>
<li><a href="https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest">terraform-aws-modules/vpc/aws | Terraform Registry</a></li>
<li><a href="https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest">terraform-aws-modules/eks/aws | Terraform Registry</a></li>
<li>AWS Load Balancer Controller 모듈
<ul>
<li><a href="https://registry.terraform.io/modules/Young-ook/eks/aws/latest/examples/lb">Young-ook/eks/aws | Terraform Registry</a></li>
<li><a href="https://registry.terraform.io/modules/DNXLabs/eks-lb-controller/aws/latest">DNXLabs/eks-lb-controller/aws | Terraform Registry</a></li>
<li><a href="https://registry.terraform.io/modules/basisai/lb-controller/aws/latest">basisai/lb-controller/aws | Terraform Registry</a></li>
</ul>
</li>
<li><a href="https://phoenixnap.com/blog/helm-vs-terraform">Helm vs Terraform: What Are the Differences</a></li>
<li><a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs">Kubernetes Provider</a></li>
</ul>

        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-03-31-2-web-application-using-eks/'>EKS를 사용해서 어플리케이션 서비스 하기</a></h2>
          <p class='posts-date'>31 Mar 2022</p>
        </div>
        <div class='panel-body'>
          <p><a href="/ko/tech/2022-03-31-1-web-application-using-ecs/">ECS 아티클</a>에 이어 이번 글에서는 같은 서비스를 EKS로 구축해보도록 하겠습니다.</p>
<p>간단하게 구축하는 것은 <a href="https://eksctl.io/">eksctl</a>을 쓰면 되지만, 내부 이해를 위해 여기서는 기본부터 구현하도록 하겠습니다.</p>
<h2 id="vpc-셋업">VPC 셋업</h2>
<p>VPC는 이전과 마찬가지로 두 개의 AZ에 퍼블릭 서브넷과 프리이빗 서브넷이 필요합니다. 다만 로드 밸런서가 정상적으로 배치되려며 특정한 태그를 서브넷에 부여해야합니다.</p>
<p><img src="/img/ko/tech/2022-03-31-2-01.png" alt="Sample VPC"></p>
<p>서비스 컨테이너만 정의하는 ECS와 달리 쿠버네티스는 클러스터 내에서 로드 밸런서, 영구 볼륨등도 정의할 수 있습니다. 이때 정의는 쿠버네티스안에서 하지만 실제 만들어지는 것은 쿠버네티스와 무관한 AWS 리소스(ALB, EBS등)입니다. 쿠버네티스 자체는 AWS 구조와 독립적이고, 태그등 다른 방법을 통해 쿠버네티스 리소스가 위치할 AWS 리소스를 찾게 됩니다.</p>
<p><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html">EKS에서 애플리케이션 로드 밸런싱 문서</a>에 따라 다음 태그를 설정해줍니다.</p>
<ul>
<li><code>kubernetes.io/cluster/&lt;name&gt;</code>: <code>shared</code></li>
<li><code>kubernetes.io/role/internal-elb</code>: 프라이빗 서브넷에 대해 <code>1</code>로 설정합니다.</li>
<li><code>kubernetes.io/role/elb</code>: 퍼블릭 서브넷에 대해 <code>1</code>로 설정합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;aws&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  region</span> <span class="o">=</span> <span class="s2">&#34;ap-northeast-2&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_name</span>        <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr</span>            <span class="o">=</span> <span class="s2">&#34;10.194.0.0/16&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  public_subnets</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.0.0/24&#34;, &#34;10.194.1.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  private_subnets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.100.0/24&#34;, &#34;10.194.101.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  azs</span>             <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;ap-northeast-2a&#34;, &#34;ap-northeast-2c&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span>    <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC를 생성합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_vpc&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cidr</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>       <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">vpc_name</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC 생성시 기본으로 생성되는 라우트 테이블에 이름을 붙입니다
</span></span></span><span class="line"><span class="cl"><span class="c1">## 이걸 서브넷에 연결해 써도 되지만, 여기서는 사용하지 않습니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_default_route_table&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  default_route_table_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">default_route_table_id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>                   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-default&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC 생성시 기본으로 생성되는 보안 그룹에 이름을 붙입니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_default_security_group&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-default&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷에 연결할 인터넷 게이트웨이를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_internet_gateway&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-igw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷에 적용할 라우팅 테이블
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-public&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷에서 인터넷에 트래픽 요청시 앞서 정의한 인터넷 게이트웨이로 보냅니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route&#34; &#34;public_worldwide&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span>         <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  destination_cidr_block</span> <span class="o">=</span> <span class="s2">&#34;0.0.0.0/0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  gateway_id</span>             <span class="o">=</span> <span class="k">aws_internet_gateway</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷을 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_subnet&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">)</span><span class="c1"> # 여러개를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>                  <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span>              <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  availability_zone</span>       <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">azs</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  map_public_ip_on_launch</span> <span class="o">=</span> <span class="kt">true</span><span class="c1"> # 퍼플릭 서브넷에 배치되는 서비스는 자동으로 공개 IP를 부여합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-public-${count.index + 1}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span><span class="p">,</span><span class="c1"> # 다른 부분
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">    &#34;kubernetes.io/role/elb&#34;</span>                      <span class="o">=</span> <span class="s2">&#34;1&#34;</span><span class="c1"> # 다른 부분
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷을 라우팅 테이블에 연결합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table_association&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>      <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">public</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span> <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## NAT 게이트웨이는 고정 IP를 필요로 합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_eip&#34; &#34;nat_gateway&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc</span>  <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-natgw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷에서 인터넷 접속시 사용할 NAT 게이트웨이
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_nat_gateway&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  allocation_id</span> <span class="o">=</span> <span class="k">aws_eip</span><span class="p">.</span><span class="k">nat_gateway</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>     <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">public</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="k">id</span><span class="c1"> # NAT 게이트웨이 자체는 퍼플릭 서브넷에 위치해야 합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  tags</span>          <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-natgw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷에 적용할 라우팅 테이블
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-private&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷에서 인터넷에 트래픽 요청시 앞서 정의한 NAT 게이트웨이로 보냅니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route&#34; &#34;private_worldwide&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span>         <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">private</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  destination_cidr_block</span> <span class="o">=</span> <span class="s2">&#34;0.0.0.0/0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  nat_gateway_id</span>         <span class="o">=</span> <span class="k">aws_nat_gateway</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷을 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_subnet&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">)</span><span class="c1"> # 여러개를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>            <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span>        <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  availability_zone</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">azs</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-private-${count.index + 1}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span><span class="p">,</span><span class="c1"> # 다른 부분
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">    &#34;kubernetes.io/role/internal-elb&#34;</span>             <span class="o">=</span> <span class="s2">&#34;1&#34;</span><span class="c1"> # 다른 부분
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷을 라우팅 테이블에 연결합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table_association&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>      <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span> <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">private</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="eks-클러스터-생성">EKS 클러스터 생성</h2>
<p>ECS가 하나의 리소스로 끝난 것에 비해 EKS는 조금 복잡합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1">## 클러스터가 사용할 역할을 정의합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1">## AmazonEKSClusterPolicy와 AmazonEKSVPCResourceController를 포함합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_iam_role&#34; &#34;cluster&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;${local.cluster_name}-eks-cluster-role&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  assume_role_policy</span> <span class="o">=</span> <span class="k">jsonencode</span><span class="p">(</span>{
</span></span><span class="line"><span class="cl"><span class="n">    Version</span> <span class="o">=</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    Statement</span> <span class="o">=</span> <span class="p">[</span>{
</span></span><span class="line"><span class="cl"><span class="n">      Effect</span> <span class="o">=</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Principal</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">        Service</span> <span class="o">=</span> <span class="s2">&#34;eks.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">      }<span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Action</span> <span class="o">=</span> <span class="s2">&#34;sts:AssumeRole&#34;</span>
</span></span><span class="line"><span class="cl">    }<span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy_attachment&#34; &#34;cluster_AmazonEKSClusterPolicy&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  policy_arn</span> <span class="o">=</span> <span class="s2">&#34;arn:aws:iam::aws:policy/AmazonEKSClusterPolicy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy_attachment&#34; &#34;cluster_AmazonEKSVPCResourceController&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  policy_arn</span> <span class="o">=</span> <span class="s2">&#34;arn:aws:iam::aws:policy/AmazonEKSVPCResourceController&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## EKS 클러스터를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_eks_cluster&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span>     <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cluster_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  role_arn</span> <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl">  <span class="k">vpc_config</span> {
</span></span><span class="line"><span class="cl"><span class="n">    subnet_ids</span> <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl"><span class="n">  depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="c1"> # see https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/eks_cluster#example-usage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">aws_iam_role_policy_attachment</span><span class="p">.</span><span class="k">cluster_AmazonEKSClusterPolicy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">aws_iam_role_policy_attachment</span><span class="p">.</span><span class="k">cluster_AmazonEKSVPCResourceController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## Fargate에서 팟 배치시 사용하는 실행 역할을 정의합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1">## AmazonEKSFargatePodExecutionRolePolicy를 포함합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_iam_role&#34; &#34;pod_execution&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;${local.cluster_name}-eks-pod-execution-role&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  assume_role_policy</span> <span class="o">=</span> <span class="k">jsonencode</span><span class="p">(</span>{
</span></span><span class="line"><span class="cl"><span class="n">    Version</span> <span class="o">=</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    Statement</span> <span class="o">=</span> <span class="p">[</span>{
</span></span><span class="line"><span class="cl"><span class="n">      Effect</span> <span class="o">=</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Principal</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">        Service</span> <span class="o">=</span> <span class="s2">&#34;eks-fargate-pods.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">      }<span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Action</span> <span class="o">=</span> <span class="s2">&#34;sts:AssumeRole&#34;</span>
</span></span><span class="line"><span class="cl">    }<span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy_attachment&#34; &#34;pod_execution_AmazonEKSFargatePodExecutionRolePolicy&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  policy_arn</span> <span class="o">=</span> <span class="s2">&#34;arn:aws:iam::aws:policy/AmazonEKSFargatePodExecutionRolePolicy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">pod_execution</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## EKS 클러스터에 노드를 Fargate로 공급합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1">## default/kube-system 네임스페이스를 가진 팟에 대해 적용됩니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_eks_fargate_profile&#34; &#34;default&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span>           <span class="o">=</span> <span class="k">aws_eks_cluster</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl"><span class="n">  fargate_profile_name</span>   <span class="o">=</span> <span class="s2">&#34;fp-default&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  pod_execution_role_arn</span> <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">pod_execution</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnet_ids</span>             <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="k">id</span><span class="c1"> # 프라이빗 서브넷만 줄 수 있습니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">selector</span> {
</span></span><span class="line"><span class="cl"><span class="n">    namespace</span> <span class="o">=</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  <span class="k">selector</span> {
</span></span><span class="line"><span class="cl"><span class="n">    namespace</span> <span class="o">=</span> <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>쿠버네티스 클러스터에 접근할 수 있도록 <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-kubeconfig.html">kubeconfig를 생성</a>합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ aws eks update-kubeconfig --region ap-northeast-2 --name simon-test --alias simon-test
</span></span></code></pre></div><p>이제 쿠버네티스 클러스터의 상태를 볼 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get svc
</span></span><span class="line"><span class="cl">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
</span></span><span class="line"><span class="cl">kubernetes   ClusterIP   172.20.0.1   &lt;none&gt;        443/TCP   23m
</span></span></code></pre></div><p>그런데 팟 목록을 보면 기본적으로 실행되어야 할 coredns 팟이 뜨지 않는 것이 보입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get pods -n kube-system
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">coredns-6dbb778559-clx8r   0/1     Pending   <span class="m">0</span>          13m
</span></span><span class="line"><span class="cl">coredns-6dbb778559-zpx2h   0/1     Pending   <span class="m">0</span>          13m
</span></span></code></pre></div><p>Fargate 노드만 사용하려면 <a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-getting-started.html#fargate-gs-coredns">CoreDNS 내용을 수정 해줘야</a> 합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl patch deployment coredns <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -n kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --type json <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -p<span class="o">=</span><span class="s1">&#39;[{&#34;op&#34;: &#34;remove&#34;, &#34;path&#34;: &#34;/spec/template/metadata/annotations/eks.amazonaws.com~1compute-type&#34;}]&#39;</span>
</span></span><span class="line"><span class="cl">deployment.apps/coredns patched
</span></span><span class="line"><span class="cl">$ kubectl get pods -n kube-system                          
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">coredns-6f99dbb876-hp667   1/1     Running   <span class="m">0</span>          4m
</span></span><span class="line"><span class="cl">coredns-6f99dbb876-skrgn   1/1     Running   <span class="m">0</span>          4m
</span></span></code></pre></div><p>컨테이너에 IAM 권한을 부여하려면 <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html">OIDC 공급자 생성</a>이 필요합니다</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ eksctl utils associate-iam-oidc-provider --cluster simon-test --approve
</span></span></code></pre></div><h2 id="서비스-구동">서비스 구동</h2>
<p>이제 우리가 만든 어플리케이션을 EKS 클러스터에 올릴 차례입니다.</p>
<p>이전과 마찬가지로 ECR 저장소를 만들고 이미지를 올려둡니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  app_name</span> <span class="o">=</span> <span class="s2">&#34;simon-sample&#34;</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## simon-sample 앱을 위한 저장소를 만듭니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_ecr_repository&#34; &#34;simon_sample&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">app_name</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>이 이미지를 띄우는 것은 쿠버네티스가 처리합니다.</p>
<p>쿠버네티스에 띄우는 가장 작은 단위는 <a href="https://kubernetes.io/ko/docs/concepts/workloads/pods/">파드</a>입니다. 다만 파드로 띄우면 서버를 확장하는 것이 어렵습니다. <a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/replicaset/">레플리카셋</a>이라는 리소스를 사용하면 파드를 여러개 띄울 수 있습니다. 여기에 더해 <a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/">디플로이먼트</a>를 리소스를 사용하면 어플리케이션 갱신시 레플리카셋 교체를 해줍니다.</p>
<p>다음과 같이 쿠버네티스 리소스를 정의합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;aws-account-id&gt;.dkr.ecr.ap-northeast-2.amazonaws.com/simon-sample:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span></code></pre></div><p>다음 명령으로 적용합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl apply -f simon-sample.yaml
</span></span><span class="line"><span class="cl">deployment.apps/simon-sample created
</span></span></code></pre></div><p>보통 5분 안에(빠르면 1분 안에) 다음과 같이 Running 상태로 바뀝니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get pods -o wide                 
</span></span><span class="line"><span class="cl">NAME                           READY   STATUS    RESTARTS   AGE     IP              NODE                    NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">simon-sample-dd88b97bc-svtd6   1/1     Running   <span class="m">0</span>          3m45s   10.194.101.15   fargate-10.194.101.15   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>포트 포워딩으로 세팅하고, HTTP 요청을 하면 응답이 오는 것을 볼 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl port-forward simon-sample-dd88b97bc-svtd6 3000:3000
</span></span><span class="line"><span class="cl">Forwarding from 127.0.0.1:3000 -&gt; <span class="m">3000</span>
</span></span><span class="line"><span class="cl">Handling connection <span class="k">for</span> <span class="m">3000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## from other terminal</span>
</span></span><span class="line"><span class="cl">$ curl localhost:3000 --data <span class="s1">&#39;hello world&#39;</span>
</span></span><span class="line"><span class="cl">hello world
</span></span></code></pre></div><h2 id="서비스를-외부에-노출하기">서비스를 외부에 노출하기</h2>
<p>ECS와 마찬가지로 실제 서비스가 되려면 외부에 노출된 로드 밸런서에 우리의 서비스를 붙여줘야 합니다. ECS와 달리 쿠버네티스에서는 로드 밸런서 정의도 쿠버네티스 리소스로 정의합니다. 하지만 실제로는 EKS가 알아서 AWS 로드 밸런서를 생성하게 됩니다.</p>
<p>어플리케이션 계층(L7)에서 동작하는 Application Load Balancer(ALB)를 생성하기 위한 리소스 타입은 <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a> 입니다.</p>
<p>우선 <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/aws-load-balancer-controller.html">AWS Load Balancer Controller 추가 기능 설치</a>가 필요합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## ALB를 컨트롤 할 수 있는 정책을 생성합니다.</span>
</span></span><span class="line"><span class="cl">$ curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.0/docs/install/iam_policy.json
</span></span><span class="line"><span class="cl">$ aws iam create-policy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --policy-name AWSLoadBalancerControllerIAMPolicy-simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --policy-document file://iam_policy.json
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 위 정책을 포함한 IAM 역할을 생성합니다.</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">ACCOUNT_ID</span><span class="o">=</span><span class="k">$(</span>aws sts get-caller-identity <span class="p">|</span> jq -r .Account<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">OIDC_URL</span><span class="o">=</span><span class="k">$(</span>aws eks describe-cluster --name simon-test --query <span class="s2">&#34;cluster.identity.oidc.issuer&#34;</span> --output text <span class="p">|</span> sed <span class="s2">&#34;s|https://||&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">$ cat &gt; load-balancer-role-trust-policy.json <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">{
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;Statement&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="s">        {
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Principal&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">                &#34;Federated&#34;: &#34;arn:aws:iam::${ACCOUNT_ID}:oidc-provider/$OIDC_URL&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">            },
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Action&#34;: &#34;sts:AssumeRoleWithWebIdentity&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Condition&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">                &#34;StringEquals&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">                    &#34;${OIDC_URL}:aud&#34;: &#34;sts.amazonaws.com&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">                    &#34;${OIDC_URL}:sub&#34;: &#34;system:serviceaccount:kube-system:aws-load-balancer-controller&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                }
</span></span></span><span class="line"><span class="cl"><span class="s">            }
</span></span></span><span class="line"><span class="cl"><span class="s">        }
</span></span></span><span class="line"><span class="cl"><span class="s">    ]
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">$ aws iam create-role <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --role-name AmazonEKSLoadBalancerControllerRole-simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --assume-role-policy-document file://<span class="s2">&#34;load-balancer-role-trust-policy.json&#34;</span>
</span></span><span class="line"><span class="cl">$ aws iam attach-role-policy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --policy-arn arn:aws:iam::<span class="si">${</span><span class="nv">ACCOUNT_ID</span><span class="si">}</span>:policy/AWSLoadBalancerControllerIAMPolicy-simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --role-name AmazonEKSLoadBalancerControllerRole-simon-test
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## IAM 역할에 연결된 쿠베네티스 서비스 계정을 생성합니다.</span>
</span></span><span class="line"><span class="cl">$ cat &gt; aws-load-balancer-controller-service-account.yaml <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ServiceAccount
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app.kubernetes.io/component: controller
</span></span></span><span class="line"><span class="cl"><span class="s">    app.kubernetes.io/name: aws-load-balancer-controller
</span></span></span><span class="line"><span class="cl"><span class="s">  name: aws-load-balancer-controller
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: kube-system
</span></span></span><span class="line"><span class="cl"><span class="s">  annotations:
</span></span></span><span class="line"><span class="cl"><span class="s">    eks.amazonaws.com/role-arn: arn:aws:iam::${ACCOUNT_ID}:role/AmazonEKSLoadBalancerControllerRole-simon-test
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">$ kubectl apply -f aws-load-balancer-controller-service-account.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## AWS Load Balancer Controller를 설치합니다</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">VPC_ID</span><span class="o">=</span><span class="k">$(</span>aws ec2 describe-vpcs --filters <span class="nv">Name</span><span class="o">=</span>cidr,Values<span class="o">=</span>10.194.0.0/16 <span class="p">|</span> jq -r .Vpcs<span class="o">[</span>0<span class="o">]</span>.VpcId<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ helm repo add eks https://aws.github.io/eks-charts
</span></span><span class="line"><span class="cl">$ helm repo update
</span></span><span class="line"><span class="cl">$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -n kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">clusterName</span><span class="o">=</span>simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set serviceAccount.create<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set serviceAccount.name<span class="o">=</span>aws-load-balancer-controller <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">region</span><span class="o">=</span>ap-northeast-2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">vpcId</span><span class="o">=</span><span class="nv">$VPC_ID</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set image.repository<span class="o">=</span>602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon/aws-load-balancer-controller
</span></span><span class="line"><span class="cl">NAME: aws-load-balancer-controller
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Sat Mar <span class="m">26</span> 10:02:19 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: kube-system
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">AWS Load Balancer controller installed!
</span></span><span class="line"><span class="cl">$ kubectl get deployment -n kube-system aws-load-balancer-controller
</span></span><span class="line"><span class="cl">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">aws-load-balancer-controller   2/2     <span class="m">2</span>            <span class="m">2</span>           5m51s
</span></span></code></pre></div><p>이제 쿠버네티스를 통해 ALB를 생성하고, 아까 만든 앱을 등록합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-test-alb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/scheme</span><span class="p">:</span><span class="w"> </span><span class="l">internet-facing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/target-type</span><span class="p">:</span><span class="w"> </span><span class="l">ip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">alb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span></code></pre></div><p>이제 로드 밸런서 주소로 요청을 보내면 응답을 보내옵니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## k8s-default-simontes-ea5ab2759b-771587743.ap-northeast-2.elb.amazonaws.com 같은 주소를 가집니다</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">LB_HOST</span><span class="o">=</span><span class="k">$(</span>kubectl get ingress/simon-test-alb -ojson <span class="p">|</span> jq -r .status.loadBalancer.ingress<span class="o">[</span>0<span class="o">]</span>.hostname<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ curl <span class="nv">$LB_HOST</span> --data <span class="s1">&#39;hello world&#39;</span>
</span></span><span class="line"><span class="cl">hello world
</span></span></code></pre></div><h2 id="후기">후기</h2>
<p>확실히 EKS는 ECS에 비해 훨씬 복잡합니다. 그만큼 세세한 컨트롤이 가능하고, AWS에 특화된 개념이 아니라는 것은 장점이라고 봅니다.</p>
<p>이번 글에서는 수동으로 처리해주는 부분이 꽤 있는데 다음에는 더 자동화(Terraform) 해보도록 하겠습니다.</p>
<h2 id="appendix">Appendix</h2>
<ul>
<li>예제 파일: <a href="/file/ko/tech/2022-03-31-2-simon-sample.zip">simon-sample.zip</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html">Amazon EKS의 애플리케이션 로드 밸런싱</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-cluster.html">Amazon EKS 클러스터 생성</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/fargate-getting-started.html">Amazon EKS를 사용하여 AWS Fargate 시작하기</a>
<ul>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/fargate-getting-started.html#fargate-gs-coredns">CoreDNS 업데이트</a></li>
</ul>
</li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-kubeconfig.html">Amazon EKS용 kubeconfig 생성</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html">클러스터에 대한 IAM OIDC 공급자 생성</a></li>
<li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/">AWS Load Balancer Controller</a>
<ul>
<li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/ingress/annotations/">Ingress annotations</a></li>
</ul>
</li>
<li><a href="https://kubernetes.io/ko/docs/home/">쿠버네티스</a>
<ul>
<li><a href="https://kubernetes.io/ko/docs/concepts/workloads/pods/">파드</a></li>
<li><a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/replicaset/">레플리카셋</a></li>
<li><a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/">디플로이먼트</a></li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-03-31-1-web-application-using-ecs/'>ECS를 사용해서 어플리케이션 서비스 하기</a></h2>
          <p class='posts-date'>31 Mar 2022</p>
        </div>
        <div class='panel-body'>
          <p>카카오스타일에서는 한동한 ECS를 사용해서 어플리케이션을 서비스했습니다. 현재는 EKS로 전환하고 있지만, ECS가 상대적으로 단순하기 때문에 서비스 구축 개념을 익히는데 좋은 것 같습니다. (간단한 서비스는 굳이 쿠버네티스를 쓸 필요가 없다고 생각합니다) 그런 의미에서 이번 글에서는 ECS를 이용해 단순한 서비스를 오픈하는 과정을 단계별로 설명해보려고 합니다.</p>
<h2 id="docker-도입-과정">Docker 도입 과정</h2>
<p><a href="https://www.docker.com/">도커</a>에 대한 얘기는 2014~2015년 무렵 들려오기 시작했던 것 같습니다. 혁신적인 솔루션이라는 얘기가 오가고 있었지만, 카카오스타일에서는 <a href="https://aws.amazon.com/ko/elasticbeanstalk/">AWS Elastic Beanstalk</a>를 거쳐, 독자적인 배포 시스템을 갖추고 있었기 때문에 도커의 이득에 대해서 크게 와 닿지 않아 도커로 넘어가는게 상대적으로 늦었던 것 같습니다.</p>
<p>그러던 와중에 처음 필요성을 느꼈던 것은 로컬 개발환경을 갖추는 부분이였던 것 같습니다. 유닛 테스트등을 위해서 로컬에 DB 프로세스 구동이 필요했습니다. 신규 직원에게 <a href="https://brew.sh/">brew</a>로 설치하는 것을 가이드하고 있었는데, <a href="https://docs.docker.com/compose/">Docker Compose</a>로 구성해두었더니 도커에 익숙한 사람은 쉽게 개발 환경을 갖출 수 있었습니다.</p>
<p><img src="/img/ko/tech/2022-03-31-1-01.png" alt="2022-03-31-1-01.png"></p>
<p>이후 지토가 하나의 마이크로서비스에 대해서 <a href="https://aws.amazon.com/ko/ecs/">ECS</a> 셋업을 했는데, 세팅된 것을 보고 나니 유용성이 느껴진 것 같습니다. 그래서 빠르게 이후에 빠르게 ECS 전환을 했습니다.</p>
<p><img src="/img/ko/tech/2022-03-31-1-02.png" alt="2022-03-31-1-02.png"></p>
<p>ECS 전환전보다 배포 시간이 늘어나긴 했습니다. (이전에는 이미 존재하는 EC2 인스턴스에 새로운 소스를 전송한 후 프로세스만 새로 띄우면 됐습니다) 하지만 점점 마이크로서비스로 나눠지고, 트래픽이 늘어나는 상황에 대응하기에는 ECS가 훨씬 수월했습니다.</p>
<h2 id="docker로-서비스-만들기">Docker로 서비스 만들기</h2>
<p>도커로 구동할 Node.js 어플리케이션을 만들어봅시다. HTTP 요청에 보낸 온 데이터를 그대로 반환하는 간단한 서버입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// echo.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">req</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</span></span></code></pre></div><p>이 서버를 도커 이미지로 만들기 위해 다음과 같이 Dockerfile을 만들면 됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-docker" data-lang="docker"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> node:16</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /opt/app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> echo.js .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 3000</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;node&#34;</span><span class="p">,</span> <span class="s2">&#34;echo.js&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></div><p><code>[docker build](https://docs.docker.com/engine/reference/commandline/build/)</code>로 도커 이미지를 만들 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker build . -t simon-sample
</span></span></code></pre></div><blockquote>
<p>Apple Silicon을 사용한 컴퓨터에서는 platform을 지정해 빌드해야 ECS에서 정상동작합니다. <code>docker build . -t simon-sample --platform=linux/amd64</code></p>
</blockquote>
<p><code>[docker run](https://docs.docker.com/engine/reference/commandline/run/)</code>을 이용해 이미지로 부터 프로세스를 실행할 수 있습니다. 외부에서 서버에 접근하기 위해 3000번 포트를 열어야 하고, 데몬 모드로 실행합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker run -p <span class="m">3000</span> -d simon-sample
</span></span></code></pre></div><p><a href="https://curl.se/">curl</a>을 사용해 잘 동작하는지 확인 가능합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl http://localhost:3000 --data <span class="s1">&#39;hello world&#39;</span>    
</span></span><span class="line"><span class="cl">hello world
</span></span></code></pre></div><p>이렇게 만들어진 이미지는 어떠한 환경에서든 동일하게 동작하고, 배포도 단순해집니다.</p>
<h2 id="vpc-셋업">VPC 셋업</h2>
<p>ECS 클러스터 생성에 앞서, 클러스터가 놓일 VPC를 만듭니다.</p>
<p>우리가 원하는 서비스 구조를 위해서는 VPC에 최소한 다음과 같은 것들이 필요합니다. (<a href="https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/VPC_Scenario2.html">퍼블릭 및 프라이빗 서브넷이 있는 VPC(NAT) 문서</a>에서 설명하는 구조와 같습니다.)</p>
<ul>
<li>VPC</li>
<li>인터넷에 노출되는 서버가 놓일 퍼플릭 서브넷 (최소 두개 이상의 AZ)</li>
<li>안전하게 외부로 부터 접근을 차단된, 실제 서비스가 배치될 프라이빗 서브넷 (최소 두개 이상의 AZ)</li>
<li>퍼플릭 서브넷에서 외부 통신을 할 때 사용하는 인터넷 게이트웨이</li>
<li>프라이빗 서브넷에서 외부 통신이 필요할 때(아웃바운드 전용) 사용하는 NAT 게이트웨이</li>
<li>퍼플릭 서브넷에 연결할 라우팅 테이블. 서브넷에서 다른 서브넷에 접근할 때 규칙과, 외부(0.0.0.0/0)에 접근할 때의 규칙(인터넷 게이트웨이를 거치게 함)을 정의합니다.</li>
<li>프라이빗 서브넷에 연결할 라우팅 테이블. 퍼플릭 라우팅 테이블과 비슷한 규칙이지만, 외부에 접근시 NAT 게이트웨이를 거칩니다.</li>
</ul>
<p><img src="/img/ko/tech/2022-03-31-1-03.png" alt="Sample VPC"></p>
<p>카카오스타일은 인프라 정의시 <a href="https://www.terraform.io/">Terraform</a>을 사용합니다. 여기서는 세부 사항을 이해하기 위해 개별 리소스를 정의하고 있지만, <a href="https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest">terraform-aws-modules/vpc/aws</a> 같은 모듈을 써서 편하게 정의하는 것도 가능합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;aws&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  region</span> <span class="o">=</span> <span class="s2">&#34;ap-northeast-2&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_name</span>        <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr</span>            <span class="o">=</span> <span class="s2">&#34;10.194.0.0/16&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  public_subnets</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.0.0/24&#34;, &#34;10.194.1.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  private_subnets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.100.0/24&#34;, &#34;10.194.101.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  azs</span>             <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;ap-northeast-2a&#34;, &#34;ap-northeast-2c&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC를 생성합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_vpc&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cidr</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>       <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">vpc_name</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC 생성시 기본으로 생성되는 라우트 테이블에 이름을 붙입니다
</span></span></span><span class="line"><span class="cl"><span class="c1">## 이걸 서브넷에 연결해 써도 되지만, 여기서는 사용하지 않습니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_default_route_table&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  default_route_table_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">default_route_table_id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>                   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-default&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC 생성시 기본으로 생성되는 보안 그룹에 이름을 붙입니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_default_security_group&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-default&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷에 연결할 인터넷 게이트웨이를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_internet_gateway&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-igw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷에 적용할 라우팅 테이블
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-public&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷에서 인터넷에 트래픽 요청시 앞서 정의한 인터넷 게이트웨이로 보냅니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route&#34; &#34;public_worldwide&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span>         <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  destination_cidr_block</span> <span class="o">=</span> <span class="s2">&#34;0.0.0.0/0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  gateway_id</span>             <span class="o">=</span> <span class="k">aws_internet_gateway</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷을 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_subnet&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">)</span><span class="c1"> # 여러개를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>                  <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span>              <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  availability_zone</span>       <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">azs</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  map_public_ip_on_launch</span> <span class="o">=</span> <span class="kt">true</span><span class="c1"> # 퍼플릭 서브넷에 배치되는 서비스는 자동으로 공개 IP를 부여합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  tags</span>                    <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-public-${count.index + 1}&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷을 라우팅 테이블에 연결합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table_association&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>      <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">public</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span> <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## NAT 게이트웨이는 고정 IP를 필요로 합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_eip&#34; &#34;nat_gateway&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc</span>  <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-natgw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷에서 인터넷 접속시 사용할 NAT 게이트웨이
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_nat_gateway&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  allocation_id</span> <span class="o">=</span> <span class="k">aws_eip</span><span class="p">.</span><span class="k">nat_gateway</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>     <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">public</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="k">id</span><span class="c1"> # NAT 게이트웨이 자체는 퍼플릭 서브넷에 위치해야 합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  tags</span>          <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-natgw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷에 적용할 라우팅 테이블
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-private&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷에서 인터넷에 트래픽 요청시 앞서 정의한 NAT 게이트웨이로 보냅니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route&#34; &#34;private_worldwide&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span>         <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">private</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  destination_cidr_block</span> <span class="o">=</span> <span class="s2">&#34;0.0.0.0/0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  nat_gateway_id</span>         <span class="o">=</span> <span class="k">aws_nat_gateway</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷을 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_subnet&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">)</span><span class="c1"> # 여러개를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>            <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span>        <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  availability_zone</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">azs</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>              <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-private-${count.index + 1}&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷을 라우팅 테이블에 연결합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table_association&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>      <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span> <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">private</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="ecs-클러스터">ECS 클러스터</h2>
<p>우리 서비스가 동작할 ECS 클러스터가 필요합니다. 도커 컨테이너가 구동될 EC2 인스턴스를 직접 관리한다면 복잡하지만 Fargate를 쓴다면 크게 신경쓸게 없습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1">## ECS 클러스터를 생성합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_ecs_cluster&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="서비스-구동">서비스 구동</h2>
<p>이제 우리가 만든 어플리케이션을 ECS 클러스터에 올릴 차례입니다.</p>
<p>우선 도커 이미지를 업로드할 저장소(<a href="https://aws.amazon.com/ko/ecr/">ECR</a>)를 정의합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  app_name</span> <span class="o">=</span> <span class="s2">&#34;simon-sample&#34;</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## simon-sample 앱을 위한 저장소를 만듭니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_ecr_repository&#34; &#34;simon_sample&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">app_name</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>첫단계에서 만든 도커 이미지를 다음과 같이 업로드할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## ECR 저장소에 로그인합니다</span>
</span></span><span class="line"><span class="cl">$ aws ecr get-login-password --region ap-northeast-2 <span class="p">|</span> docker login --username AWS --password-stdin &lt;aws-account-id&gt;.dkr.ecr.ap-northeast-2.amazonaws.com
</span></span><span class="line"><span class="cl"><span class="c1">## 앞서 만든 이미지에 ECR 이름을 붙여줍니다</span>
</span></span><span class="line"><span class="cl">$ docker tag simon-sample:latest &lt;aws-account-id&gt;.dkr.ecr.ap-northeast-2.amazonaws.com/simon-sample:latest
</span></span><span class="line"><span class="cl"><span class="c1">## 이미지를 올립니다</span>
</span></span><span class="line"><span class="cl">$ docker push &lt;aws-account-id&gt;.dkr.ecr.ap-northeast-2.amazonaws.com/simon-sample:latest
</span></span></code></pre></div><p>작업 정의를 다음과 같이 정의합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1">## 태스크 정의시 AmazonECSTaskExecutionRolePolicy 정책을 포함한
</span></span></span><span class="line"><span class="cl"><span class="c1">## IAM 역할을 실행 역할(execution role)로 설정해줘야 합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_iam_role&#34; &#34;execution&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;${local.app_name}-exec-role&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  assume_role_policy</span> <span class="o">=</span> <span class="k">jsonencode</span><span class="p">(</span>{
</span></span><span class="line"><span class="cl"><span class="n">    Version</span> <span class="o">=</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    Statement</span> <span class="o">=</span> <span class="p">[</span>{
</span></span><span class="line"><span class="cl"><span class="n">      Action</span> <span class="o">=</span> <span class="s2">&#34;sts:AssumeRole&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Principal</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">        Service</span> <span class="o">=</span> <span class="s2">&#34;ecs-tasks.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">      }<span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Effect</span> <span class="o">=</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    }<span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy_attachment&#34; &#34;execution&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  role</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">execution</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl"><span class="n">  policy_arn</span> <span class="o">=</span> <span class="s2">&#34;arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy&#34;</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## ECS 위에서 띄울 태스크에 대한 정의입니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_ecs_task_definition&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  family</span>                   <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">app_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  network_mode</span>             <span class="o">=</span> <span class="s2">&#34;awsvpc&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  requires_compatibilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;FARGATE&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  cpu</span>                      <span class="o">=</span> <span class="m">256</span><span class="c1"> # CPU, 메모리는 가장 작은 값을 사용합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  memory</span>                   <span class="o">=</span> <span class="m">512</span>
</span></span><span class="line"><span class="cl"><span class="n">  execution_role_arn</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">execution</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl"><span class="n">  container_definitions</span> <span class="o">=</span> <span class="k">jsonencode</span><span class="p">([</span>{
</span></span><span class="line"><span class="cl"><span class="n">    name</span>  <span class="o">=</span> <span class="s2">&#34;app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    image</span> <span class="o">=</span> <span class="s2">&#34;${aws_ecr_repository.simon_sample.repository_url}:latest&#34;</span><span class="p">,</span><span class="c1"> # ECR에 올라온 이미지를 사용합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">    cpu</span>   <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">    portMappings</span> <span class="o">=</span> <span class="p">[</span>{<span class="c1"> # 3000번 포트를 외부에 엽니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">      hostPort</span>      <span class="o">=</span> <span class="m">3000</span>
</span></span><span class="line"><span class="cl"><span class="n">      protocol</span>      <span class="o">=</span> <span class="s2">&#34;tcp&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">      containerPort</span> <span class="o">=</span> <span class="m">3000</span>
</span></span><span class="line"><span class="cl">    }<span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="p">])</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>이제 컨테이너를 띄울 준비가 끝났습니다. 서비스를 정의하면 설정된 것에 맞춰 작업(태스크)가 뜹니다</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1">## ECR에서 데이터를 가져오려면 태스크에 인터넷에 접근할 수 있는 권한을 주어야 합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_security_group&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span>   <span class="o">=</span> <span class="s2">&#34;${local.app_name}-sg&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">  <span class="k">egress</span> {
</span></span><span class="line"><span class="cl"><span class="n">    from_port</span>   <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">    to_port</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">    protocol</span>    <span class="o">=</span> <span class="s2">&#34;-1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;0.0.0.0/0&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## ECS 서비스를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_ecs_service&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  desired_count</span>   <span class="o">=</span> <span class="m">1</span><span class="c1"> # 태스크를 하나만 띄웁니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  name</span>            <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">app_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster</span>         <span class="o">=</span> <span class="k">aws_ecs_cluster</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl"><span class="n">  task_definition</span> <span class="o">=</span> <span class="k">aws_ecs_task_definition</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl"><span class="n">  launch_type</span>     <span class="o">=</span> <span class="s2">&#34;FARGATE&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">network_configuration</span> {
</span></span><span class="line"><span class="cl"><span class="n">    subnets</span>         <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="k">id</span><span class="c1"> # 프라이빗 서브넷에 배치합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">    security_groups</span> <span class="o">=</span> <span class="p">[</span><span class="k">aws_security_group</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="서비스를-외부에-노출하기">서비스를 외부에 노출하기</h2>
<p>이렇게 만들어진 서비스는 외부에서 접속이 불가능하기 때문에 사실 아무 쓸모가 없습니다. (로그도 없어서 잘 떴는지 확인하기도 어렵습니다.)</p>
<p>ECS 태스크를 직접 외부에 노출할 수도 있겠지만, 보통 여러개의 태스크를 실행하기 때문에 앞에 트래픽을 분산해주는 서버가 필요합니다. 이는 로드 밸런서를 이용해 달성할 수 있습니다. 이 로드 밸런서를 퍼블릭 서브넷에 배치함으로써 외부에서 트래픽도 받을 수 있습니다.</p>
<p>3000번 포트로 트래픽을 전송하는 로드밸런서 타겟 그룹을 만들어 로드 밸런서 80포트(HTTP)로 트래픽이 들어오면 전송하도록 설정합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  lb_name</span> <span class="o">=</span> <span class="s2">&#34;simon-test-lb&#34;</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 외부에 80번 포트를 여는 보안 그룹을 생성합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_security_group&#34; &#34;lb&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span>   <span class="o">=</span> <span class="s2">&#34;${local.lb_name}-sg&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">  <span class="k">ingress</span> {
</span></span><span class="line"><span class="cl"><span class="n">    from_port</span>   <span class="o">=</span> <span class="m">80</span>
</span></span><span class="line"><span class="cl"><span class="n">    to_port</span>     <span class="o">=</span> <span class="m">80</span>
</span></span><span class="line"><span class="cl"><span class="n">    protocol</span>    <span class="o">=</span> <span class="s2">&#34;tcp&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;0.0.0.0/0&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## HTTP 요청을 분산하는 어플리케이션 로드 밸런서를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_lb&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span>               <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">lb_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  internal</span>           <span class="o">=</span> <span class="kt">false</span>
</span></span><span class="line"><span class="cl"><span class="n">  load_balancer_type</span> <span class="o">=</span> <span class="s2">&#34;application&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  security_groups</span>    <span class="o">=</span> <span class="p">[</span><span class="k">aws_security_group</span><span class="p">.</span><span class="k">lb</span><span class="p">.</span><span class="k">id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnets</span>            <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">public</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="k">id</span><span class="c1"> # 퍼블릭 서브넷에 배치합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 로드 밸런서로 온 요청을 받아 처리할 목표 그룹을 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_lb_target_group&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span>        <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">app_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  port</span>        <span class="o">=</span> <span class="m">3000</span><span class="c1"> # 우리가 만든 컨테이너는 3000번 포트에서 입력을 받습니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  protocol</span>    <span class="o">=</span> <span class="s2">&#34;HTTP&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  target_type</span> <span class="o">=</span> <span class="s2">&#34;ip&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>      <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## HTTP(80)에 대한 리스너를 생성합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_lb_listener&#34; &#34;http&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  load_balancer_arn</span> <span class="o">=</span> <span class="k">aws_lb</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl"><span class="n">  port</span>              <span class="o">=</span> <span class="s2">&#34;80&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  protocol</span>          <span class="o">=</span> <span class="s2">&#34;HTTP&#34;</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # 앞서 정의한 타겟 그룹으로 모든 트래픽을 보냅니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">default_action</span> {
</span></span><span class="line"><span class="cl"><span class="n">    type</span>             <span class="o">=</span> <span class="s2">&#34;forward&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    target_group_arn</span> <span class="o">=</span> <span class="k">aws_lb_target_group</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>이렇게 생성된 로드 밸런서는 <code>simon-test-lb-135798642.ap-northeast-2.elb.amazonaws.com</code>와 같은 주소를 할당받게 됩니다. 아직 이전에 만든 ECS 태스크가 타겟 그룹에 등록되지 않았기 때문에, 이 주소에 접속해보면 503 에러가 발생합니다. 두가지 추가 작업이 필요합니다.</p>
<p>우선 ECS 태스크가 3000번 포트에서의 입력을 처리할 수 있도록 해야 합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1">## ECS는 로드 밸런서에서 3000번 포트로 온 요청을 받을 수 있습니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_security_group_rule&#34; &#34;ecs_from_lb&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  security_group_id</span>        <span class="o">=</span> <span class="k">aws_security_group</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  type</span>                     <span class="o">=</span> <span class="s2">&#34;ingress&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  from_port</span>                <span class="o">=</span> <span class="m">3000</span>
</span></span><span class="line"><span class="cl"><span class="n">  to_port</span>                  <span class="o">=</span> <span class="m">3000</span>
</span></span><span class="line"><span class="cl"><span class="n">  protocol</span>                 <span class="o">=</span> <span class="s2">&#34;tcp&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  source_security_group_id</span> <span class="o">=</span> <span class="k">aws_security_group</span><span class="p">.</span><span class="k">lb</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>또 로드 밸런서에서 ECS 태스크로 요청도 가능해야 합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1">## 로드 밸런서에서 ECS의 3000번 포트로 요청을 보낼 수 있습니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_security_group_rule&#34; &#34;lb_to_ecs&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  security_group_id</span>        <span class="o">=</span> <span class="k">aws_security_group</span><span class="p">.</span><span class="k">lb</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  type</span>                     <span class="o">=</span> <span class="s2">&#34;egress&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  from_port</span>                <span class="o">=</span> <span class="m">3000</span>
</span></span><span class="line"><span class="cl"><span class="n">  to_port</span>                  <span class="o">=</span> <span class="m">3000</span>
</span></span><span class="line"><span class="cl"><span class="n">  protocol</span>                 <span class="o">=</span> <span class="s2">&#34;tcp&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  source_security_group_id</span> <span class="o">=</span> <span class="k">aws_security_group</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>다음으로는 ECS 서비스 정의를 변경해 태스크가 만들어지면 타겟 그룹에 등록하게 하게 하면 됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_ecs_service&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  desired_count</span>   <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">  name</span>            <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">app_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster</span>         <span class="o">=</span> <span class="k">aws_ecs_cluster</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl"><span class="n">  task_definition</span> <span class="o">=</span> <span class="k">aws_ecs_task_definition</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl"><span class="n">  launch_type</span>     <span class="o">=</span> <span class="s2">&#34;FARGATE&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">network_configuration</span> {
</span></span><span class="line"><span class="cl"><span class="n">    subnets</span>         <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">    security_groups</span> <span class="o">=</span> <span class="p">[</span><span class="k">aws_security_group</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # 다음을 추가합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">load_balancer</span> {
</span></span><span class="line"><span class="cl"><span class="n">    target_group_arn</span> <span class="o">=</span> <span class="k">aws_lb_target_group</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl"><span class="n">    container_name</span>   <span class="o">=</span> <span class="s2">&#34;app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    container_port</span>   <span class="o">=</span> <span class="m">3000</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>이제 로드 밸런서 주소로 요청을 보내면 로컬과 마찬가지로 응답을 보내옵니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl simon-test-lb-135798642.ap-northeast-2.elb.amazonaws.com --data <span class="s1">&#39;hello world&#39;</span>
</span></span><span class="line"><span class="cl">hello world
</span></span></code></pre></div><h2 id="남은-작업">남은 작업</h2>
<p>실제 서비스에 더 가까우려면 추가로 해줘야 할 것들이 많이 있습니다. 다만 이번글에서는 따로 설명하지 않겠습니다.</p>
<ul>
<li>로드 밸런서 주소는 랜덤하게 생성됩니다. 이를 실제 서비스에서 쓰기는 어렵고 서비스만의 도메인을 설정해주는게 좋습니다. Route53에 별칭 A 레코드를 생성하면 됩니다.</li>
<li>여기서는 HTTP 트래픽을 받고 있지만, 안전한 통신을 위해 HTTPS를 사용하면 좋습니다. AWS Certificate Manager로 인증서를 생성해 로드 밸런서에 설정하면 로드 밸런서에서 TLS 종료를 처리해줍니다. 그 뒷단에 있는 우리의 어플리케이션에서는 HTTP만 처리하면 됩니다.</li>
<li>현재 트래픽을 받을 수 있는 서버가 하나 뿐입니다. 서버만 늘리면 로드 밸런서가 알아서 트래픽을 분산해줍니다. desired_count를 조절해 수동으로 서버를 늘릴 수도 있고, 오토 스케일링 정책을 설정해 트래픽에 따라 서버를 늘이고 줄일 수도 있습니다.</li>
<li>현재는 컨테이너에서 발생한 로그를 볼 수 없습니다. CloudWatch Logs를 연결해 로그를 기록할 수 있습니다.</li>
<li>CloudFront를 연결하면 전세계에서 접근할 때 지연 시간을 줄이는 등 추가 이득을 얻을 수 있습니다.</li>
</ul>
<h2 id="appendix">Appendix</h2>
<ul>
<li>예제 파일: <a href="/file/ko/tech/2022-03-31-1-simon-sample.zip">simon-sample.zip</a>
<blockquote>
<p>전체 Terraform 파일에서 한번에 스택을 생성할 때는 먼저 ECR만 생성해(<code>terraform apply --target aws_ecr_repository.simon_sample</code>) 이미지를 올린 후 나머지를 생성해주는게 깔끔합니다.</p>
</blockquote>
</li>
<li><a href="https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/VPC_Scenario2.html">퍼블릭 및 프라이빗 서브넷이 있는 VPC(NAT)</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/ecs/index.html">Amazon Elastic Container Service 설명서</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/Route53/latest/DeveloperGuide/routing-to-elb-load-balancer.html">ELB 로드 밸런서로 트래픽 라우팅</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/application/create-https-listener.html">Application Load Balancer용 HTTPS 리스너 생성</a></li>
</ul>

        </div>
      </div>
      
    </div>

    
<div class='col-xs-12 text-center'>
  
  <ul class='pagination'>
    
    <li class='disabled'><span>&laquo; 처음</span></li>
    <li class='disabled'><span>&lt; 이전</span></li>
    

    

    
    
    
    
    <li class='active'><span>1</span></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/2/'>2</a></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/3/'>3</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    <li class='disabled'><span>&hellip;</span></li>
    

    
    <li><a href='/ko/tech/page/2/'>다음 &gt;</a></li>
    <li><a href='/ko/tech/page/14/'>끝 &raquo;</a></li>
    
  </ul>
  
</div>

  </div>

</div>

<div class='container-fluid'>
  <hr>
  <footer>
    <p>
      &copy; 2014-2021 Sangmin Yoon
      <span class='pull-right text-muted'>
        powered by
        <a href='https://gohugo.io/' target='_blank'>Hugo</a>
        ,
        <a href='http://getbootstrap.com/' target='_blank'>Bootstrap</a>
        ,
        <a href='http://www.dnsever.com' target='dnsever'><img src='http://banner.dnsever.com/dnsever-banner_62x15.gif'
            border='0' alt='DNS server, DNS service '></a>
      </span>
    </p>
  </footer>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-48366784-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script src='https://code.jquery.com/jquery-1.12.4.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>

</body>

</html>
