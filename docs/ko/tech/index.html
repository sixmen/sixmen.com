<!DOCTYPE html>
<html lang='ko'>

<head>
  <meta charset='utf-8'>

  
  <title>sixmen.com: Tech</title>
  
  
  <meta name='author' content='Sangmin Yoon'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>

  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'>
  <link href='/css/style.css?body=1' rel='stylesheet' type='text/css' media='all'>
  <link href='/css/syntax.css?body=1' rel='stylesheet' type='text/css' media='all'>

  <!--[if lt IE 9]>
  <script src='https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js'></script>
  <script src='https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js'></script>
  <![endif]-->
</head>

<body>
<div class='hp-navbar'>
  <div class='container-fluid'>
    <div class='row'>
      <div class='col-xs-12'>
        
        <nav class='hp-nav'>
          <a class='hp-nav-item'
            href='/ko/'>Home</a>
          <a class='hp-nav-item'
            href='/ko/mylife/'>MyLife</a>
          <a class='hp-nav-item'
            href='/ko/travel/'>Travel</a>
          <a class='hp-nav-item active'
            href='/ko/tech/'>Tech</a>
          <a class='hp-nav-item'
            href='/ko/tags/'>Tags</a>
          <a class='hp-nav-item pull-right' href='/en/'>English</a>
        </nav>
      </div>
    </div>
  </div>
</div>



<div class='container'>

  <div class='row' style='margin-top: 20px;'>

    <div class='col-sm-10 col-sm-offset-1'>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-04-09-1-esm-problem/'>ESM ì‚½ì§ˆê¸°</a></h2>
          <p class='posts-date'>09 Apr 2022</p>
        </div>
        <div class='panel-body'>
          <p>ì €í¬ëŠ” ì£¼ê¸°ì ìœ¼ë¡œ Node.js ëª¨ë“ˆì„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ê³  ìˆìŠµë‹ˆë‹¤.
Node.jsë¥¼ 10ë…„ì§¸ ì‚¬ìš© ì¤‘ì¸ë°, CoffeeScript â†’ TypeScript, ì½œë°± â†’ Async.js â†’ Promise(&amp; async, await) ì „í™˜ í•˜ë©´ì„œ ëª‡ ë²ˆ í˜¼ë€ì˜ ì‹œê¸°ê°€ ìˆì—ˆìŠµë‹ˆë‹¤.
í•˜ì§€ë§Œ ëª¨ë“ˆ ì‹œìŠ¤í…œì€ ì­‰ ì´ì–´ì ¸ì™”ìŠµë‹ˆë‹¤.
ê·¸ëŸ°ë° ìµœê·¼ì— ì´ ëª¨ë“ˆ ì‹œìŠ¤í…œì— í° ë³€í™”ê°€ ìƒê²¼ê³  ê¸°ì¡´ ë³€í™”ì™€ ë‹¤ë¥´ê²Œ ì–‘ë¦½ì´ ì˜ ì•ˆ ë˜ì„œ ëª¨ë“ˆ ì—…ë°ì´íŠ¸ë¥¼ ì œëŒ€ë¡œ ëª» í•˜ê³  ìˆìŠµë‹ˆë‹¤.
ì´ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¨ ESMì´ ë­ê³  ì–´ë–¤ ì‘ì—…ì´ í•„ìš”í•œì§€ ì•Œì•„ë³´ë ¤ê³  í•©ë‹ˆë‹¤. (ê°œì¸ì ìœ¼ë¡œ ë§Œì¡±í•˜ëŠ” ê¹”ë”í•œ í•´ê²°ì±…ì´ ë‚˜ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤)</p>
<h2 id="ë°œìƒí•˜ëŠ”-ë¬¸ì œ">ë°œìƒí•˜ëŠ” ë¬¸ì œ</h2>
<p><a href="https://www.npmjs.com/package/chalk">chalk</a> ë€ ëª¨ë“ˆì´ 5.0ìœ¼ë¡œ ê°€ë©´ì„œ Pure ESM ëª¨ë“ˆì´ ëìŠµë‹ˆë‹¤. ì´ë¥¼ ê°€ì ¸ë‹¤ ì“°ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">chalk</span> <span class="kr">from</span> <span class="s1">&#39;chalk&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">yellow</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">));</span>
</span></span></code></pre></div><pre tabindex="0"><code>Error [ERR_REQUIRE_ESM]: require() of ES Module /a/node_modules/chalk/source/index.js from /a/a.ts not supported.
Instead change the require of index.js in /a/a.ts to a dynamic import() which is available in all CommonJS modules.
</code></pre><h2 id="esmì´ë€-ë¬´ì—‡ì¸ê°€">ESMì´ë€ ë¬´ì—‡ì¸ê°€?</h2>
<p>ì´ˆê¸° JavaScriptëŠ” ëª¨ë“ˆ ì‹œìŠ¤í…œì´ ì—†ì—ˆìŠµë‹ˆë‹¤.
í´ë¼ì´ì–¸íŠ¸ìª½ì—ì„œëŠ” <a href="https://requirejs.org/">Require.js</a>ë€ ê²ƒì´ ë§ì´ ì“°ì˜€ìŠµë‹ˆë‹¤.
í•œí¸ ì„œë²„(Node.js)ì—ì„œëŠ” CommonJSê°€ ì ìš©ë˜ì–´ ë”°ë¡œ ë°œì „ì„ í–ˆìŠµë‹ˆë‹¤.
ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í´ë¼ì´ì–¸íŠ¸, ì„œë²„ë¥¼ ëª¨ë‘ ì§€ì›í•˜ê¸° ìœ„í•œ <a href="https://stackoverflow.com/questions/16521471/relation-between-commonjs-amd-and-requirejs">íŒ¨í„´ë“¤ì´ ê°œë°œ</a>ë˜ì–´ ì ìš©ëë˜ ê¸°ì–µì´ ë‚˜ë„¤ìš”.
ê·¸í›„ <a href="https://browserify.org/">Browserify</a>, <a href="https://webpack.js.org/">webpack</a> ê°™ì€ ë²ˆë“¤ ì‹œìŠ¤í…œì´ ë‚˜ì˜¤ë©´ì„œ CommonJS ìª½ìœ¼ë¡œ í†µì¼ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
<p>ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì˜ ë™ì‘í•˜ì§€ë§Œ ë­”ê°€ ë¬¸ì œê°€ ìˆìœ¼ì‹œê¹Œ ìƒˆë¡œìš´ ì‹œìŠ¤í…œì´ ë‚˜ì™”ê² ì£ ? ìƒì„¸í•œ íˆìŠ¤í† ë¦¬ëŠ” ì˜ ëª¨ë¥´ì§€ë§Œ ì œê°€ ì•„ëŠ” CommonJSì˜ ê°€ì¥ í° ë¬¸ì œëŠ” ëŸ°íƒ€ì„ì— ëª¨ë“ˆì„ ì½ëŠ” ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.
ë‹¤ìŒ ì˜ˆë¥¼ ë³´ê² ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="c1">// a.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./b&#39;</span><span class="p">).</span><span class="nx">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;a2&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">exports</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// b.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;b1&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./a&#39;</span><span class="p">).</span><span class="nx">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;b2&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">exports</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ node a.js 
</span></span><span class="line"><span class="cl">a1
</span></span><span class="line"><span class="cl">b1
</span></span><span class="line"><span class="cl">undefined
</span></span><span class="line"><span class="cl">b2
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl">a2
</span></span></code></pre></div><p>ìœ„ì˜ ì˜ˆì—ì„œ ë³´ë‹¤ì‹œí”¼ requireëŠ” ê·¸ ì¤„ì— ë‹¤ë‹¤ë¥¼ ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
ìˆœí™˜ ì°¸ì¡°ê°€ ë°œìƒí•˜ëŠ” ê²½ìš°(<code>require('./a')</code>) ëª¨ë“ˆì„ ë‹¤ì‹œ ì½ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.
ì´ë•Œë¬¸ì— ì£¼ì˜ë¥¼ ê¸°ìš¸ì´ì§€ ì•Šìœ¼ë©´ ìœ„ ì˜ˆì²˜ëŸ¼ ëª¨ë“ˆì´ ë‚´ë³´ë‚¸ ê°’ì´ ì–»ì–´ì§€ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<p>TypeScriptì˜ importë¬¸ì€ ì‚¬ì‹¤ requireë¡œ ë³€í™˜ë˜ëŠ” ì½”ë“œì´ê¸° ë•Œë¬¸ì— ê¸°ì¡´ ì»´íŒŒì¼ ì–¸ì–´ì— ìµìˆ™í•˜ì‹  ë¶„ì´ ë³´ë©´ ë‹¹í™©í• ë§Œí•œ ë¶€ë¶„ì´ ì¢€ ìˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// a.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">b</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;./b&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;a2&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// b.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;b1&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">a</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;./a&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;b2&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span></code></pre></div><pre tabindex="0"><code>$ ts-node a.ts 
a1
b1
undefined
b2
2
a2
</code></pre><p>ì•„ë§ˆ ì´ëŸ° ì €ëŸ° ì´ìœ  ë•Œë¬¸ì— <a href="https://nodejs.org/api/esm.html">ESM</a>ì´ë€ ê²ƒì´ ë‚˜ì™”ìœ¼ë¦¬ë¼ ìƒê°í•©ë‹ˆë‹¤.
(ëª‡ë…„ì „ì— <code>.cjs</code>, <code>.mjs</code> í™•ì¥ì ì–˜ê¸°ê°€ ë‚˜ì˜¤ëŠ” ê¸€ë“¤ ë³´ë©´ì„œ ë¬´ìŠ¨ ì–˜ê¸°ê°€ ì§„í–‰ë˜ëŠ” ê±°ì•¼ ë¼ê³  ë„˜ì–´ê°„ ê¸°ì–µì´ ìˆìŠµë‹ˆë‹¤.)</p>
<p>async/await ë¬¸ë²•ì´ ë‚˜ì˜¨ ì´í›„ì— ê°€ì¥ ì•„ì‰¬ìš´ ì  ì¤‘ í•˜ë‚˜ê°€ ìµœìƒìœ„ ë‹¨ê³„ì—ì„œ awaitê°€ ë¶ˆê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>
<pre tabindex="0"><code>$ cat a.js                                                                                                                                                                         1 â†µ
await Promise.resolve(1);
$ node a.js 
/a/a.js:1
await Promise.resolve(1);
^^^^^

SyntaxError: await is only valid in async functions and the top level bodies of modules
</code></pre><p>ë”°ë¼ì„œ í•¨ìˆ˜ë¥¼ ë§Œë“¤ê±°ë‚˜ <a href="https://developer.mozilla.org/ko/docs/Glossary/IIFE">IIFE</a>ë¥¼ ì‚¬ìš©í•´ì•¼ í–ˆìŠµë‹ˆë‹¤.
ì´ê²ƒì€ CommonJSì˜ í•œê³„ë¡œ ì¸í•œ ê²ƒì´ê³  ESMì—ì„œëŠ” ê°€ëŠ¥í•´ì¡ŒìŠµë‹ˆë‹¤.
ì´ëŸ° ì´ìœ ë„ ìˆì–´ì„œ CommonJSì—ì„œ ESM ëª¨ë“ˆì„ require í•˜ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
ë°˜ëŒ€ë¡œ ESM ëª¨ë“ˆì—ì„œ CommonJS ëª¨ë“ˆì„ ì½ëŠ” ê²ƒì€ ê°€ëŠ¥í•˜ì§€ë§Œ ì‹ ê²½ì¨ì•¼ í•  ê²ƒë“¤ì´ ìˆìŠµë‹ˆë‹¤.</p>
<p>ì´ë ‡ê²Œ ESMì´ ë§Œë“¤ì–´ì§„ í›„ì— Sindre Sorhusë€ ë¶„ì´ <a href="https://blog.sindresorhus.com/get-ready-for-esm-aa53530b3f77">ESM ì „í™˜ì„ ì„ ì–¸</a>í–ˆìŠµë‹ˆë‹¤.
ê·¸ë¦¬ê³  ì´ ë¶„ì´ ë§Œë“œëŠ” ë§ì€ ëª¨ë“ˆë“¤(ì˜ˆ <a href="https://www.npmjs.com/package/file-type">file-type</a>.
<a href="https://www.npmjs.com/~sindresorhus">npm ê°œì¸ í™ˆ</a>ì— ë“¤ì–´ê°€ë³´ë©´ 1165ê°œì˜ ëª¨ë“ˆì— ê´€ì—¬í•˜ê³  ìˆë‹¤ê³  ë‚˜ì˜¤ë„¤ìš”)ì´ <a href="https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c">Pure ESM</a> ëª¨ë“ˆë¡œ ì „í™˜ëìŠµë‹ˆë‹¤.
Pure ESMì€ ëª¨ë“ˆì´ CommonJS/ESM ì–‘ìª½ì„ ì§€ì›í•˜ë„ë¡ êµ¬ì„±í•  ìˆ˜ë„ ìˆì§€ë§Œ, êµ³ì´ ESMë§Œ ì œê³µí•œë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.</p>
<p>ë¬¸ì œëŠ” CommonJS í”„ë¡œì íŠ¸ì—ì„œëŠ” ESM ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒì— ìˆìŠµë‹ˆë‹¤.
ë”°ë¼ì„œ í”„ë¡œì íŠ¸ê°€ ESMìœ¼ë¡œ ì „í™˜í•´ì•¼ì§€ë§Œ Pure ESM ëª¨ë“ˆì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<h2 id="ë¬´ì—‡ì´-ë¬¸ì œì¸ê°€">ë¬´ì—‡ì´ ë¬¸ì œì¸ê°€?</h2>
<h3 id="typescriptì—ì„œ-ì›ì¸-ì°¾ê¸°">TypeScriptì—ì„œ ì›ì¸ ì°¾ê¸°</h3>
<p>ìœ„ ì˜ˆì œì—ì„œ ë‹¤ì‹œ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">chalk</span> <span class="kr">from</span> <span class="s1">&#39;chalk&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">yellow</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">));</span>
</span></span></code></pre></div><p>ts-nodeë¡œ ì‹¤í–‰í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.</p>
<pre tabindex="0"><code>$ ts-node a.ts 
Error [ERR_REQUIRE_ESM]: require() of ES Module /a/node_modules/chalk/source/index.js from /a/a.ts not supported.
Instead change the require of index.js in /a/a.ts to a dynamic import() which is available in all CommonJS modules.
</code></pre><p>ì»´íŒŒì¼ëœ JavaScript ê²°ê³¼ë¬¼ì„ ë³´ë©´ ì›ì¸ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="s2">&#34;use strict&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">exports</span><span class="p">.</span><span class="nx">__esModule</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">chalk_1</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;chalk&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk_1</span><span class="p">[</span><span class="s2">&#34;default&#34;</span><span class="p">].</span><span class="nx">yellow</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">));</span>
</span></span></code></pre></div><p>ESM ëª¨ë“ˆì€ requireê°€ ì•„ë‹ˆë¼ importë¥¼ í•´ì•¼ í•©ë‹ˆë‹¤.</p>
<h3 id="javascriptì—ì„œ-ë¬¸ì œ-í•´ê²°">JavaScriptì—ì„œ ë¬¸ì œ í•´ê²°</h3>
<p>TypeScriptê°€ ì•„ë‹ˆë¼ JavaScriptë¡œ import êµ¬ë¬¸ì„ ì‚¬ìš©í•´ ì‘ì„±í•´ ë´…ë‹ˆë‹¤. ì´ë²ˆì—ëŠ” ë‹¤ë¥¸ ì—ëŸ¬ê°€ ë‚©ë‹ˆë‹¤.</p>
<pre tabindex="0"><code>$ cat a.js 
import chalk from &#39;chalk&#39;;
console.log(chalk.yellow(&#39;Hello&#39;));
$ node a.js
(node:72179) Warning: To load an ES module, set &#34;type&#34;: &#34;module&#34; in the package.json or use the .mjs extension.
/a/a.js:1
import chalk from &#39;chalk&#39;;
^^^^^^

SyntaxError: Cannot use import statement outside a module
</code></pre><p>íŒŒì¼ëª…ì„ <code>.mjs</code>ë¡œ ë°”ê¾¸ë©´ ì˜ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>
<pre tabindex="0"><code>$ node a.mjs 
Hello
</code></pre><p>íŒŒì¼ëª…ì„ ë°”ê¾¸ëŠ” ëŒ€ì‹  ì „ì²´ í”„ë¡œì íŠ¸ë¥¼ ESMì„ ì‚¬ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ ì„ ì–¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. package.jsonì— <code>&quot;type&quot;: &quot;module&quot;</code>ì„ ì¶”ê°€í•©ë‹ˆë‹¤.</p>
<pre tabindex="0"><code>$ cat a.js 
import chalk from &#39;chalk&#39;;
console.log(chalk.yellow(&#39;Hello&#39;));
$ cat package.json 
{
  &#34;type&#34;: &#34;module&#34;,
  &#34;dependencies&#34;: {
    &#34;chalk&#34;: &#34;^5.0.1&#34;
  }
}
$ node a.js 
Hello
</code></pre><p>ë˜ëŠ” TypeScript ì‹¤í–‰ì‹œ ë³´ì—¬ì¤€ ì—ëŸ¬ ì²˜ëŸ¼ dynamic importë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<pre tabindex="0"><code>$ cat a.js 
(async () =&gt; {
  const chalk = await import(&#39;chalk&#39;);
  console.log(chalk.default.yellow(&#39;Hello&#39;));
})();
$ node a.js 
Hello
</code></pre><p>ì •ë¦¬í•˜ë©´ JavaScriptì—ì„œ Pure ESM ëª¨ë“ˆì„ ì½ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒ ì„¸ê°€ì§€ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.</p>
<ul>
<li><code>.mjs</code> í™•ì¥ì ì‚¬ìš©</li>
<li>ì „ì²´ í”„ë¡œì íŠ¸ë¥¼ ESMìœ¼ë¡œ ì „í™˜</li>
<li>dynamic import ì‚¬ìš©</li>
</ul>
<h3 id="typescriptë¡œ-ë˜ëŒì•„-ê°€ì„œ">TypeScriptë¡œ ë˜ëŒì•„ ê°€ì„œ</h3>
<p><code>.mts</code> ë€ í™•ì¥ìë„ ì¸ì‹í•˜ê³ , tscë¡œ ì»´íŒŒì¼ í•´ë³´ë©´ <code>.mjs</code>ë¡œ ë‚˜ì˜¤ê¸´ í•˜ì§€ë§Œ ì ì ˆí•œ ë³€í™˜ì€ ì•ˆ ë©ë‹ˆë‹¤.</p>
<p>dynamic import êµ¬ë¬¸ì„ ì‚¬ìš©í•´ë„ ì—¬ì „íˆ ì‹¤í–‰ì´ ì•ˆ ë©ë‹ˆë‹¤.
ì»´íŒŒì¼ëœ ê²°ê³¼ë¬¼ì„ ë³´ë©´ ì—¬ì „íˆ requireë¡œ ë³€í™˜ì´ ë©ë‹ˆë‹¤.
ì´ë¥¼ í•´ê²°í•˜ë ¤ë©´ ëª¨ë“ˆì‹œìŠ¤í…œì„ ES ê²ƒì„ ì‚¬ìš©í•œë‹¤ê³  ì„ ì–¸í•´ì•¼ í•©ë‹ˆë‹¤.
tsconfigì—ì„œ <a href="https://www.typescriptlang.org/tsconfig#module">module ì„¤ì •</a>ì„ ì ì ˆíˆ í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.</p>
<pre tabindex="0"><code>$ cat a.ts 
(async () =&gt; {
  const chalk = await import(&#39;chalk&#39;);
  console.log(chalk.default.yellow(&#39;Hello&#39;));
})();
$ cat tsconfig.json 
{
  &#34;compilerOptions&#34;: {
    &#34;target&#34;: &#34;es2017&#34;,
    &#34;module&#34;: &#34;es2020&#34;,
    &#34;moduleResolution&#34;: &#34;node&#34;
  }
}
$ ts-node a.ts 
Hello
</code></pre><p>importë¥¼ requireë¡œ ë³€í™˜í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ë‘ëŠ” ê±´ module ì„¤ì •ì´ì§€ë§Œ, Node.jsì—ì„œ import êµ¬ë¬¸ì„ ì´í•´í•˜ëŠ” ê²ƒì„ ë³„ê°œì…ë‹ˆë‹¤.
package.jsonì— <code>&quot;type&quot;: &quot;module&quot;</code> ë„ ì¶”ê°€í•˜ë©´ ì¼ë°˜ import êµ¬ë¬¸ë„ ë™ì‘í•©ë‹ˆë‹¤.
ts-nodeë¡œ ì‹¤í–‰ì‹œì—ëŠ” <code>--esm</code> ì˜µì…˜ì„ ì¤˜ì•¼ ë™ì‘í•©ë‹ˆë‹¤.</p>
<pre tabindex="0"><code>$ cat a.ts 
import chalk from &#39;chalk&#39;;
console.log(chalk.yellow(&#39;Hello&#39;));
$ cat package.json 
{
  &#34;type&#34;: &#34;module&#34;,
  &#34;dependencies&#34;: {...}
}
$ ts-node --esm a
Hello
$ tsc --module es2020 
$ cat a.js
import chalk from &#39;chalk&#39;;
console.log(chalk.yellow(&#39;Hello&#39;));
</code></pre><h2 id="ì‹¤ì „-ì ìš©">ì‹¤ì „ ì ìš©</h2>
<p>ì´ì œ ESMì˜ ë™ì‘ ì›ë¦¬ì— ëŒ€í•´ ì•½ê°„ ê°ì´ ì˜µë‹ˆë‹¤. (ì €ëŠ” ì´ ê¸€ì„ ì“°ë©´ì„œ ì •ë¦¬í•˜ëŠ”ë°ë„ ì•„ì§ë„ í—·ê°ˆë¦½ë‹ˆë‹¤) ì´ì œ ì‹¤ì „ ì ìš©ì„ í•´ë´…ë‹ˆë‹¤.</p>
<p>JavaScriptì—ì„œëŠ” requireì™€ dynamic importë¥¼ í˜¼í•©í•´ì„œ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ë‹¤ì‹œ ë§í•´ ESM ì „í™˜(<code>&quot;type&quot;: &quot;module&quot;</code>)ì„ í•˜ì§€ ì•Šì•„ë„ ESM ëª¨ë“ˆì„ ì“°ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
(static importê°€ ì•ˆ ë˜ë¯€ë¡œ ì½”ë“œë¥¼ ë‹¤ë¥´ê²Œ ì‘ì„±í•˜ëŠ” ë¶ˆí¸í•¨ì€ ìˆìŠµë‹ˆë‹¤.)</p>
<p>í•˜ì§€ë§Œ TypeScriptì—ì„œëŠ” importë¥¼ requireë¡œ ë³€í™˜ ë˜ëŠ” ëª¨ë“œ importë¡œ ìœ ì§€, ë‘ ê°€ì§€ ì„ íƒì§€ ë°–ì— ì—†ìŠµë‹ˆë‹¤.
requireë¡œëŠ” ESM ëª¨ë“ˆì„ ì“¸ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ import ìœ ì§€(<code>&quot;module&quot;: &quot;es2020&quot;</code>)ë¥¼ í•´ì•¼ í•©ë‹ˆë‹¤.
ì´ ê²½ìš° Node.jsì—ì„œ import êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ESM ì „í™˜(<code>&quot;type&quot;: &quot;module&quot;</code>)ë„ í•´ì•¼ í•©ë‹ˆë‹¤.</p>
<p>ë‹¨ìˆœíˆ import êµ¬ë¬¸ë§Œ ì“°ë©´ ë˜ëŠ”ê²Œ ì•„ë‹™ë‹ˆë‹¤.
<a href="https://nodejs.org/api/esm.html#mandatory-file-extensions">ë¶ˆëŸ¬ì˜¬ íŒŒì¼ì˜ í™•ì¥ìë¥¼ ëª¨ë‘ ê¸°ìˆ </a>í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.
TypeScript ì„ì—ë„ ë¶ˆêµ¬í•˜ê³  <code>.js</code> í™•ì¥ìë¥¼ ì¨ì¤˜ì•¼ í•©ë‹ˆë‹¤.
ë˜ ì €ëŠ” ë””ë ‰í† ë¦¬ëª…ìœ¼ë¡œ import í•˜ëŠ” ê²ƒì„ ì¢…ì¢… ì‚¬ìš©í•˜ëŠ”ë° ëª¨ë‘ íŒŒì¼ëª…ìœ¼ë¡œ ë°”ê¿”ì¤˜ì•¼ í•©ë‹ˆë‹¤.
(<code>from './services' â†’ from '.services/index.js'</code>) ì´ ê³¼ì •ì„ ë„ì™€ì£¼ëŠ” ë„êµ¬(<a href="https://www.npmjs.com/package/fix-esm-import-path">fix-esm-import-path</a>)ë„ ìˆìŠµë‹ˆë‹¤.</p>
<p>ìƒ˜í”Œë¡œ ë§Œë“¤ì–´ë³¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì´ê±¸ë¡œ ë™ì‘í–ˆìŠµë‹ˆë‹¤.
í•˜ì§€ë§Œ ì‹¤ì œ í”„ë¡œì íŠ¸ë¡œ ê°€ë‹ˆ ë˜ ë‹¤ë¥¸ ì´ìŠˆê°€ ìˆì—ˆìŠµë‹ˆë‹¤.
<code>__dirname</code> ì„ ì“¸ ìˆ˜ ì—†ë‹¤ê³  í•´ì„œ ë³€í™˜ì„ í•´ì•¼ í–ˆìŠµë‹ˆë‹¤.
(ì˜ˆ <code>loadSchemaSync(join(__dirname, './index.graphql')</code>)</p>
<p>ì´ì œ ì»´íŒŒì¼ë„ ë˜ê³  êµ¬ë™í•´ë´…ë‹ˆë‹¤. ì•ˆ ë©ë‹ˆë‹¤. ESM ëª¨ë“ˆì—ì„œëŠ” require êµ¬ë¬¸ì„ ì“°ëŠ”ê²Œ ì•„ì˜ˆ ì•ˆ ë©ë‹ˆë‹¤.</p>
<pre tabindex="0"><code>$ node a.js 
file:///a/a.js:1
const http = require(&#39;http&#39;);
             ^

ReferenceError: require is not defined in ES module scope, you can use import instead
This file is being treated as an ES module because it has a &#39;.js&#39; file extension and &#39;/a/package.json&#39; contains &#34;type&#34;: &#34;module&#34;. To treat it as a CommonJS script, rename it to use the &#39;.cjs&#39; file extension.
</code></pre><p>ê·¸ëŸ°ë° ì €í¬ ì£¼ìš” í”„ë¡œì íŠ¸ êµ¬ì¡°ì—ëŠ” TypeScript ë‚´ì—ì„œ requireë¥¼ ì˜ì¡´í•˜ëŠ” ê³³ì´ ìˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="c1">// tools/server.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TZ</span> <span class="o">=</span> <span class="s1">&#39;Etc/UTC&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ts-node/register/transpile-only&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../app/server&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// config/index.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">loadConfig</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">dir</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">env</span><span class="o">?:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">T</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">base</span> <span class="o">=</span> <span class="nx">cloneDeep</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">dir</span><span class="si">}</span><span class="sb">/default`</span><span class="p">).</span><span class="k">default</span> <span class="nx">as</span> <span class="nx">T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ë‹¤ë¥¸ ê±´ ëª°ë¼ë„ configëŠ” ë‹¹ì¥ ê³ ì¹˜ê¸° ì–´ë ¤ì›Œ ë³´ì˜€ìŠµë‹ˆë‹¤.
ë˜ ì¦ê²¨ì“°ê³  ìˆëŠ” <a href="https://github.com/croquiscom/rinore">REPL</a>ë„ ì œëŒ€ë¡œ ë™ì‘ì„ ì•ˆ í•˜ëŠ” ê±´ ì¢€ ì‹¬ê°í–ˆìŠµë‹ˆë‹¤.</p>
<h2 id="ê·¸ë˜ì„œ-í•´ê²°ì±…ì€">ê·¸ë˜ì„œ í•´ê²°ì±…ì€?</h2>
<p>ê²°êµ­ ì´ ì´ìƒ ì‹œê°„ì„ ìŸê¸°ëŠ” ì–´ë ¤ì›Œì„œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ESM ëª¨ë“œë¡œ ì „í™˜í•˜ëŠ” ê²ƒì€ í¬ê¸°í–ˆìŠµë‹ˆë‹¤.
í•˜ì§€ë§Œ ESM ëª¨ë“ˆì€ ì—¬ì „íˆ í•„ìš”í–ˆìŠµë‹ˆë‹¤.</p>
<p>ë‹¤í–‰íˆ ì´ë²ˆì— ì¡°ì‚¬í•  ë•ŒëŠ” ì €ë²ˆì— ì°¾ì§€ ëª»í–ˆë˜ <a href="https://github.com/TypeStrong/ts-node/discussions/1290">íšŒí”¼ ë°©ë²•</a>ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.
TypeScriptê°€ ë³€í™˜í•˜ì§€ ì•Šë„ë¡ import ë¬¸ì„ ê°ì¶”ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s1">&#39;specifier&#39;</span><span class="p">,</span> <span class="s1">&#39;return import(specifier)&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><a href="https://stackoverflow.com/a/70546326/3239514">evalë„ ê°€ëŠ¥</a>í•˜ë‹¤ëŠ”ë° í…ŒìŠ¤íŠ¸í•´ë³´ì§„ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
<p>ë‹¤ë§Œ ìœ„ ì½”ë“œë³´ë‹¤ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™œìš©í•˜ëŠ” ì†”ë£¨ì…˜ì´ ë” ì§ê´€ì ì¸ ê²ƒ ê°™ì•„ì„œ ì´ ë°©ë²•ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.
<a href="https://www.npmjs.com/package/tsimportlib">tsimportlib</a> ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.</p>
<p>ì•„ì‰¬ìš´ ëŒ€ë¡œ ë™ì‘í•©ë‹ˆë‹¤ë§Œ ë‚˜ì¤‘ì— í”„ë¡œì íŠ¸ê°€ ESMìœ¼ë¡œ ì „í™˜ëì„ ë•Œ dynamic importë¥¼ static importë¡œ ë°”ê¿”ì¤˜ì•¼ í•  ê²ƒ ê°™ì•„ ê¼­ í•„ìš”í•œ ê³³ì—ë§Œ ì“°ëŠ” ê²ƒìœ¼ë¡œ ìƒê°í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
<p>ë‹¤í–‰íˆ dynamic importëŠ” ì„œë²„ì—ì„œë§Œ í•„ìš”í–ˆê³ , í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œì—ì„œëŠ” Next.jsë“±ì´ ì˜ ì²˜ë¦¬í•´ì£¼ëŠ”ì§€ static importë¡œë„ ì˜ ë™ì‘í–ˆìŠµë‹ˆë‹¤.</p>
<h2 id="ë§ˆë¬´ë¦¬">ë§ˆë¬´ë¦¬</h2>
<p>ê°œì¸ì ì¸ ëŠë‚Œìœ¼ë¡œ ESMì€ Python2 â†’ Python3ë¥¼ ì „í™˜ì‹œì˜ í˜¼ë€ì„ ë³´ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.
ì €ë¥¼ í¬í•¨í•´ ë§ì€ ì‚¬ëŒë“¤ì´ ë‹¹í™©í•´í•˜ê³  ë¶ˆë§Œì„ í„°íŠ¸ë¦¬ë„¤ìš”</p>
<p><img src="/img/ko/tech/2022-04-09-1-01.png" alt="https://github.com/sindresorhus/meta/discussions/15#discussioncomment-2495719">
<a href="https://github.com/sindresorhus/meta/discussions/15#discussioncomment-2495719">https://github.com/sindresorhus/meta/discussions/15#discussioncomment-2495719</a></p>
<p>í•˜ì§€ë§Œ ì¢‹ì€ ì‹«ë“  ESMìœ¼ë¡œì˜ ì „í™˜ì€ ì‹œì‘ëœ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
ì¡°ê¸ˆ ë” ìƒíƒœê³„ê°€ ì•ˆì •ë˜ë©´ ë‹¤ì‹œ ì „í™˜ ì‹œë„ë¥¼ í•´ì•¼ í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>
<h2 id="appendix">Appendix</h2>
<ul>
<li><a href="https://nodejs.org/api/esm.html">Modules: ECMAScript modules | Node.js Documentation</a></li>
<li><a href="https://developer.mozilla.org/ko/docs/Web/JavaScript/Guide/Modules">JavaScript modules - JavaScript | MDN</a></li>
<li><a href="https://redfin.engineering/node-modules-at-war-why-commonjs-and-es-modules-cant-get-along-9617135eeca1">Node Modules at War: Why CommonJS and ES Modules Canâ€™t Get Along</a>Â (<a href="https://roseline.oopy.io/dev/translation-why-cjs-and-esm-cannot-get-along">ë²ˆì—­</a>,Â <a href="https://yceffort.kr/2020/08/commonjs-esmodules">ìš”ì•½</a>)</li>
<li><a href="https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c">Pure ESM package</a></li>
<li><a href="https://blog.sindresorhus.com/get-ready-for-esm-aa53530b3f77">Get Ready For ESM. JavaScript Modules will soon be aâ€¦ | by Sindre Sorhus | ğŸ¦„ Sindre Sorhusâ€™ blog</a></li>
<li><a href="https://docs.joshuatz.com/cheatsheets/node-and-npm/node-esm/">ES Modules in NodeJS - Troubleshooting Resources</a></li>
<li><a href="https://github.com/TypeStrong/ts-node/discussions/1290">Dynamic `import()` with `&ldquo;module&rdquo;: &ldquo;commonjs&rdquo;`</a></li>
<li><a href="https://typestrong.org/ts-node/docs/imports/">CommonJS vs native ECMAScript modules | ts-node</a></li>
<li><a href="https://www.npmjs.com/package/tsimportlib">tsimportlib</a></li>
</ul>

        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-03-31-3-build-eks-cluster-with-terraform/'>Terraformìœ¼ë¡œ EKS êµ¬ì¶•í•˜ê¸°</a></h2>
          <p class='posts-date'>31 Mar 2022</p>
        </div>
        <div class='panel-body'>
          <p><a href="/ko/tech/2022-03-31-2-web-application-using-eks/">ì´ì „ ê¸€</a>ì—ì„œëŠ” ECS / EKSì—ì„œ ì„œë¹„ìŠ¤ í•˜ëŠ” ê²ƒì— ëŒ€í•œ ê°œë…ì„ í’€ì–´ ì¨ë´¤ìŠµë‹ˆë‹¤. ì´ë²ˆ ê¸€ì—ì„œëŠ” ì˜ ë§Œë“¤ì–´ì§„ ëª¨ë“ˆì„ ì´ìš©í•´ ë¹ ë¥´ê²Œ êµ¬ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>
<blockquote>
<p>ëª¨ë“ˆì„ ì´ìš©í•˜ë©´ í¸í•˜ê¸´ í•˜ì§€ë§Œ ë‚´ë¶€ ê°œë…ì„ ì •í™•íˆ ì´í•´í•˜ì§€ ëª»í•œ ì±„ ì‚¬ìš©í•˜ë©´ ë¬¸ì œê°€ ë°œìƒí–ˆì„ ë•Œ í•´ê²°ì´ ì–´ë ¤ìš´ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ê²°êµ­ ê¸°ë³¸ì´ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤.</p>
</blockquote>
<h2 id="vpc-ì…‹ì—…">VPC ì…‹ì—…</h2>
<p><a href="https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest">VPC ëª¨ë“ˆ</a>ì„ ì‚¬ìš©í•˜ë©´ ì´ì „ì— ê¸¸ê²Œ ì¼ë˜ ê²ƒì„ ì§§ê²Œ ê¸°ìˆ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ì „ì— ë§Œë“  VPC êµ¬ì¡°ì™€ ê°™ì§€ë§Œ NAT ê²Œì´íŠ¸ì›¨ì´ê°€ AZ ë³„ë¡œ ë”°ë¡œ ì¡´ì¬í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;aws&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  region</span> <span class="o">=</span> <span class="s2">&#34;ap-northeast-2&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span> <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="s2">&#34;vpc&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  source</span> <span class="o">=</span> <span class="s2">&#34;terraform-aws-modules/vpc/aws&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr</span> <span class="o">=</span> <span class="s2">&#34;10.194.0.0/16&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  azs</span>             <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;ap-northeast-2a&#34;, &#34;ap-northeast-2c&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  public_subnets</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.0.0/24&#34;, &#34;10.194.1.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  private_subnets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.100.0/24&#34;, &#34;10.194.101.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  enable_nat_gateway</span>     <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="n">  one_nat_gateway_per_az</span> <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  enable_dns_hostnames</span> <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  public_subnet_tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/role/elb&#34;</span>                      <span class="o">=</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  private_subnet_tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/role/internal-elb&#34;</span>             <span class="o">=</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="eks-í´ëŸ¬ìŠ¤í„°-ìƒì„±">EKS í´ëŸ¬ìŠ¤í„° ìƒì„±</h2>
<p><a href="https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest">AWS EKS ëª¨ë“ˆ</a>ì„ ì‚¬ìš©í•˜ë©´ EKS í´ëŸ¬ìŠ¤í„°ë„ ì‰½ê²Œ ìƒì„±ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">module</span> <span class="s2">&#34;eks&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  source</span> <span class="o">=</span> <span class="s2">&#34;terraform-aws-modules/eks/aws&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span>                    <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cluster_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_version</span>                 <span class="o">=</span> <span class="s2">&#34;1.21&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_endpoint_private_access</span> <span class="o">=</span> <span class="kt">false</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_endpoint_public_access</span>  <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  cluster_addons</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    coredns</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      resolve_conflicts</span> <span class="o">=</span> <span class="s2">&#34;OVERWRITE&#34;</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl"><span class="n">    kube-proxy</span> <span class="o">=</span> {}
</span></span><span class="line"><span class="cl"><span class="n">    vpc-cni</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      resolve_conflicts</span> <span class="o">=</span> <span class="s2">&#34;OVERWRITE&#34;</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>     <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">vpc</span><span class="p">.</span><span class="k">vpc_id</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnet_ids</span> <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">vpc</span><span class="p">.</span><span class="k">private_subnets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  cloudwatch_log_group_retention_in_days</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  fargate_profiles</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    default</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      name</span> <span class="o">=</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">      selectors</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        {
</span></span><span class="line"><span class="cl"><span class="n">          namespace</span> <span class="o">=</span> <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">        }<span class="p">,</span>
</span></span><span class="line"><span class="cl">        {
</span></span><span class="line"><span class="cl"><span class="n">          namespace</span> <span class="o">=</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>coredns ëª¨ë“ˆ ìƒì„±ì—ì„œ ê³„ì† ë©ˆì¶° ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Fargateë§Œ ìˆì–´ì„œì¸ë°, <a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-getting-started.html#fargate-gs-coredns">CoreDNS íŒ¨ì¹˜ë¥¼ í•´ ì£¼ë©´</a>
ì ì‹œ í›„ ì™„ë£Œë©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ aws eks update-kubeconfig --region ap-northeast-2 --name simon-test --alias simon-test
</span></span><span class="line"><span class="cl">$ kubectl patch deployment coredns -n kube-system --type json -p<span class="o">=</span><span class="s1">&#39;[{&#34;op&#34;: &#34;remove&#34;, &#34;path&#34;: &#34;/spec/template/metadata/annotations/eks.amazonaws.com~1compute-type&#34;}]&#39;</span>
</span></span></code></pre></div><h2 id="aws-load-balancer-controller-ì„¤ì¹˜">AWS Load Balancer Controller ì„¤ì¹˜</h2>
<p><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/aws-load-balancer-controller.html">AWS Load Balancer Controller</a>ë„ Terraformìœ¼ë¡œ ì„¤ì¹˜ê°€ëŠ¥í•©ë‹ˆë‹¤. ê´€ë ¨ëœ ëª¨ë“ˆì´ ì—¬ëŸ¬ ê°œ ìˆëŠ”ë° ë¯¸ë¬˜í•˜ê²Œ ë‹¤ ë™ì‘ì„ í•˜ì§€ ì•Šì•„ì„œ ê²°êµ­ì€ ìì²´ì ìœ¼ë¡œ êµ¬í˜„í•´ë´¤ìŠµë‹ˆë‹¤. ì´ì „ì— ì‰˜ì—ì„œ ì‹¤í–‰í•œ ëª…ë ¹ì„ Terraformìœ¼ë¡œ êµ¬ì„±í–ˆë‹¤ê³  ë³´ì‹œë©´ ë©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  lb_controller_iam_role_name</span>        <span class="o">=</span> <span class="s2">&#34;inhouse-eks-aws-lb-ctrl&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  lb_controller_service_account_name</span> <span class="o">=</span> <span class="s2">&#34;aws-load-balancer-controller&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">data</span> <span class="s2">&#34;aws_eks_cluster_auth&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cluster_name</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;helm&#34;</span> {
</span></span><span class="line"><span class="cl">  <span class="k">kubernetes</span> {
</span></span><span class="line"><span class="cl"><span class="n">    host</span>                   <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_endpoint</span>
</span></span><span class="line"><span class="cl"><span class="n">    token</span>                  <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="k">aws_eks_cluster_auth</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">token</span>
</span></span><span class="line"><span class="cl"><span class="n">    cluster_ca_certificate</span> <span class="o">=</span> <span class="k">base64decode</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_certificate_authority_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="s2">&#34;lb_controller_role&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  source</span> <span class="o">=</span> <span class="s2">&#34;terraform-aws-modules/iam/aws//modules/iam-assumable-role-with-oidc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  create_role</span> <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  role_name</span>        <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">lb_controller_iam_role_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  role_path</span>        <span class="o">=</span> <span class="s2">&#34;/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role_description</span> <span class="o">=</span> <span class="s2">&#34;Used by AWS Load Balancer Controller for EKS&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  role_permissions_boundary_arn</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  provider_url</span> <span class="o">=</span> <span class="k">replace</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_oidc_issuer_url</span><span class="p">,</span> <span class="s2">&#34;https://&#34;, &#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">  oidc_fully_qualified_subjects</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;system:serviceaccount:kube-system:${local.lb_controller_service_account_name}&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  oidc_fully_qualified_audiences</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;sts.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">data</span> <span class="s2">&#34;http&#34; &#34;iam_policy&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  url</span> <span class="o">=</span> <span class="s2">&#34;https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.0/docs/install/iam_policy.json&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy&#34; &#34;controller&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name_prefix</span> <span class="o">=</span> <span class="s2">&#34;AWSLoadBalancerControllerIAMPolicy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  policy</span>      <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="k">http</span><span class="p">.</span><span class="k">iam_policy</span><span class="p">.</span><span class="k">body</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>        <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">lb_controller_role</span><span class="p">.</span><span class="k">iam_role_name</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;helm_release&#34; &#34;release&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span>       <span class="o">=</span> <span class="s2">&#34;aws-load-balancer-controller&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  chart</span>      <span class="o">=</span> <span class="s2">&#34;aws-load-balancer-controller&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  repository</span> <span class="o">=</span> <span class="s2">&#34;https://aws.github.io/eks-charts&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  namespace</span>  <span class="o">=</span> <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">dynamic</span> <span class="s2">&#34;set&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">    for_each</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      &#34;clusterName&#34;</span>           <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_id</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;serviceAccount.create&#34;</span> <span class="o">=</span> <span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;serviceAccount.name&#34;</span>   <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">lb_controller_service_account_name</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;region&#34;</span>                <span class="o">=</span> <span class="s2">&#34;ap-northeast-2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;vpcId&#34;</span>                 <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">vpc</span><span class="p">.</span><span class="k">vpc_id</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;image.repository&#34;</span>      <span class="o">=</span> <span class="s2">&#34;602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon/aws-load-balancer-controller&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">      &#34;serviceAccount.annotations.eks\\.amazonaws\\.com/role-arn&#34;</span> <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">lb_controller_role</span><span class="p">.</span><span class="k">iam_role_arn</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    <span class="k">content</span> {
</span></span><span class="line"><span class="cl"><span class="n">      name</span>  <span class="o">=</span> <span class="k">set</span><span class="p">.</span><span class="k">key</span>
</span></span><span class="line"><span class="cl"><span class="n">      value</span> <span class="o">=</span> <span class="k">set</span><span class="p">.</span><span class="k">value</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="ì–´í”Œë¦¬ì¼€ì´ì…˜-êµ¬ë™">ì–´í”Œë¦¬ì¼€ì´ì…˜ êµ¬ë™</h2>
<p>ê°„ë‹¨í•œ ì„œë²„(ì´ë²ˆì—ëŠ” ê³µê°œ ì„œë²„ - <code>k8s.gcr.io/echoserver</code> -ë¥¼ ì´ìš©í•©ë‹ˆë‹¤)ë¥¼ Terraformìœ¼ë¡œ êµ¬ì„±í•˜ê² ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;kubernetes&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  host</span>                   <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_endpoint</span>
</span></span><span class="line"><span class="cl"><span class="n">  token</span>                  <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="k">aws_eks_cluster_auth</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">token</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_ca_certificate</span> <span class="o">=</span> <span class="k">base64decode</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="k">eks</span><span class="p">.</span><span class="k">cluster_certificate_authority_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;kubernetes_deployment&#34; &#34;echo&#34;</span> {
</span></span><span class="line"><span class="cl">  <span class="k">metadata</span> {
</span></span><span class="line"><span class="cl"><span class="n">    name</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  <span class="k">spec</span> {
</span></span><span class="line"><span class="cl"><span class="n">    replicas</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">selector</span> {
</span></span><span class="line"><span class="cl"><span class="n">      match_labels</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">        &#34;app.kubernetes.io/name&#34;</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    <span class="k">template</span> {
</span></span><span class="line"><span class="cl">      <span class="k">metadata</span> {
</span></span><span class="line"><span class="cl"><span class="n">        labels</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">          &#34;app.kubernetes.io/name&#34;</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">      <span class="k">spec</span> {
</span></span><span class="line"><span class="cl">        <span class="k">container</span> {
</span></span><span class="line"><span class="cl"><span class="n">          image</span> <span class="o">=</span> <span class="s2">&#34;k8s.gcr.io/echoserver:1.10&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">          name</span>  <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;kubernetes_service&#34; &#34;echo&#34;</span> {
</span></span><span class="line"><span class="cl">  <span class="k">metadata</span> {
</span></span><span class="line"><span class="cl"><span class="n">    name</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  <span class="k">spec</span> {
</span></span><span class="line"><span class="cl"><span class="n">    selector</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      &#34;app.kubernetes.io/name&#34;</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    <span class="k">port</span> {
</span></span><span class="line"><span class="cl"><span class="n">      port</span>        <span class="o">=</span> <span class="m">8080</span>
</span></span><span class="line"><span class="cl"><span class="n">      target_port</span> <span class="o">=</span> <span class="m">8080</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl"><span class="n">    type</span> <span class="o">=</span> <span class="s2">&#34;NodePort&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;kubernetes_ingress_v1&#34; &#34;alb&#34;</span> {
</span></span><span class="line"><span class="cl">  <span class="k">metadata</span> {
</span></span><span class="line"><span class="cl"><span class="n">    name</span> <span class="o">=</span> <span class="s2">&#34;alb&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    annotations</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">      &#34;alb.ingress.kubernetes.io/scheme&#34;</span>      <span class="o">=</span> <span class="s2">&#34;internet-facing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      &#34;alb.ingress.kubernetes.io/target-type&#34;</span> <span class="o">=</span> <span class="s2">&#34;ip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  <span class="k">spec</span> {
</span></span><span class="line"><span class="cl"><span class="n">    ingress_class_name</span> <span class="o">=</span> <span class="s2">&#34;alb&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">rule</span> {
</span></span><span class="line"><span class="cl">      <span class="k">http</span> {
</span></span><span class="line"><span class="cl">        <span class="k">path</span> {
</span></span><span class="line"><span class="cl">          <span class="k">backend</span> {
</span></span><span class="line"><span class="cl">            <span class="k">service</span> {
</span></span><span class="line"><span class="cl"><span class="n">              name</span> <span class="o">=</span> <span class="s2">&#34;echo&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="k">port</span> {
</span></span><span class="line"><span class="cl"><span class="n">                number</span> <span class="o">=</span> <span class="m">8080</span>
</span></span><span class="line"><span class="cl">              }
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">          }
</span></span><span class="line"><span class="cl"><span class="n">          path</span> <span class="o">=</span> <span class="s2">&#34;/*&#34;</span>
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>ì´ì œ ë¡œë“œ ë°¸ëŸ°ì„œ ì£¼ì†Œë¡œ ìš”ì²­ì„ ë³´ë‚´ë©´ ì‘ë‹µì„ ë³´ë‚´ì˜µë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># k8s-default-alb-622014ceba-1089817135.ap-northeast-2.elb.amazonaws.com ê°™ì€ ì£¼ì†Œë¥¼ ê°€ì§‘ë‹ˆë‹¤</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">LB_HOST</span><span class="o">=</span><span class="k">$(</span>kubectl get ingress/alb -ojson <span class="p">|</span> jq -r <span class="s2">&#34;.status.loadBalancer.ingress[0].hostname&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">$ curl <span class="nv">$LB_HOST</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Hostname: echo-5499565745-tk7dm
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Pod Information:
</span></span><span class="line"><span class="cl">	-no pod information available-
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Server values:
</span></span><span class="line"><span class="cl">	<span class="nv">server_version</span><span class="o">=</span>nginx: 1.13.3 - lua: <span class="m">10008</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Request Information:
</span></span><span class="line"><span class="cl">	<span class="nv">client_address</span><span class="o">=</span>10.194.1.162
</span></span><span class="line"><span class="cl">	<span class="nv">method</span><span class="o">=</span>GET
</span></span><span class="line"><span class="cl">	real <span class="nv">path</span><span class="o">=</span>/
</span></span><span class="line"><span class="cl">	<span class="nv">query</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">	<span class="nv">request_version</span><span class="o">=</span>1.1
</span></span><span class="line"><span class="cl">	<span class="nv">request_scheme</span><span class="o">=</span>http
</span></span><span class="line"><span class="cl">	<span class="nv">request_uri</span><span class="o">=</span>http://k8s-default-alb-622014ceba-1089817135.ap-northeast-2.elb.amazonaws.com:8080/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Request Headers:
</span></span><span class="line"><span class="cl">	<span class="nv">accept</span><span class="o">=</span>*/*
</span></span><span class="line"><span class="cl">	<span class="nv">host</span><span class="o">=</span>k8s-default-alb-622014ceba-1089817135.ap-northeast-2.elb.amazonaws.com
</span></span><span class="line"><span class="cl">	user-agent<span class="o">=</span>curl/7.77.0
</span></span><span class="line"><span class="cl">	x-amzn-trace-id<span class="o">=</span><span class="nv">Root</span><span class="o">=</span>1-6244434a-56cbdde1124166e4168d1cf4
</span></span><span class="line"><span class="cl">	x-forwarded-for<span class="o">=</span>1.2.3.4
</span></span><span class="line"><span class="cl">	x-forwarded-port<span class="o">=</span><span class="m">80</span>
</span></span><span class="line"><span class="cl">	x-forwarded-proto<span class="o">=</span>http
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Request Body:
</span></span><span class="line"><span class="cl">	-no body in request-
</span></span></code></pre></div><p>ìœ„ ì˜ˆì—ì„œëŠ” ê°™ì€ Terraform íŒŒì¼ì—ì„œ ì •ì˜ë¥¼ í–ˆê¸° ë•Œë¬¸ì— module.eksì˜ ì¶œë ¥ì„ ì´ìš©í–ˆìŠµë‹ˆë‹¤. ë§Œì•½ ë³„ë„ ìŠ¤íƒìœ¼ë¡œ ì •ì˜ë¥¼ í•  ì˜ˆì •ì´ê³ , kubeconfigê°€ ì„¤ì •ëœ ìƒíƒœë©´ ë‹¤ìŒê³¼ ê°™ì´ providerë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;kubernetes&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  config_path</span>    <span class="o">=</span> <span class="s2">&#34;~/.kube/config&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  config_context</span> <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="í›„ê¸°">í›„ê¸°</h2>
<p>EKS ì‹œë¦¬ì¦ˆ ê¸€ì„ ì‘ì„±í•˜ë©´ì„œ í´ëŸ¬ìŠ¤í„° ìƒì„±ì„ ì—¬ëŸ¬ ë²ˆ ë°˜ë³µí–ˆìŠµë‹ˆë‹¤. ë°˜ë³µí•  ë•Œë§ˆë‹¤ í•˜ë‚˜ì”© ë¹¼ë¨¹ì–´ì„œ ë¬¸ì œì ì„ ì°¾ëŠ”ë° í•œì°¸ ê±¸ë ¸ìŠµë‹ˆë‹¤. ê·¸ì— ë¹„í•´ ì˜ êµ¬ì„±ëœ Terraform ëª¨ë“ˆì„ í™œìš©í•˜ë‹ˆ í™•ì‹¤íˆ í¸í–ˆìŠµë‹ˆë‹¤.</p>
<p>í•˜ì§€ë§Œ ê° ë‹¨ê³„ë¥¼ í•œë²ˆì”© í•´ë´ì„œ ì „ì²´ì ì¸ ì´í•´ê°€ ëœ ìƒí™©(ì„œë¸Œë„· íƒœê¹…ì´ ì™œ í•„ìš”í•œì§€, CoreDNSëŠ” ì™œ ìƒì„±ë˜ì§€ ì•ŠëŠ”ì§€ë“±)ì´ì—¬ì„œ ëª¨ë“ˆ í™œìš©ë„ ê°€ëŠ¥í–ˆë‹¤ê³  ë´…ë‹ˆë‹¤.</p>
<p>ì´ë²ˆ ì˜ˆì—ì„œëŠ” ì˜ˆì œ íŒŒì¼ì„ ë‹¨ìˆœí•˜ê²Œ í•˜ê¸° ìœ„í•´ì„œ, ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ë™ì‘í•˜ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ê¹Œì§€ Terraformìœ¼ë¡œ êµ¬ì„±í•´ë´¤ìŠµë‹ˆë‹¤. Terraformìœ¼ë¡œ ì¸í”„ë¼ë¥¼ í†µì¼í•˜ë©´ ì¢‹ë‹¤ê³  ìƒê°í•˜ì§€ë§Œ, ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ë³„ê°œì˜ ì •ì˜ ìŠ¤í™ì´ ìˆë‹¤ë³´ë‹ˆ ì• ë§¤í•œ ì ì´ ìˆëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì‹¤ì œë¡œ ì €í¬ ì‹¤ ì„œë¹„ìŠ¤ì˜ ê²½ìš°ëŠ” Terraformì´ ì•„ë‹ˆë¼ <a href="https://helm.sh/">Helm Charts</a>ë¥¼ ì‚¬ìš©í•´ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì •ì˜í–ˆìŠµë‹ˆë‹¤.</p>
<p>ì´ë²ˆ ê¸€ì´ ì¿ ë²„ë„¤í‹°ìŠ¤ì™€ EKSë¥¼ ì´í•´í•˜ëŠ”ë° ë„ì›€ì´ ë˜ì—ˆê¸°ë¥¼ ë°”ëë‹ˆë‹¤.</p>
<h2 id="appendix">Appendix</h2>
<ul>
<li>ì˜ˆì œ íŒŒì¼: <a href="/file/ko/tech/2022-03-31-3-simon-sample.zip">simon-sample.zip</a></li>
<li><a href="https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest">terraform-aws-modules/vpc/aws | Terraform Registry</a></li>
<li><a href="https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest">terraform-aws-modules/eks/aws | Terraform Registry</a></li>
<li>AWS Load Balancer Controller ëª¨ë“ˆ
<ul>
<li><a href="https://registry.terraform.io/modules/Young-ook/eks/aws/latest/examples/lb">Young-ook/eks/aws | Terraform Registry</a></li>
<li><a href="https://registry.terraform.io/modules/DNXLabs/eks-lb-controller/aws/latest">DNXLabs/eks-lb-controller/aws | Terraform Registry</a></li>
<li><a href="https://registry.terraform.io/modules/basisai/lb-controller/aws/latest">basisai/lb-controller/aws | Terraform Registry</a></li>
</ul>
</li>
<li><a href="https://phoenixnap.com/blog/helm-vs-terraform">Helm vs Terraform: What Are the Differences</a></li>
<li><a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs">Kubernetes Provider</a></li>
</ul>

        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2022-03-31-2-web-application-using-eks/'>EKSë¥¼ ì‚¬ìš©í•´ì„œ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ í•˜ê¸°</a></h2>
          <p class='posts-date'>31 Mar 2022</p>
        </div>
        <div class='panel-body'>
          <p><a href="/ko/tech/2022-03-31-1-web-application-using-ecs/">ECS ì•„í‹°í´</a>ì— ì´ì–´ ì´ë²ˆ ê¸€ì—ì„œëŠ” ê°™ì€ ì„œë¹„ìŠ¤ë¥¼ EKSë¡œ êµ¬ì¶•í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>
<p>ê°„ë‹¨í•˜ê²Œ êµ¬ì¶•í•˜ëŠ” ê²ƒì€ <a href="https://eksctl.io/">eksctl</a>ì„ ì“°ë©´ ë˜ì§€ë§Œ, ë‚´ë¶€ ì´í•´ë¥¼ ìœ„í•´ ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ë¶€í„° êµ¬í˜„í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>
<h2 id="vpc-ì…‹ì—…">VPC ì…‹ì—…</h2>
<p>VPCëŠ” ì´ì „ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ë‘ ê°œì˜ AZì— í¼ë¸”ë¦­ ì„œë¸Œë„·ê³¼ í”„ë¦¬ì´ë¹— ì„œë¸Œë„·ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ë§Œ ë¡œë“œ ë°¸ëŸ°ì„œê°€ ì •ìƒì ìœ¼ë¡œ ë°°ì¹˜ë˜ë ¤ë©° íŠ¹ì •í•œ íƒœê·¸ë¥¼ ì„œë¸Œë„·ì— ë¶€ì—¬í•´ì•¼í•©ë‹ˆë‹¤.</p>
<p><img src="/img/ko/tech/2022-03-31-2-01.png" alt="Sample VPC"></p>
<p>ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆë§Œ ì •ì˜í•˜ëŠ” ECSì™€ ë‹¬ë¦¬ ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ë¡œë“œ ë°¸ëŸ°ì„œ, ì˜êµ¬ ë³¼ë¥¨ë“±ë„ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë•Œ ì •ì˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ì•ˆì—ì„œ í•˜ì§€ë§Œ ì‹¤ì œ ë§Œë“¤ì–´ì§€ëŠ” ê²ƒì€ ì¿ ë²„ë„¤í‹°ìŠ¤ì™€ ë¬´ê´€í•œ AWS ë¦¬ì†ŒìŠ¤(ALB, EBSë“±)ì…ë‹ˆë‹¤. ì¿ ë²„ë„¤í‹°ìŠ¤ ìì²´ëŠ” AWS êµ¬ì¡°ì™€ ë…ë¦½ì ì´ê³ , íƒœê·¸ë“± ë‹¤ë¥¸ ë°©ë²•ì„ í†µí•´ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ê°€ ìœ„ì¹˜í•  AWS ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ê²Œ ë©ë‹ˆë‹¤.</p>
<p><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html">EKSì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë“œ ë°¸ëŸ°ì‹± ë¬¸ì„œ</a>ì— ë”°ë¼ ë‹¤ìŒ íƒœê·¸ë¥¼ ì„¤ì •í•´ì¤ë‹ˆë‹¤.</p>
<ul>
<li><code>kubernetes.io/cluster/&lt;name&gt;</code>: <code>shared</code></li>
<li><code>kubernetes.io/role/internal-elb</code>: í”„ë¼ì´ë¹— ì„œë¸Œë„·ì— ëŒ€í•´ <code>1</code>ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.</li>
<li><code>kubernetes.io/role/elb</code>: í¼ë¸”ë¦­ ì„œë¸Œë„·ì— ëŒ€í•´ <code>1</code>ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;aws&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  region</span> <span class="o">=</span> <span class="s2">&#34;ap-northeast-2&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_name</span>        <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr</span>            <span class="o">=</span> <span class="s2">&#34;10.194.0.0/16&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  public_subnets</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.0.0/24&#34;, &#34;10.194.1.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  private_subnets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.100.0/24&#34;, &#34;10.194.101.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  azs</span>             <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;ap-northeast-2a&#34;, &#34;ap-northeast-2c&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span>    <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPCë¥¼ ìƒì„±í•©ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_vpc&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cidr</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>       <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">vpc_name</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC ìƒì„±ì‹œ ê¸°ë³¸ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ë¼ìš°íŠ¸ í…Œì´ë¸”ì— ì´ë¦„ì„ ë¶™ì…ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1">## ì´ê±¸ ì„œë¸Œë„·ì— ì—°ê²°í•´ ì¨ë„ ë˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_default_route_table&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  default_route_table_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">default_route_table_id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>                   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-default&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC ìƒì„±ì‹œ ê¸°ë³¸ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ë³´ì•ˆ ê·¸ë£¹ì— ì´ë¦„ì„ ë¶™ì…ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_default_security_group&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-default&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## í¼í”Œë¦­ ì„œë¸Œë„·ì— ì—°ê²°í•  ì¸í„°ë„· ê²Œì´íŠ¸ì›¨ì´ë¥¼ ì •ì˜í•©ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_internet_gateway&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-igw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## í¼í”Œë¦­ ì„œë¸Œë„·ì— ì ìš©í•  ë¼ìš°íŒ… í…Œì´ë¸”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-public&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## í¼í”Œë¦­ ì„œë¸Œë„·ì—ì„œ ì¸í„°ë„·ì— íŠ¸ë˜í”½ ìš”ì²­ì‹œ ì•ì„œ ì •ì˜í•œ ì¸í„°ë„· ê²Œì´íŠ¸ì›¨ì´ë¡œ ë³´ëƒ…ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route&#34; &#34;public_worldwide&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span>         <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  destination_cidr_block</span> <span class="o">=</span> <span class="s2">&#34;0.0.0.0/0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  gateway_id</span>             <span class="o">=</span> <span class="k">aws_internet_gateway</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## í¼í”Œë¦­ ì„œë¸Œë„·ì„ ì •ì˜í•©ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_subnet&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">)</span><span class="c1"> # ì—¬ëŸ¬ê°œë¥¼ ì •ì˜í•©ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>                  <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span>              <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  availability_zone</span>       <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">azs</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  map_public_ip_on_launch</span> <span class="o">=</span> <span class="kt">true</span><span class="c1"> # í¼í”Œë¦­ ì„œë¸Œë„·ì— ë°°ì¹˜ë˜ëŠ” ì„œë¹„ìŠ¤ëŠ” ìë™ìœ¼ë¡œ ê³µê°œ IPë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-public-${count.index + 1}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span><span class="p">,</span><span class="c1"> # ë‹¤ë¥¸ ë¶€ë¶„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">    &#34;kubernetes.io/role/elb&#34;</span>                      <span class="o">=</span> <span class="s2">&#34;1&#34;</span><span class="c1"> # ë‹¤ë¥¸ ë¶€ë¶„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## í¼í”Œë¦­ ì„œë¸Œë„·ì„ ë¼ìš°íŒ… í…Œì´ë¸”ì— ì—°ê²°í•©ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table_association&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>      <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">public</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span> <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## NAT ê²Œì´íŠ¸ì›¨ì´ëŠ” ê³ ì • IPë¥¼ í•„ìš”ë¡œ í•©ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_eip&#34; &#34;nat_gateway&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc</span>  <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-natgw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## í”„ë¼ì´ë¹— ì„œë¸Œë„·ì—ì„œ ì¸í„°ë„· ì ‘ì†ì‹œ ì‚¬ìš©í•  NAT ê²Œì´íŠ¸ì›¨ì´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_nat_gateway&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  allocation_id</span> <span class="o">=</span> <span class="k">aws_eip</span><span class="p">.</span><span class="k">nat_gateway</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>     <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">public</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="k">id</span><span class="c1"> # NAT ê²Œì´íŠ¸ì›¨ì´ ìì²´ëŠ” í¼í”Œë¦­ ì„œë¸Œë„·ì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  tags</span>          <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-natgw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## í”„ë¼ì´ë¹— ì„œë¸Œë„·ì— ì ìš©í•  ë¼ìš°íŒ… í…Œì´ë¸”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-private&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## í”„ë¼ì´ë¹— ì„œë¸Œë„·ì—ì„œ ì¸í„°ë„·ì— íŠ¸ë˜í”½ ìš”ì²­ì‹œ ì•ì„œ ì •ì˜í•œ NAT ê²Œì´íŠ¸ì›¨ì´ë¡œ ë³´ëƒ…ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route&#34; &#34;private_worldwide&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span>         <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">private</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  destination_cidr_block</span> <span class="o">=</span> <span class="s2">&#34;0.0.0.0/0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  nat_gateway_id</span>         <span class="o">=</span> <span class="k">aws_nat_gateway</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## í”„ë¼ì´ë¹— ì„œë¸Œë„·ì„ ì •ì˜í•©ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_subnet&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">)</span><span class="c1"> # ì—¬ëŸ¬ê°œë¥¼ ì •ì˜í•©ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>            <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span>        <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  availability_zone</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">azs</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-private-${count.index + 1}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span><span class="p">,</span><span class="c1"> # ë‹¤ë¥¸ ë¶€ë¶„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">    &#34;kubernetes.io/role/internal-elb&#34;</span>             <span class="o">=</span> <span class="s2">&#34;1&#34;</span><span class="c1"> # ë‹¤ë¥¸ ë¶€ë¶„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## í”„ë¼ì´ë¹— ì„œë¸Œë„·ì„ ë¼ìš°íŒ… í…Œì´ë¸”ì— ì—°ê²°í•©ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table_association&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>      <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span> <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">private</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="eks-í´ëŸ¬ìŠ¤í„°-ìƒì„±">EKS í´ëŸ¬ìŠ¤í„° ìƒì„±</h2>
<p>ECSê°€ í•˜ë‚˜ì˜ ë¦¬ì†ŒìŠ¤ë¡œ ëë‚œ ê²ƒì— ë¹„í•´ EKSëŠ” ì¡°ê¸ˆ ë³µì¡í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1">## í´ëŸ¬ìŠ¤í„°ê°€ ì‚¬ìš©í•  ì—­í• ì„ ì •ì˜í•©ë‹ˆë‹¤.
</span></span></span><span class="line"><span class="cl"><span class="c1">## AmazonEKSClusterPolicyì™€ AmazonEKSVPCResourceControllerë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_iam_role&#34; &#34;cluster&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;${local.cluster_name}-eks-cluster-role&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  assume_role_policy</span> <span class="o">=</span> <span class="k">jsonencode</span><span class="p">(</span>{
</span></span><span class="line"><span class="cl"><span class="n">    Version</span> <span class="o">=</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    Statement</span> <span class="o">=</span> <span class="p">[</span>{
</span></span><span class="line"><span class="cl"><span class="n">      Effect</span> <span class="o">=</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Principal</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">        Service</span> <span class="o">=</span> <span class="s2">&#34;eks.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">      }<span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Action</span> <span class="o">=</span> <span class="s2">&#34;sts:AssumeRole&#34;</span>
</span></span><span class="line"><span class="cl">    }<span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy_attachment&#34; &#34;cluster_AmazonEKSClusterPolicy&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  policy_arn</span> <span class="o">=</span> <span class="s2">&#34;arn:aws:iam::aws:policy/AmazonEKSClusterPolicy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy_attachment&#34; &#34;cluster_AmazonEKSVPCResourceController&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  policy_arn</span> <span class="o">=</span> <span class="s2">&#34;arn:aws:iam::aws:policy/AmazonEKSVPCResourceController&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## EKS í´ëŸ¬ìŠ¤í„°ë¥¼ ì •ì˜í•©ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_eks_cluster&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span>     <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cluster_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  role_arn</span> <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl">  <span class="k">vpc_config</span> {
</span></span><span class="line"><span class="cl"><span class="n">    subnet_ids</span> <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl"><span class="n">  depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="c1"> # see https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/eks_cluster#example-usage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">aws_iam_role_policy_attachment</span><span class="p">.</span><span class="k">cluster_AmazonEKSClusterPolicy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">aws_iam_role_policy_attachment</span><span class="p">.</span><span class="k">cluster_AmazonEKSVPCResourceController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## Fargateì—ì„œ íŒŸ ë°°ì¹˜ì‹œ ì‚¬ìš©í•˜ëŠ” ì‹¤í–‰ ì—­í• ì„ ì •ì˜í•©ë‹ˆë‹¤.
</span></span></span><span class="line"><span class="cl"><span class="c1">## AmazonEKSFargatePodExecutionRolePolicyë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_iam_role&#34; &#34;pod_execution&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;${local.cluster_name}-eks-pod-execution-role&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  assume_role_policy</span> <span class="o">=</span> <span class="k">jsonencode</span><span class="p">(</span>{
</span></span><span class="line"><span class="cl"><span class="n">    Version</span> <span class="o">=</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    Statement</span> <span class="o">=</span> <span class="p">[</span>{
</span></span><span class="line"><span class="cl"><span class="n">      Effect</span> <span class="o">=</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Principal</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">        Service</span> <span class="o">=</span> <span class="s2">&#34;eks-fargate-pods.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">      }<span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Action</span> <span class="o">=</span> <span class="s2">&#34;sts:AssumeRole&#34;</span>
</span></span><span class="line"><span class="cl">    }<span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy_attachment&#34; &#34;pod_execution_AmazonEKSFargatePodExecutionRolePolicy&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  policy_arn</span> <span class="o">=</span> <span class="s2">&#34;arn:aws:iam::aws:policy/AmazonEKSFargatePodExecutionRolePolicy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">pod_execution</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## EKS í´ëŸ¬ìŠ¤í„°ì— ë…¸ë“œë¥¼ Fargateë¡œ ê³µê¸‰í•©ë‹ˆë‹¤.
</span></span></span><span class="line"><span class="cl"><span class="c1">## default/kube-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê°€ì§„ íŒŸì— ëŒ€í•´ ì ìš©ë©ë‹ˆë‹¤.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_eks_fargate_profile&#34; &#34;default&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span>           <span class="o">=</span> <span class="k">aws_eks_cluster</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl"><span class="n">  fargate_profile_name</span>   <span class="o">=</span> <span class="s2">&#34;fp-default&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  pod_execution_role_arn</span> <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">pod_execution</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnet_ids</span>             <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="k">id</span><span class="c1"> # í”„ë¼ì´ë¹— ì„œë¸Œë„·ë§Œ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">selector</span> {
</span></span><span class="line"><span class="cl"><span class="n">    namespace</span> <span class="o">=</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  <span class="k">selector</span> {
</span></span><span class="line"><span class="cl"><span class="n">    namespace</span> <span class="o">=</span> <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-kubeconfig.html">kubeconfigë¥¼ ìƒì„±</a>í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ aws eks update-kubeconfig --region ap-northeast-2 --name simon-test --alias simon-test
</span></span></code></pre></div><p>ì´ì œ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì˜ ìƒíƒœë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get svc
</span></span><span class="line"><span class="cl">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
</span></span><span class="line"><span class="cl">kubernetes   ClusterIP   172.20.0.1   &lt;none&gt;        443/TCP   23m
</span></span></code></pre></div><p>ê·¸ëŸ°ë° íŒŸ ëª©ë¡ì„ ë³´ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ì•¼ í•  coredns íŒŸì´ ëœ¨ì§€ ì•ŠëŠ” ê²ƒì´ ë³´ì…ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get pods -n kube-system
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">coredns-6dbb778559-clx8r   0/1     Pending   <span class="m">0</span>          13m
</span></span><span class="line"><span class="cl">coredns-6dbb778559-zpx2h   0/1     Pending   <span class="m">0</span>          13m
</span></span></code></pre></div><p>Fargate ë…¸ë“œë§Œ ì‚¬ìš©í•˜ë ¤ë©´ <a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-getting-started.html#fargate-gs-coredns">CoreDNS ë‚´ìš©ì„ ìˆ˜ì • í•´ì¤˜ì•¼</a> í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl patch deployment coredns <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -n kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --type json <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -p<span class="o">=</span><span class="s1">&#39;[{&#34;op&#34;: &#34;remove&#34;, &#34;path&#34;: &#34;/spec/template/metadata/annotations/eks.amazonaws.com~1compute-type&#34;}]&#39;</span>
</span></span><span class="line"><span class="cl">deployment.apps/coredns patched
</span></span><span class="line"><span class="cl">$ kubectl get pods -n kube-system                          
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">coredns-6f99dbb876-hp667   1/1     Running   <span class="m">0</span>          4m
</span></span><span class="line"><span class="cl">coredns-6f99dbb876-skrgn   1/1     Running   <span class="m">0</span>          4m
</span></span></code></pre></div><p>ì»¨í…Œì´ë„ˆì— IAM ê¶Œí•œì„ ë¶€ì—¬í•˜ë ¤ë©´ <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html">OIDC ê³µê¸‰ì ìƒì„±</a>ì´ í•„ìš”í•©ë‹ˆë‹¤</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ eksctl utils associate-iam-oidc-provider --cluster simon-test --approve
</span></span></code></pre></div><h2 id="ì„œë¹„ìŠ¤-êµ¬ë™">ì„œë¹„ìŠ¤ êµ¬ë™</h2>
<p>ì´ì œ ìš°ë¦¬ê°€ ë§Œë“  ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ EKS í´ëŸ¬ìŠ¤í„°ì— ì˜¬ë¦´ ì°¨ë¡€ì…ë‹ˆë‹¤.</p>
<p>ì´ì „ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ECR ì €ì¥ì†Œë¥¼ ë§Œë“¤ê³  ì´ë¯¸ì§€ë¥¼ ì˜¬ë ¤ë‘¡ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  app_name</span> <span class="o">=</span> <span class="s2">&#34;simon-sample&#34;</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## simon-sample ì•±ì„ ìœ„í•œ ì €ì¥ì†Œë¥¼ ë§Œë“­ë‹ˆë‹¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_ecr_repository&#34; &#34;simon_sample&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">app_name</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>ì´ ì´ë¯¸ì§€ë¥¼ ë„ìš°ëŠ” ê²ƒì€ ì¿ ë²„ë„¤í‹°ìŠ¤ê°€ ì²˜ë¦¬í•©ë‹ˆë‹¤.</p>
<p>ì¿ ë²„ë„¤í‹°ìŠ¤ì— ë„ìš°ëŠ” ê°€ì¥ ì‘ì€ ë‹¨ìœ„ëŠ” <a href="https://kubernetes.io/ko/docs/concepts/workloads/pods/">íŒŒë“œ</a>ì…ë‹ˆë‹¤. ë‹¤ë§Œ íŒŒë“œë¡œ ë„ìš°ë©´ ì„œë²„ë¥¼ í™•ì¥í•˜ëŠ” ê²ƒì´ ì–´ë µìŠµë‹ˆë‹¤. <a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/replicaset/">ë ˆí”Œë¦¬ì¹´ì…‹</a>ì´ë¼ëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•˜ë©´ íŒŒë“œë¥¼ ì—¬ëŸ¬ê°œ ë„ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì— ë”í•´ <a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/">ë””í”Œë¡œì´ë¨¼íŠ¸</a>ë¥¼ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•˜ë©´ ì–´í”Œë¦¬ì¼€ì´ì…˜ ê°±ì‹ ì‹œ ë ˆí”Œë¦¬ì¹´ì…‹ êµì²´ë¥¼ í•´ì¤ë‹ˆë‹¤.</p>
<p>ë‹¤ìŒê³¼ ê°™ì´ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;aws-account-id&gt;.dkr.ecr.ap-northeast-2.amazonaws.com/simon-sample:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span></code></pre></div><p>ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ì ìš©í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl apply -f simon-sample.yaml
</span></span><span class="line"><span class="cl">deployment.apps/simon-sample created
</span></span></code></pre></div><p>ë³´í†µ 5ë¶„ ì•ˆì—(ë¹ ë¥´ë©´ 1ë¶„ ì•ˆì—) ë‹¤ìŒê³¼ ê°™ì´ Running ìƒíƒœë¡œ ë°”ë€ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get pods -o wide                 
</span></span><span class="line"><span class="cl">NAME                           READY   STATUS    RESTARTS   AGE     IP              NODE                    NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">simon-sample-dd88b97bc-svtd6   1/1     Running   <span class="m">0</span>          3m45s   10.194.101.15   fargate-10.194.101.15   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>í¬íŠ¸ í¬ì›Œë”©ìœ¼ë¡œ ì„¸íŒ…í•˜ê³ , HTTP ìš”ì²­ì„ í•˜ë©´ ì‘ë‹µì´ ì˜¤ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl port-forward simon-sample-dd88b97bc-svtd6 3000:3000
</span></span><span class="line"><span class="cl">Forwarding from 127.0.0.1:3000 -&gt; <span class="m">3000</span>
</span></span><span class="line"><span class="cl">Handling connection <span class="k">for</span> <span class="m">3000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## from other terminal</span>
</span></span><span class="line"><span class="cl">$ curl localhost:3000 --data <span class="s1">&#39;hello world&#39;</span>
</span></span><span class="line"><span class="cl">hello world
</span></span></code></pre></div><h2 id="ì„œë¹„ìŠ¤ë¥¼-ì™¸ë¶€ì—-ë…¸ì¶œí•˜ê¸°">ì„œë¹„ìŠ¤ë¥¼ ì™¸ë¶€ì— ë…¸ì¶œí•˜ê¸°</h2>
<p>ECSì™€ ë§ˆì°¬ê°€ì§€ë¡œ ì‹¤ì œ ì„œë¹„ìŠ¤ê°€ ë˜ë ¤ë©´ ì™¸ë¶€ì— ë…¸ì¶œëœ ë¡œë“œ ë°¸ëŸ°ì„œì— ìš°ë¦¬ì˜ ì„œë¹„ìŠ¤ë¥¼ ë¶™ì—¬ì¤˜ì•¼ í•©ë‹ˆë‹¤. ECSì™€ ë‹¬ë¦¬ ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œëŠ” ë¡œë“œ ë°¸ëŸ°ì„œ ì •ì˜ë„ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ë¡œ ì •ì˜í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” EKSê°€ ì•Œì•„ì„œ AWS ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ ìƒì„±í•˜ê²Œ ë©ë‹ˆë‹¤.</p>
<p>ì–´í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ(L7)ì—ì„œ ë™ì‘í•˜ëŠ” Application Load Balancer(ALB)ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ ë¦¬ì†ŒìŠ¤ íƒ€ì…ì€ <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a> ì…ë‹ˆë‹¤.</p>
<p>ìš°ì„  <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/aws-load-balancer-controller.html">AWS Load Balancer Controller ì¶”ê°€ ê¸°ëŠ¥ ì„¤ì¹˜</a>ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## ALBë¥¼ ì»¨íŠ¸ë¡¤ í•  ìˆ˜ ìˆëŠ” ì •ì±…ì„ ìƒì„±í•©ë‹ˆë‹¤.</span>
</span></span><span class="line"><span class="cl">$ curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.0/docs/install/iam_policy.json
</span></span><span class="line"><span class="cl">$ aws iam create-policy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --policy-name AWSLoadBalancerControllerIAMPolicy-simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --policy-document file://iam_policy.json
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## ìœ„ ì •ì±…ì„ í¬í•¨í•œ IAM ì—­í• ì„ ìƒì„±í•©ë‹ˆë‹¤.</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">ACCOUNT_ID</span><span class="o">=</span><span class="k">$(</span>aws sts get-caller-identity <span class="p">|</span> jq -r .Account<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">OIDC_URL</span><span class="o">=</span><span class="k">$(</span>aws eks describe-cluster --name simon-test --query <span class="s2">&#34;cluster.identity.oidc.issuer&#34;</span> --output text <span class="p">|</span> sed <span class="s2">&#34;s|https://||&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">$ cat &gt; load-balancer-role-trust-policy.json <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">{
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;Statement&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="s">        {
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Principal&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">                &#34;Federated&#34;: &#34;arn:aws:iam::${ACCOUNT_ID}:oidc-provider/$OIDC_URL&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">            },
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Action&#34;: &#34;sts:AssumeRoleWithWebIdentity&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Condition&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">                &#34;StringEquals&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">                    &#34;${OIDC_URL}:aud&#34;: &#34;sts.amazonaws.com&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">                    &#34;${OIDC_URL}:sub&#34;: &#34;system:serviceaccount:kube-system:aws-load-balancer-controller&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                }
</span></span></span><span class="line"><span class="cl"><span class="s">            }
</span></span></span><span class="line"><span class="cl"><span class="s">        }
</span></span></span><span class="line"><span class="cl"><span class="s">    ]
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">$ aws iam create-role <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --role-name AmazonEKSLoadBalancerControllerRole-simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --assume-role-policy-document file://<span class="s2">&#34;load-balancer-role-trust-policy.json&#34;</span>
</span></span><span class="line"><span class="cl">$ aws iam attach-role-policy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --policy-arn arn:aws:iam::<span class="si">${</span><span class="nv">ACCOUNT_ID</span><span class="si">}</span>:policy/AWSLoadBalancerControllerIAMPolicy-simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --role-name AmazonEKSLoadBalancerControllerRole-simon-test
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## IAM ì—­í• ì— ì—°ê²°ëœ ì¿ ë² ë„¤í‹°ìŠ¤ ì„œë¹„ìŠ¤ ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤.</span>
</span></span><span class="line"><span class="cl">$ cat &gt; aws-load-balancer-controller-service-account.yaml <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ServiceAccount
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app.kubernetes.io/component: controller
</span></span></span><span class="line"><span class="cl"><span class="s">    app.kubernetes.io/name: aws-load-balancer-controller
</span></span></span><span class="line"><span class="cl"><span class="s">  name: aws-load-balancer-controller
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: kube-system
</span></span></span><span class="line"><span class="cl"><span class="s">  annotations:
</span></span></span><span class="line"><span class="cl"><span class="s">    eks.amazonaws.com/role-arn: arn:aws:iam::${ACCOUNT_ID}:role/AmazonEKSLoadBalancerControllerRole-simon-test
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">$ kubectl apply -f aws-load-balancer-controller-service-account.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## AWS Load Balancer Controllerë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">VPC_ID</span><span class="o">=</span><span class="k">$(</span>aws ec2 describe-vpcs --filters <span class="nv">Name</span><span class="o">=</span>cidr,Values<span class="o">=</span>10.194.0.0/16 <span class="p">|</span> jq -r .Vpcs<span class="o">[</span>0<span class="o">]</span>.VpcId<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ helm repo add eks https://aws.github.io/eks-charts
</span></span><span class="line"><span class="cl">$ helm repo update
</span></span><span class="line"><span class="cl">$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -n kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">clusterName</span><span class="o">=</span>simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set serviceAccount.create<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set serviceAccount.name<span class="o">=</span>aws-load-balancer-controller <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">region</span><span class="o">=</span>ap-northeast-2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">vpcId</span><span class="o">=</span><span class="nv">$VPC_ID</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set image.repository<span class="o">=</span>602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon/aws-load-balancer-controller
</span></span><span class="line"><span class="cl">NAME: aws-load-balancer-controller
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Sat Mar <span class="m">26</span> 10:02:19 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: kube-system
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">AWS Load Balancer controller installed!
</span></span><span class="line"><span class="cl">$ kubectl get deployment -n kube-system aws-load-balancer-controller
</span></span><span class="line"><span class="cl">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">aws-load-balancer-controller   2/2     <span class="m">2</span>            <span class="m">2</span>           5m51s
</span></span></code></pre></div><p>ì´ì œ ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ í†µí•´ ALBë¥¼ ìƒì„±í•˜ê³ , ì•„ê¹Œ ë§Œë“  ì•±ì„ ë“±ë¡í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-test-alb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/scheme</span><span class="p">:</span><span class="w"> </span><span class="l">internet-facing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/target-type</span><span class="p">:</span><span class="w"> </span><span class="l">ip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">alb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span></code></pre></div><p>ì´ì œ ë¡œë“œ ë°¸ëŸ°ì„œ ì£¼ì†Œë¡œ ìš”ì²­ì„ ë³´ë‚´ë©´ ì‘ë‹µì„ ë³´ë‚´ì˜µë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## k8s-default-simontes-ea5ab2759b-771587743.ap-northeast-2.elb.amazonaws.com ê°™ì€ ì£¼ì†Œë¥¼ ê°€ì§‘ë‹ˆë‹¤</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">LB_HOST</span><span class="o">=</span><span class="k">$(</span>kubectl get ingress/simon-test-alb -ojson <span class="p">|</span> jq -r .status.loadBalancer.ingress<span class="o">[</span>0<span class="o">]</span>.hostname<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ curl <span class="nv">$LB_HOST</span> --data <span class="s1">&#39;hello world&#39;</span>
</span></span><span class="line"><span class="cl">hello world
</span></span></code></pre></div><h2 id="í›„ê¸°">í›„ê¸°</h2>
<p>í™•ì‹¤íˆ EKSëŠ” ECSì— ë¹„í•´ í›¨ì”¬ ë³µì¡í•©ë‹ˆë‹¤. ê·¸ë§Œí¼ ì„¸ì„¸í•œ ì»¨íŠ¸ë¡¤ì´ ê°€ëŠ¥í•˜ê³ , AWSì— íŠ¹í™”ëœ ê°œë…ì´ ì•„ë‹ˆë¼ëŠ” ê²ƒì€ ì¥ì ì´ë¼ê³  ë´…ë‹ˆë‹¤.</p>
<p>ì´ë²ˆ ê¸€ì—ì„œëŠ” ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ëŠ” ë¶€ë¶„ì´ ê½¤ ìˆëŠ”ë° ë‹¤ìŒì—ëŠ” ë” ìë™í™”(Terraform) í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>
<h2 id="appendix">Appendix</h2>
<ul>
<li>ì˜ˆì œ íŒŒì¼: <a href="/file/ko/tech/2022-03-31-2-simon-sample.zip">simon-sample.zip</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html">Amazon EKSì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë“œ ë°¸ëŸ°ì‹±</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-cluster.html">Amazon EKS í´ëŸ¬ìŠ¤í„° ìƒì„±</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/fargate-getting-started.html">Amazon EKSë¥¼ ì‚¬ìš©í•˜ì—¬ AWS Fargate ì‹œì‘í•˜ê¸°</a>
<ul>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/fargate-getting-started.html#fargate-gs-coredns">CoreDNS ì—…ë°ì´íŠ¸</a></li>
</ul>
</li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-kubeconfig.html">Amazon EKSìš© kubeconfig ìƒì„±</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html">í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ IAM OIDC ê³µê¸‰ì ìƒì„±</a></li>
<li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/">AWS Load Balancer Controller</a>
<ul>
<li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/ingress/annotations/">Ingress annotations</a></li>
</ul>
</li>
<li><a href="https://kubernetes.io/ko/docs/home/">ì¿ ë²„ë„¤í‹°ìŠ¤</a>
<ul>
<li><a href="https://kubernetes.io/ko/docs/concepts/workloads/pods/">íŒŒë“œ</a></li>
<li><a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/replicaset/">ë ˆí”Œë¦¬ì¹´ì…‹</a></li>
<li><a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/">ë””í”Œë¡œì´ë¨¼íŠ¸</a></li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      
    </div>

    
<div class='col-xs-12 text-center'>
  
  <ul class='pagination'>
    
    <li class='disabled'><span>&laquo; ì²˜ìŒ</span></li>
    <li class='disabled'><span>&lt; ì´ì „</span></li>
    

    

    
    
    
    
    <li class='active'><span>1</span></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/2/'>2</a></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/3/'>3</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    <li class='disabled'><span>&hellip;</span></li>
    

    
    <li><a href='/ko/tech/page/2/'>ë‹¤ìŒ &gt;</a></li>
    <li><a href='/ko/tech/page/14/'>ë &raquo;</a></li>
    
  </ul>
  
</div>

  </div>

</div>

<div class='container-fluid'>
  <hr>
  <footer>
    <p>
      &copy; 2014-2021 Sangmin Yoon
      <span class='pull-right text-muted'>
        powered by
        <a href='https://gohugo.io/' target='_blank'>Hugo</a>
        ,
        <a href='http://getbootstrap.com/' target='_blank'>Bootstrap</a>
        ,
        <a href='http://www.dnsever.com' target='dnsever'><img src='http://banner.dnsever.com/dnsever-banner_62x15.gif'
            border='0' alt='DNS server, DNS service '></a>
      </span>
    </p>
  </footer>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-48366784-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script src='https://code.jquery.com/jquery-1.12.4.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>

</body>

</html>
